<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medicine Tracker</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ’Š</text></svg>">
    <style>
        /* Global styles */
        * {
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: #333;
        }

        .controls {
            margin: 20px 0;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        button {
            padding: 10px 20px;
            margin: 5px 0;
            cursor: pointer;
            font-size: 14px;
            border: none;
            border-radius: 4px;
        }

        .add {
            background: #4CAF50;
            color: white;
        }

        .export {
            background: #2196F3;
            color: white;
        }

        .clear {
            background: #f44336;
            color: white;
        }

        /* Desktop Table Styles */
        #medsTable {
            width: 100%;
            border-collapse: collapse;
            background: white;
            margin-top: 20px;
        }

        th,
        td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: left;
            vertical-align: top;
        }

        th {
            background: #f0f0f0;
            font-weight: bold;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 5px;
            box-sizing: border-box;
            min-height: 30px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }

        textarea {
            min-height: 60px;
            resize: vertical;
        }

        .del {
            background: #f44336;
            color: white;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 3px;
        }

        .duplicate {
            background: #9C27B0;
            color: white;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 3px;
        }

        /* Status Colors */
        .taken-row {
            background-color: #e8f5e9;
            opacity: 0.9;
        }

        .missed-row {
            background-color: #ffebee;
            opacity: 0.9;
            border-left: 4px solid #f44336;
        }

        .schedule-header {
            background: #e0f2f1;
            font-weight: bold;
        }

        /* --- MOBILE GROUP LIST STYLES (New) --- */
        #mobileGroupList {
            display: none; /* Hidden on Desktop */
            margin-top: 20px;
        }

        .mobile-group-header {
            background: #e0f2f1;
            padding: 12px;
            margin: 15px 0 5px 0;
            font-weight: bold;
            text-align: center;
            border-radius: 4px;
            color: #333;
            font-size: 1.1em;
        }

        /* Individual Mobile Card */
        .mobile-card {
            display: block;
            margin-bottom: 10px; 
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            overflow: hidden; 
            transition: background-color 0.3s;
        }

        .mobile-card.taken-row {
            background-color: #e8f5e9;
        }

        .mobile-card.missed-row {
            background-color: #ffebee;
            border-left: 4px solid #f44336;
        }

        .med-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f9f9f9;
            border-bottom: 1px solid #eee;
            cursor: pointer; /* Crucial for indicating clickability */
        }

        .med-header h4 {
            font-size: 1.1em; 
            font-weight: bold;
            margin: 0;
            flex-grow: 1;
        }
        
        .med-details {
            display: none; /* Hidden by default */
            padding: 0 15px 15px 15px;
        }
        
        .mobile-card.active .med-details {
            display: block; /* Shown when 'active' class is present */
        }
        
        /* Layout for details fields */
        .med-details > div {
            display: flex; 
            padding: 8px 0;
        }
        
        .med-details > div::before {
            content: attr(data-label);
            font-weight: bold;
            width: 30%; 
            min-width: 100px;
            padding-right: 10px;
            white-space: nowrap;
            color: #555;
        }
        
        .med-details > div > * {
            flex-grow: 1;
            width: auto !important; 
        }
        
        /* Custom Input within select */
        .custom-input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            width: 100%;
        }

        /* Status Indicators (Same as before) */
        .status-indicator {
            font-size: 0.9em;
            padding: 3px 8px;
            border-radius: 4px;
            color: white;
            margin-left: 10px;
        }
        .status-indicator.pending { background-color: #9e9e9e; }
        .status-indicator.taken { background-color: #4CAF50; }
        .status-indicator.missed { background-color: #f44336; }
        
        .signup-fields {
            display: none;
        }

        #authContainer.signup-mode .signup-fields {
            display: block;
        }

        /* --- MEDIA QUERY (Mobile View) --- */
        @media (max-width: 768px) {
            /* Hide the entire desktop table */
            #medsTable {
                display: none;
            }
            
            /* Show the dedicated mobile list */
            #mobileGroupList {
                display: block; 
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .control-group {
                flex-direction: row;
                justify-content: space-between;
                width: 100%;
                padding: 5px 0;
            }
        }
    </style>
</head>
<body>
    <div id="authContainer" style="display:none; max-width:400px; margin:50px auto; padding:30px; background:#f9f9f9; border-radius:10px;">
        <h2>ðŸ”’ Medicine Tracker Access</h2>
        <div style="margin:20px 0;">
            <div class="signup-fields">
                <input type="text" id="name" placeholder="Your Name" style="width:100%; padding:10px; margin:5px 0; box-sizing:border-box;">
            </div>
            <input type="email" id="email" placeholder="Email" style="width:100%; padding:10px; margin:5px 0; box-sizing:border-box;">
            <input type="password" id="password" placeholder="Password (min 6 chars)" style="width:100%; padding:10px; margin:5px 0; box-sizing:border-box;">
            <div class="signup-fields">
                <input type="password" id="confirmPassword" placeholder="Confirm Password" style="width:100%; padding:10px; margin:5px 0; box-sizing:border-box;">
            </div>
        </div>
        <button class="add" onclick="login()" style="width:48%; margin:2%;" id="loginBtn">Login</button>
        <button class="export" onclick="toggleSignupMode()" style="width:48%; margin:2%;" id="signupToggleBtn">Sign Up</button>
        <div id="authError" style="color:red; margin-top:10px;"></div>
    </div>

    <div id="appContainer" style="display:none;">
        <div style="text-align:right; margin-bottom:10px;">
            <span id="userEmail" style="margin-right:10px; font-weight:bold;"></span>
            <button class="clear" onclick="logout()" style="padding:5px 15px;">Logout</button>
        </div>
        <h1>ðŸ’Š Medicine Tracker</h1>
        <div class="controls">
            <input type="text" id="searchBar" placeholder="Search by name or notes..." style="flex-grow: 1; max-width: 300px;">

            <div class="control-group">
                <label for="filterStatus">Filter:</label>
                <select id="filterStatus">
                    <option value="all">Show All</option>
                    <option value="pending">Pending Only</option>
                    <option value="taken">Taken Only</option>
                    <option value="missed">Missed Only</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="date">Date:</label>
                <input type="date" id="date">
            </div>
            
            <button class="add" id="addBtn">Add Medicine</button>
            <button class="export" id="exportBtn">Export CSV</button>
            <button class="clear" id="clearBtn">Clear Today</button>
        </div>
    
        <div id="summary" style="background:#f9f9f9; padding:10px; margin:10px 0;"></div>
        
        <div id="mobileGroupList"></div>
        
        <table id="medsTable">
            <thead>
                <tr>
                    <th>Medicine</th>
                    <th>Usage</th>
                    <th>Dosage</th>
                    <th>Unit</th>
                    <th>Time</th>
                    <th>When</th>
                    <th>Taken</th>
                    <th>Notes</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="list"></tbody>
        </table>
    </div>

    <script type="module">
        // Make functions global for inline onclick handlers
        window.login = login;
        window.signup = signup;
        window.logout = logout;
        window.toggleSignupMode = toggleSignupMode; 
        window.toggleLoginMode = toggleLoginMode;
        // Expose handleUpdate and handleStatusChange for dynamic elements
        window.handleUpdate = handleUpdate;
        window.handleStatusChange = handleStatusChange;

        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.21.0/firebase-app.js';
        import { getDatabase, ref, set, onValue, push, update, remove } from 'https://www.gstatic.com/firebasejs/9.21.0/firebase-database.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.21.0/firebase-auth.js';

        // Firebase configuration (REPLACE with your actual config)
        const firebaseConfig = {
            apiKey: "AIzaSyDYSBWvsWcfU4gfl2ECCJiKKxUgMjuvmF4",
            authDomain: "medicine-tracker-b90f2.firebaseapp.com",
            databaseURL: "https://medicine-tracker-b90f2-default-rtdb.firebaseio.com",
            projectId: "medicine-tracker-b90f2",
            storageBucket: "medicine-tracker-b90f2.firebasestorage.app",
            messagingSenderId: "230127910329",
            appId: "1:230127910329:web:114eea8f3846c446948a68"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        let currentUser = null;
        if (!window.meds) window.meds = [];
        let meds = window.meds;
        let date = new Date().toISOString().split('T')[0];
        let currentFilter = 'all'; 
        let searchQuery = ''; // New variable for search

        document.getElementById('date').value = date;

        // --- Authentication & Setup Functions ---
        function toggleSignupMode() {
            const container = document.getElementById('authContainer');
            const toggleBtn = document.getElementById('signupToggleBtn');
            const loginBtn = document.getElementById('loginBtn');
            const isSignupMode = container.classList.contains('signup-mode');

            if (isSignupMode) {
                container.classList.remove('signup-mode');
                toggleBtn.textContent = 'Sign Up';
                toggleBtn.onclick = toggleSignupMode;
                loginBtn.onclick = login;
            } else {
                container.classList.add('signup-mode');
                toggleBtn.textContent = 'Register';
                toggleBtn.onclick = signup;
                loginBtn.onclick = toggleLoginMode;
            }
            document.getElementById('authError').textContent = '';
        }

        function toggleLoginMode() {
            document.getElementById('authContainer').classList.remove('signup-mode');
            document.getElementById('signupToggleBtn').textContent = 'Sign Up';
            document.getElementById('signupToggleBtn').onclick = toggleSignupMode;
            document.getElementById('loginBtn').onclick = login;
            document.getElementById('authError').textContent = '';
        }
        
        function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorEl = document.getElementById('authError');
            if (!email || !password) { errorEl.textContent = 'Please enter email and password'; return; }

            signInWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    currentUser = userCredential.user;
                    errorEl.textContent = '';
                    showApp();
                })
                .catch((error) => {
                    errorEl.textContent = 'Login failed: ' + error.message;
                });
        }

        function signup() {
            const name = document.getElementById('name').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const errorEl = document.getElementById('authError');

            if (!name || !email || !password || !confirmPassword) {
                errorEl.textContent = 'Please fill out all fields.';
                return;
            }
            if (password.length < 6) {
                errorEl.textContent = 'Password must be at least 6 characters.';
                return;
            }
            if (password !== confirmPassword) {
                errorEl.textContent = 'Passwords do not match.';
                return;
            }

            createUserWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    currentUser = userCredential.user;
                    errorEl.textContent = '';
                    
                    const userRef = ref(db, 'users/' + currentUser.uid + '/profile');
                    set(userRef, { name: name, email: email })
                    .then(() => {
                        console.log("User profile saved to database.");
                        alert(`Welcome, ${name}! Account created successfully.`);
                        showApp();
                    })
                    .catch((dbError) => {
                           console.error("Failed to save user profile:", dbError);
                           showApp();
                    });
                })
                .catch((error) => {
                    errorEl.textContent = 'Signup failed: ' + error.message;
                });
        }

        function logout() {
            if (confirm('Logout?')) {
                signOut(auth).then(() => {
                    currentUser = null;
                    showLogin();
                });
            }
        }

        function showLogin() {
            document.getElementById('authContainer').style.display = 'block';
            document.getElementById('appContainer').style.display = 'none';
            document.getElementById('authContainer').classList.remove('signup-mode');
            document.getElementById('signupToggleBtn').textContent = 'Sign Up';
            document.getElementById('signupToggleBtn').onclick = toggleSignupMode;
            document.getElementById('loginBtn').onclick = login;
        }

        function showApp() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            
            const profileRef = ref(db, 'users/' + currentUser.uid + '/profile/name');
            onValue(profileRef, (snapshot) => {
                const userName = snapshot.val();
                document.getElementById('userEmail').textContent = userName || currentUser.email;
            }, { onlyOnce: true });

            load(); 
        }

        let syncListener = null;
        function setupRealtimeSync() {
            if (!currentUser) return;
            if (syncListener) syncListener(); 

            const medsRef = ref(db, 'users/' + currentUser.uid + '/medicines');
            const statusEl = document.getElementById('status') || createStatusElement();
            statusEl.textContent = 'ðŸ”„ Syncing with Firebase...';
            statusEl.style.color = 'blue';

            syncListener = onValue(medsRef, (snapshot) => {
                const data = snapshot.val(); 
                const newMedsArray = [];

                if (data) {
                    for (const key in data) {
                        newMedsArray.push({ id: key, ...data[key] });
                    }
                }

                if (JSON.stringify(newMedsArray) !== JSON.stringify(meds)) {
                    window.meds = newMedsArray;
                    meds = window.meds;
                    render(); 

                    statusEl.textContent = `âœ… Synced ${meds.length} medicines`;
                    statusEl.style.color = 'green';
                    setTimeout(() => statusEl.textContent = '', 2000);
                } else {
                    statusEl.textContent = 'âœ… Synced';
                    statusEl.style.color = 'green';
                    setTimeout(() => statusEl.textContent = '', 2000);
                }
            }, (error) => {
                console.error('Real-time sync error:', error);
                statusEl.textContent = 'âŒ Sync failed. Check connection.';
                statusEl.style.color = 'red';
            });
        }
        
        function disableRealtimeSync() {
             if (syncListener) syncListener(); 
             syncListener = null;
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                showApp();
            } else {
                currentUser = null;
                disableRealtimeSync();
                showLogin();
            }
        });

        function createStatusElement() {
            const statusEl = document.createElement('div');
            statusEl.id = 'status';
            statusEl.style.cssText = 'font-weight:bold; margin:10px 0; padding:5px;';
            document.querySelector('.controls').appendChild(statusEl);
            return statusEl;
        }

        function load() {
            if (!currentUser) { return; }
            setupRealtimeSync();
            attachControlListeners(); // Attach listeners here
        }
        
        function attachControlListeners() {
            document.getElementById('addBtn').onclick = addMedicine;
            document.getElementById('date').onchange = (e) => {
                date = e.target.value;
                render();
            };
            document.getElementById('filterStatus').onchange = (e) => {
                currentFilter = e.target.value;
                render();
            };
            document.getElementById('searchBar').oninput = (e) => {
                searchQuery = e.target.value.toLowerCase();
                render();
            };
            document.getElementById('clearBtn').onclick = clearToday;
            document.getElementById('exportBtn').onclick = exportCSV;
        }
        
        function addMedicine() {
            if (!currentUser) return;
            const medsRef = ref(db, 'users/' + currentUser.uid + '/medicines');
            push(medsRef, {
                name: 'New Medicine',
                usage: 'As needed',
                dosage: 1,
                unit: 'tablets',
                time: '',
                when: 'After Breakfast',
                notes: ''
            });
        }
        
        function clearToday() {
            if (!currentUser) return;
            if (confirm(`Are you sure you want to clear the 'taken' status for all medicines on ${date}?`)) {
                meds.forEach(m => {
                    const takenDateRef = ref(db, `users/${currentUser.uid}/medicines/${m.id}/taken/${date}`);
                    remove(takenDateRef);
                });
            }
        }
        
        function exportCSV() {
            if (meds.length === 0) {
                alert("No data to export.");
                return;
            }
            let csvContent = "data:text/csv;charset=utf-8,";
            const header = ["Medicine", "Usage", "Dosage", "Unit", "Time", "When", "Status"];
            csvContent += header.join(",") + "\n";

            meds.forEach(m => {
                const status = getStatus(m);
                const row = [
                    `"${m.name || ''}"`,
                    `"${m.usage || ''}"`,
                    m.dosage === undefined ? '' : m.dosage,
                    m.unit || '',
                    `"${m.time || ''}"`,
                    `"${m.when === 'Custom...' ? (m.customWhen || 'Custom') : m.when || ''}"`,
                    status.charAt(0).toUpperCase() + status.slice(1)
                ];
                csvContent += row.join(",") + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `medicine_tracker_${date}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function parseTime(timeStr) {
            if (!timeStr) return 0;
            const lower = timeStr.toLowerCase().trim();
            let hours = 0, minutes = 0;
            const match = lower.match(/(\d+):?(\d*)\s*(am|pm)?/);
            if (match) {
                hours = parseInt(match[1]);
                minutes = match[2] ? parseInt(match[2]) : 0;
                const meridiem = match[3];
                if (meridiem === 'pm' && hours !== 12) hours += 12;
                if (meridiem === 'am' && hours === 12) hours = 0;
            }
            return hours * 60 + minutes;
        }

        function getScheduleTime(when) {
            const times = {
                'Before Breakfast': 7 * 60, 'After Breakfast': 9 * 60, 
                'Before Lunch': 12 * 60, 'After Lunch': 14 * 60, 
                'Before Dinner': 19 * 60, 'After Dinner': 21 * 60 
            };
            return times[when] || 0;
        }

        function getStatus(m) {
            if (m.taken && m.taken[date] === true) return 'taken';
            if (m.taken && m.taken[date] === 'missed') return 'missed';
            return 'pending';
        }

        // --- Core Action Handlers (Used by both mobile and desktop controls) ---
        function handleUpdate(medId, field, value) {
            if (!currentUser || !medId) return;
            const medRef = ref(db, `users/${currentUser.uid}/medicines/${medId}`);
            update(medRef, { [field]: value }).catch(err => console.error('Update failed: ', err));
        }

        function handleStatusChange(medId, statusValue) {
            if (!currentUser || !medId) return;
            const takenDateRef = ref(db, `users/${currentUser.uid}/medicines/${medId}/taken/${date}`);
            
            if (statusValue === 'taken') {
                set(takenDateRef, true);
            } else if (statusValue === 'missed') {
                set(takenDateRef, 'missed');
            } else { // statusValue is pending (remove status)
                remove(takenDateRef);
            }
        }
        
        // Add global listeners for dynamic elements
        document.addEventListener('change', e => {
            const medId = e.target.dataset.i; 
            const field = e.target.dataset.f;

            if (medId && field) {
                if (field === 'taken') {
                    const isChecked = e.target.checked;
                    handleStatusChange(medId, isChecked ? 'taken' : 'pending');
                } else if (e.target.tagName === 'SELECT' || e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    handleUpdate(medId, field, e.target.value);
                }
            }
        });

        // --- FIXED CLICK HANDLER FOR ACTIONS AND MOBILE TOGGLE ---
        document.addEventListener('click', e => {
            const medId = e.target.dataset.i; 
            
            // Handle Delete, Duplicate, Missed Button
            if (medId) {
                if (e.target.classList.contains('del')) {
                    if (confirm('Delete?')) {
                        const medRef = ref(db, 'users/' + currentUser.uid + '/medicines/' + medId);
                        remove(medRef); 
                    }
                } else if (e.target.classList.contains('duplicate')) {
                    const originalMed = meds.find(m => m.id === medId);
                    if (!originalMed) return;
                    const duplicate = JSON.parse(JSON.stringify(originalMed));
                    duplicate.name += ' (Copy)';
                    delete duplicate.id; 
                    const medsRef = ref(db, 'users/' + currentUser.uid + '/medicines');
                    push(medsRef, duplicate); 
                } else if (e.target.classList.contains('missed-btn')) {
                    const currentMed = meds.find(m => m.id === medId);
                    const currentStatus = getStatus(currentMed); 

                    if (currentStatus === 'missed') {
                        handleStatusChange(medId, 'pending');
                    } else {
                        handleStatusChange(medId, 'missed'); 
                    }
                } 
            }
            
            // IMPROVED FIX: Handle mobile card expansion by ensuring the click target is the header or within it.
            const header = e.target.closest('.med-header');
            if (header) {
                // Ensure the click wasn't on the status indicator or any interactive element
                if (!e.target.classList.contains('status-indicator') && e.target.tagName !== 'BUTTON') {
                    const card = header.closest('.mobile-card');
                    if (card) {
                        card.classList.toggle('active');
                    }
                }
            }
        });

        function updateSummary() {
            const pending = meds.filter(m => getStatus(m) === 'pending').length;
            const taken = meds.filter(m => getStatus(m) === 'taken').length;
            const missed = meds.filter(m => getStatus(m) === 'missed').length;
            const total = meds.length;

            document.getElementById('summary').innerHTML = `
                <strong>Summary for ${date}:</strong> 
                Total: ${total} | 
                <span style="color:#9e9e9e;">Pending: ${pending}</span> | 
                <span style="color:#4CAF50;">Taken: ${taken}</span> | 
                <span style="color:#f44336;">Missed: ${missed}</span>
            `;
        }
        
        // --- Render Function ---
        function render() {
            const tbody = document.getElementById('list');
            const mobileGroupContainer = document.getElementById('mobileGroupList');
            
            // Clear both containers
            tbody.innerHTML = '';
            mobileGroupContainer.innerHTML = ''; 

            // 1. Filter the medicines
            const filteredMeds = meds.filter(m => {
                // Filter 1: Status Filter
                const statusMatch = (currentFilter === 'all') || (getStatus(m) === currentFilter);

                // Filter 2: Search Query Filter
                const nameMatch = (m.name || '').toLowerCase().includes(searchQuery);
                const notesMatch = (m.notes || '').toLowerCase().includes(searchQuery);
                const searchMatch = searchQuery === '' || nameMatch || notesMatch;

                return statusMatch && searchMatch;
            });
            
            if (filteredMeds.length === 0) {
                 const messageRow = tbody.insertRow();
                 messageRow.innerHTML = `<td colspan="9" style="text-align:center; padding:20px; color:#555;">No medicines match the current filters for this date.</td>`;
                 updateSummary();
                 return;
            }

            // 2. Group and Sort the filtered medicines
            const groups = [];
            filteredMeds.forEach(m => {
                let groupName, sortTime;
                if (m.when === 'Custom...' && m.customWhen) {
                    groupName = m.customWhen;
                    sortTime = parseTime(m.customWhen);
                } else {
                    groupName = m.when;
                    sortTime = getScheduleTime(m.when);
                }
                let group = groups.find(g => g.name === groupName);
                if (!group) {
                    group = { name: groupName, sortTime: sortTime, meds: [] };
                    groups.push(group);
                }
                group.meds.push(m);
            });

            // Primary sort: by schedule time
            groups.sort((a, b) => a.sortTime - b.sortTime);

            // Secondary sort: within each group, sort by status (pending first) and then by name
            groups.forEach(group => {
                group.meds.sort((a, b) => {
                    const statusA = getStatus(a);
                    const statusB = getStatus(b);

                    // Status priority: pending (0) < missed (1) < taken (2)
                    const statusMap = { 'pending': 0, 'missed': 1, 'taken': 2 };
                    const statusOrder = statusMap[statusA] - statusMap[statusB];

                    if (statusOrder !== 0) {
                        return statusOrder;
                    }
                    // Fallback to alphabetical sort by name
                    return (a.name || '').localeCompare(b.name || '');
                });
            });


            // 3. Render both Desktop Table and Mobile Grouped List
            groups.forEach(group => {
                const groupLabel = `${group.name} (${group.meds.length} ${group.meds.length === 1 ? 'medicine' : 'medicines'})`;

                // --- DESKTOP RENDER: Insert Header Row into the Table ---
                const headerRow = tbody.insertRow();
                headerRow.className = 'schedule-header';
                headerRow.innerHTML = `<td colspan="9" class="custom-cell">${groupLabel}</td>`;
                
                // --- MOBILE RENDER: Create Group Header and Card Container ---
                const mobileHeader = document.createElement('div');
                mobileHeader.className = 'mobile-group-header';
                mobileHeader.innerHTML = groupLabel;
                mobileGroupContainer.appendChild(mobileHeader);

                group.meds.forEach(m => {
                    const i = m.id; 
                    const medicineName = m.name || '';
                    const medicineUsage = m.usage || '';
                    const medicineDosage = m.dosage === undefined ? '' : m.dosage;
                    const medicineTime = m.time || '';
                    const medicineNotes = m.notes || '';
                    const status = getStatus(m);
                    const statusLabel = status.charAt(0).toUpperCase() + status.slice(1);
                    
                    // Helper function for select options
                    const option = (val) => `<option value="${val}" ${m.unit==val?'selected':''}>${val}</option>`;
                    const whenOption = (val) => `<option value="${val}" ${m.when==val?'selected':''}>${val}</option>`;

                    // Dynamic Unit/When Input Check (for both desktop and mobile render)
                    const unitInput = m.unit=='Custom' ? `<input type="text" value="${m.customUnit||''}" data-i="${i}" data-f="customUnit" placeholder="e.g., Vials">` : '';
                    const whenInput = m.when=='Custom...' ? `<input type="text" value="${m.customWhen||''}" data-i="${i}" data-f="customWhen" placeholder="e.g., 4pm, 12:30pm">` : '';


                    // 3a. DESKTOP ROW
                    const deskRow = tbody.insertRow();
                    deskRow.className = `med-row ${status === 'taken' ? 'taken-row' : status === 'missed' ? 'missed-row' : ''}`;
                    deskRow.innerHTML = `
                        <td data-label="Medicine"><input value="${medicineName}" data-i="${i}" data-f="name"></td>
                        <td data-label="Usage"><textarea data-i="${i}" data-f="usage" style="min-height:60px;">${medicineUsage}</textarea></td>
                        <td data-label="Dosage"><input type="number" value="${medicineDosage}" data-i="${i}" data-f="dosage" step="0.5"></td>
                        <td data-label="Unit">
                            <select data-i="${i}" data-f="unit">
                                ${option('tablets')}
                                ${option('ml')}
                                ${option('mg')}
                                ${option('drops')}
                                ${option('Packet')}
                                ${option('Capsules')}
                                ${option('Teaspoons')}
                                ${option('Custom')}
                            </select>
                            ${unitInput ? unitInput.replace('>', ' style="margin-top:5px;">') : ''}
                        </td>
                        <td data-label="Time"><input value="${medicineTime}" data-i="${i}" data-f="time" placeholder="Morning"></td>
                        <td data-label="When">
                            <select data-i="${i}" data-f="when">
                                ${whenOption('Before Breakfast')}
                                ${whenOption('After Breakfast')}
                                ${whenOption('Before Lunch')}
                                ${whenOption('After Lunch')}
                                ${whenOption('Before Dinner')}
                                ${whenOption('After Dinner')}
                                ${whenOption('Custom...')}
                            </select>
                            ${whenInput ? whenInput.replace('>', ' style="margin-top:5px;">') : ''}
                        </td>
                        <td data-label="Taken">
                            <div style="display:flex; align-items:center; gap:5px; position:relative; z-index: 2;">
                                <input type="checkbox" ${status === 'taken' ? 'checked':''} data-i="${i}" data-f="taken" style="margin:0;">
                                <button class="missed-btn" data-i="${i}" style="background:${status === 'missed' ? '#f44336' : '#ff9800'}; color:white; border:none; padding:2px 6px; font-size:10px; cursor:pointer; border-radius:3px;">
                                    ${status === 'missed' ? 'MISSED' : 'Miss'}
                                </button>
                            </div>
                        </td>
                        <td data-label="Notes">
                            <textarea data-i="${i}" data-f="notes" style="position:relative; z-index: 1;">${medicineNotes}</textarea>
                        </td>
                        <td data-label="Actions">
                            <button class="duplicate" data-i="${i}">Copy</button>
                            <button class="del" data-i="${i}">X</button>
                        </td>
                    `;
                    
                    // 3b. MOBILE CARD
                    const mobileCard = document.createElement('div');
                    mobileCard.className = `mobile-card ${status === 'taken' ? 'taken-row' : status === 'missed' ? 'missed-row' : ''}`;
                    mobileCard.dataset.i = i; // Add data-i to the card for easier lookup
                    mobileCard.innerHTML = `
                        <div class="med-header" data-i="${i}">
                            <h4>${medicineName || 'New Medicine'}</h4>
                            <span class="status-indicator ${status}">${statusLabel}</span>
                        </div>
                        <div class="med-details">
                            <div data-label="Dosage">
                                <input type="number" value="${medicineDosage}" data-i="${i}" data-f="dosage" step="0.5">
                            </div>
                            <div data-label="Unit">
                                <div class="custom-input-group">
                                    <select data-i="${i}" data-f="unit">
                                        ${option('tablets')}
                                        ${option('ml')}
                                        ${option('mg')}
                                        ${option('drops')}
                                        ${option('Packet')}
                                        ${option('Capsules')}
                                        ${option('Teaspoons')}
                                        ${option('Custom')}
                                    </select>
                                    ${unitInput}
                                </div>
                            </div>
                            <div data-label="Time">
                                <input value="${medicineTime}" data-i="${i}" data-f="time" placeholder="Morning">
                            </div>
                            <div data-label="When">
                                <div class="custom-input-group">
                                    <select data-i="${i}" data-f="when">
                                        ${whenOption('Before Breakfast')}
                                        ${whenOption('After Breakfast')}
                                        ${whenOption('Before Lunch')}
                                        ${whenOption('After Lunch')}
                                        ${whenOption('Before Dinner')}
                                        ${whenOption('After Dinner')}
                                        ${whenOption('Custom...')}
                                    </select>
                                    ${whenInput}
                                </div>
                            </div>
                            <div data-label="Taken">
                                <div style="display:flex; align-items:center; gap:15px; width:100%;">
                                    <input type="checkbox" ${status === 'taken' ? 'checked':''} data-i="${i}" data-f="taken" style="width:auto;">
                                    <button class="missed-btn" data-i="${i}" style="background:${status === 'missed' ? '#f44336' : '#ff9800'}; color:white; border:none; padding:5px 10px; cursor:pointer;">
                                        ${status === 'missed' ? 'Mark Pending' : 'Mark Missed'}
                                    </button>
                                </div>
                            </div>
                            <div data-label="Usage">
                                <textarea data-i="${i}" data-f="usage">${medicineUsage}</textarea>
                            </div>
                            <div data-label="Notes">
                                <textarea data-i="${i}" data-f="notes">${medicineNotes}</textarea>
                            </div>
                            <div data-label="Actions" style="border-top: 1px solid #eee; margin-top:10px; padding-top:15px; display:flex; justify-content:space-around;">
                                <button class="duplicate" data-i="${i}" style="width:45%;">Copy</button>
                                <button class="del" data-i="${i}" style="width:45%;">Delete</button>
                            </div>
                        </div>
                    `;
                    mobileGroupContainer.appendChild(mobileCard);
                });
            });
            updateSummary();
        }
    </script>
</body>
</html>
