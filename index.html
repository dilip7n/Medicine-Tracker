<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medicine Tracker</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 1200px; margin: 0 auto; }
        h1 { color: #333; }
        .controls { margin: 20px 0; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; font-size: 14px; }
        .add { background: #4CAF50; color: white; border: none; }
        .export { background: #2196F3; color: white; border: none; }
        .clear { background: #f44336; color: white; border: none; }
        table { width: 100%; border-collapse: collapse; background: white; margin-top: 20px; }
        th, td { padding: 10px; border: 1px solid #ddd; text-align: left; vertical-align: top; }
        th { background: #f0f0f0; font-weight: bold; }
        input, select { width: 100%; padding: 5px; box-sizing: border-box; min-height: 30px; }
        textarea { width: 100%; padding: 5px; box-sizing: border-box; min-height: 60px; resize: vertical; }
        td { vertical-align: top; }
        input[data-f="usage"], input[data-f="when"] { min-height: 50px; }
        .del { background: #f44336; color: white; border: none; padding: 5px 10px; cursor: pointer; }
        .taken-row { background-color: #f0f0f0; opacity: 0.7; }
        .taken-row input, .taken-row select, .taken-row textarea { background-color: #f5f5f5; }
        .schedule-header { background: #e8f4f8; font-weight: bold; }
    </style>
</head>
<body>
    <h1>ðŸ’Š Medicine Tracker</h1>
    <div class="controls">
        <label>Date: <input type="date" id="date"></label>
        <button class="add" id="addBtn">Add Medicine</button>
        <button class="export" id="exportBtn">Export CSV</button>
        <button class="clear" id="clearBtn">Clear All</button>
        <button class="export" onclick="save(); alert('Data saved to Firebase!')">ðŸ”¥ Force Save</button>
    </div>
    <div id="summary" style="background:#f9f9f9; padding:10px; margin:10px 0;"></div>
    <table>
        <thead>
            <tr>
                <th>Medicine</th>
                <th>Usage</th>
                <th>Dosage</th>
                <th>Unit</th>
                <th>Time</th>
                <th>When</th>
                <th>Taken</th>
                <th>Notes</th>
                <th>Delete</th>
            </tr>
        </thead>
        <tbody id="list"></tbody>
    </table>
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.21.0/firebase-app.js';
        import { getDatabase, ref, set, get } from 'https://www.gstatic.com/firebasejs/9.21.0/firebase-database.js';
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDYSBWvsWcfU4gfl2ECCJiKKxUgMjuvmF4",
            authDomain: "medicine-tracker-b90f2.firebaseapp.com",
            databaseURL: "https://medicine-tracker-b90f2-default-rtdb.firebaseio.com",
            projectId: "medicine-tracker-b90f2",
            storageBucket: "medicine-tracker-b90f2.firebasestorage.app",
            messagingSenderId: "230127910329",
            appId: "1:230127910329:web:114eea8f3846c446948a68"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        if (!window.meds) window.meds = [];
        let meds = window.meds;
        let date = new Date().toISOString().split('T')[0];
        document.getElementById('date').value = date;
        
        function save() { 
            // Show saving indicator
            const statusEl = document.getElementById('status') || createStatusElement();
            statusEl.textContent = 'ðŸ”¥ Saving to Firebase...';
            statusEl.style.color = 'orange';
            
            // Save to Firebase
            set(ref(db, 'medicines'), meds)
                .then(() => {
                    statusEl.textContent = 'âœ… Saved to Firebase (synced across devices)';
                    statusEl.style.color = 'green';
                    setTimeout(() => statusEl.textContent = '', 2000);
                })
                .catch((error) => {
                    console.error('Firebase save error:', error);
                    statusEl.textContent = 'âŒ Firebase save failed - using local storage';
                    statusEl.style.color = 'red';
                    
                    // Fallback to localStorage
                    localStorage.setItem('medicines', JSON.stringify(meds));
                    setTimeout(() => statusEl.textContent = '', 3000);
                });
        }
        
        function createStatusElement() {
            const statusEl = document.createElement('div');
            statusEl.id = 'status';
            statusEl.style.cssText = 'font-weight:bold; margin:10px 0; padding:5px;';
            document.querySelector('.controls').appendChild(statusEl);
            return statusEl;
        }
        
        function load() {
            // Show loading indicator
            const statusEl = document.getElementById('status') || createStatusElement();
            statusEl.textContent = 'ðŸ”¥ Loading from Firebase...';
            statusEl.style.color = 'blue';
            
            // Load from Firebase
            get(ref(db, 'medicines'))
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        window.meds = snapshot.val() || [];
                        meds = window.meds;
                        statusEl.textContent = `âœ… Loaded ${meds.length} medicines from Firebase`;
                        statusEl.style.color = 'green';
                        setTimeout(() => statusEl.textContent = '', 2000);
                        
                        // Check for localStorage migration
                        migrateFromLocalStorage();
                    } else {
                        // No data in Firebase, check localStorage
                        migrateFromLocalStorage();
                        if (meds.length === 0) {
                            statusEl.textContent = 'ðŸ†• No medicines found. Start adding!';
                            setTimeout(() => statusEl.textContent = '', 2000);
                        }
                    }
                    render();
                })
                .catch((error) => {
                    console.error('Firebase load error:', error);
                    statusEl.textContent = 'âŒ Firebase load failed - trying local backup...';
                    statusEl.style.color = 'orange';
                    
                    // Fallback to localStorage
                    const localData = localStorage.getItem('medicines');
                    if (localData) {
                        window.meds = JSON.parse(localData);
                        meds = window.meds;
                        statusEl.textContent = `ðŸ“± Loaded ${meds.length} medicines from local backup`;
                        setTimeout(() => statusEl.textContent = '', 3000);
                    } else {
                        statusEl.textContent = 'âŒ No data found. Start adding medicines.';
                        meds = [];
                    }
                    render();
                });
        }
        
        function migrateFromLocalStorage() {
            try {
                const localData = localStorage.getItem('medicines');
                if (localData) {
                    const oldMeds = JSON.parse(localData);
                    if (oldMeds && oldMeds.length > 0 && meds.length === 0) {
                        console.log('Migrating', oldMeds.length, 'medicines from localStorage to Firebase...');
                        window.meds = oldMeds;
                        meds = window.meds;
                        save(); // Save to Firebase
                        localStorage.removeItem('medicines'); // Clear localStorage after successful migration
                        const statusEl = document.getElementById('status') || createStatusElement();
                        statusEl.textContent = `ðŸ”¥ Migrated ${oldMeds.length} medicines to Firebase!`;
                        statusEl.style.color = 'green';
                        setTimeout(() => statusEl.textContent = '', 3000);
                    }
                }
            } catch (err) {
                console.error('Migration error:', err);
            }
        }
        
        function parseTime(timeStr) {
            // Parse time like "4pm", "12:30pm", "16:00" to minutes since midnight
            if (!timeStr) return 0;
            const lower = timeStr.toLowerCase().trim();
            let hours = 0, minutes = 0;
            
            const match = lower.match(/(\d+):?(\d*)\s*(am|pm)?/);
            if (match) {
                hours = parseInt(match[1]);
                minutes = match[2] ? parseInt(match[2]) : 0;
                const meridiem = match[3];
                
                if (meridiem === 'pm' && hours !== 12) hours += 12;
                if (meridiem === 'am' && hours === 12) hours = 0;
            }
            
            return hours * 60 + minutes;
        }
        
        function getScheduleTime(when) {
            // Return approximate time in minutes for standard schedules
            const times = {
                'Before Breakfast': 7 * 60,      // 7:00 AM
                'After Breakfast': 9 * 60,       // 9:00 AM
                'Before Lunch': 12 * 60,         // 12:00 PM
                'After Lunch': 14 * 60,          // 2:00 PM
                'Before Dinner': 19 * 60,        // 7:00 PM
                'After Dinner': 21 * 60          // 9:00 PM
            };
            return times[when] || 0;
        }
        
        function render() {
            const tbody = document.getElementById('list');
            tbody.innerHTML = '';
            
            // Create groups for medicines
            const groups = [];
            
            meds.forEach(m => {
                let groupName, sortTime;
                
                if (m.when === 'Custom...' && m.customWhen) {
                    groupName = m.customWhen;
                    sortTime = parseTime(m.customWhen);
                } else {
                    groupName = m.when;
                    sortTime = getScheduleTime(m.when);
                }
                
                let group = groups.find(g => g.name === groupName);
                if (!group) {
                    group = { name: groupName, sortTime: sortTime, meds: [] };
                    groups.push(group);
                }
                group.meds.push(m);
            });
            
            // Sort groups by time
            groups.sort((a, b) => a.sortTime - b.sortTime);
            
            // Render each group
            groups.forEach(group => {
                // Add schedule header
                const headerRow = tbody.insertRow();
                headerRow.className = 'schedule-header';
                headerRow.innerHTML = `<td colspan="9">${group.name} (${group.meds.length} ${group.meds.length === 1 ? 'medicine' : 'medicines'})</td>`;
                
                // Add medicines for this group
                group.meds.forEach(m => {
                    const i = meds.indexOf(m);
                    const row = tbody.insertRow();
                    if (m.taken[date]) {
                        row.className = 'taken-row';
                    }
                    row.innerHTML = `
                        <td><input value="${m.name}" data-i="${i}" data-f="name"></td>
                        <td><textarea data-i="${i}" data-f="usage" style="min-height:60px;">${m.usage}</textarea></td>
                        <td><input type="number" value="${m.dosage}" data-i="${i}" data-f="dosage" step="0.5"></td>
                        <td><select data-i="${i}" data-f="unit">
                            <option ${m.unit=='tablets'?'selected':''}>tablets</option>
                            <option ${m.unit=='ml'?'selected':''}>ml</option>
                            <option ${m.unit=='mg'?'selected':''}>mg</option>
                            <option ${m.unit=='drops'?'selected':''}>drops</option>
                            <option ${m.unit=='Packet'?'selected':''}>Packet</option>
                            <option ${m.unit=='Capsules'?'selected':''}>Capsules</option>
                            <option ${m.unit=='Teaspoons'?'selected':''}>Teaspoons</option>
                            <option ${m.unit=='Custom'?'selected':''}>Custom...</option>
                        </select></td>
                        <td><input value="${m.time}" data-i="${i}" data-f="time" placeholder="Morning"></td>
                        <td><select data-i="${i}" data-f="when">
                            <option ${m.when=='Before Breakfast'?'selected':''}>Before Breakfast</option>
                            <option ${m.when=='After Breakfast'?'selected':''}>After Breakfast</option>
                            <option ${m.when=='Before Lunch'?'selected':''}>Before Lunch</option>
                            <option ${m.when=='After Lunch'?'selected':''}>After Lunch</option>
                            <option ${m.when=='Before Dinner'?'selected':''}>Before Dinner</option>
                            <option ${m.when=='After Dinner'?'selected':''}>After Dinner</option>
                            <option ${m.when=='Custom...'?'selected':''}>Custom...</option>
                        </select>
                        ${m.when=='Custom...' ? `<input type="text" value="${m.customWhen||''}" data-i="${i}" data-f="customWhen" placeholder="e.g., 4pm, 12:30pm" style="margin-top:5px;">` : ''}</td>
                        <td><input type="checkbox" ${m.taken[date]?'checked':''} data-i="${i}" data-f="taken"></td>
                        <td><textarea data-i="${i}" data-f="notes">${m.notes||''}</textarea></td>
                        <td><button class="del" data-i="${i}">X</button></td>
                    `;
                });
            });
            updateSummary();
        }
        
        function updateSummary() {
            const total = meds.length;
            const taken = meds.filter(m => m.taken[date]).length;
            const pct = total ? Math.round(taken/total*100) : 0;
            document.getElementById('summary').innerHTML = `Total: ${total} | Taken: ${taken} | Completion: ${pct}%`;
        }
        
        document.getElementById('list').addEventListener('change', e => {
            const i = e.target.dataset.i;
            const f = e.target.dataset.f;
            if (i !== undefined && f) {
                if (f === 'taken') {
                    meds[i].taken[date] = e.target.checked;
                    // Update row styling when taken status changes
                    const row = e.target.closest('tr');
                    if (e.target.checked) {
                        row.className = 'taken-row';
                    } else {
                        row.className = '';
                    }
                } else {
                    meds[i][f] = e.target.value;
                    // If schedule changed, re-render to group properly
                    if (f === 'when') {
                        render();
                        return;
                    }
                }
                save();
                updateSummary();
            }
        });
        
        document.getElementById('list').addEventListener('click', e => {
            if (e.target.classList.contains('del')) {
                const i = e.target.dataset.i;
                if (confirm('Delete?')) {
                    meds.splice(i, 1);
                    save();
                    render();
                }
            }
        });
        
        document.getElementById('addBtn').addEventListener('click', () => {
            meds.push({ name:'', usage:'', dosage:'', unit:'tablets', time:'', when:'After Breakfast', customWhen:'', taken:{}, notes:'' });
            save();
            render();
        });
        
        document.getElementById('date').addEventListener('change', e => {
            date = e.target.value;
            render();
        });
        
        document.getElementById('clearBtn').addEventListener('click', () => {
            if (confirm('Clear all?')) {
                window.meds = [];
                meds = window.meds;
                save();
                render();
            }
        });
        
        document.getElementById('exportBtn').addEventListener('click', () => {
            let csv = 'Medicine,Usage,Dosage,Unit,Time,When,Taken,Notes\n';
            meds.forEach(m => {
                csv += `"${m.name}","${m.usage}","${m.dosage}","${m.unit}","${m.time}","${m.when}","${m.taken[date]?'Yes':'No'}","${m.notes||''}"\n`;
            });
            const blob = new Blob([csv], {type:'text/csv'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `meds-${date}.csv`;
            a.click();
        });
        
        load(); // Load from Firebase on startup
    </script>
</body>
</html>
