<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medicine Tracker</title>
    <style>
        /* Global styles */
        * {
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: #333;
        }

        .controls {
            margin: 20px 0;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .add {
            background: #4CAF50;
            color: white;
            border: none;
        }

        .export {
            background: #2196F3;
            color: white;
            border: none;
        }

        .clear {
            background: #f44336;
            color: white;
            border: none;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            margin-top: 20px;
        }

        th,
        td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: left;
            vertical-align: top;
        }

        th {
            background: #f0f0f0;
            font-weight: bold;
        }

        input,
        select {
            width: 100%;
            padding: 5px;
            box-sizing: border-box;
            min-height: 30px;
        }

        textarea {
            width: 100%;
            padding: 5px;
            box-sizing: border-box;
            min-height: 60px;
            resize: vertical;
        }

        td {
            vertical-align: top;
        }

        input[data-f="usage"],
        input[data-f="when"] {
            min-height: 50px;
        }

        .del {
            background: #f44336;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
        }

        .duplicate {
            background: #9C27B0;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
        }

        .taken-row {
            background-color: #f0f0f0;
            opacity: 0.7;
        }

        .taken-row input,
        .taken-row select,
        .taken-row textarea {
            background-color: #f5f5f5;
        }

        .missed-row {
            background-color: #ffebee;
            opacity: 0.8;
            border-left: 4px solid #f44336;
        }

        .missed-row input,
        .missed-row select,
        .missed-row textarea {
            background-color: #ffcdd2;
        }

        .schedule-header {
            background: #e8f4f8;
            font-weight: bold;
        }

        /* --- MOBILE RESPONSIVE FIX --- */
        @media (max-width: 768px) {
            table {
                border: 0;
            }

            table thead {
                display: none;
            }

            table tr {
                display: block;
                margin-bottom: 20px;
                border: 1px solid #ccc;
                border-radius: 5px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }

            table td {
                display: block;
                padding: 12px;
                padding-left: 50%;
                position: relative;
                text-align: left;
                border: none;
                border-bottom: 1px solid #eee;
            }

            table td:last-child {
                border-bottom: 0;
            }

            table td::before {
                content: attr(data-label);
                position: absolute;
                left: 10px;
                width: 40%;
                padding-right: 10px;
                font-weight: bold;
                white-space: nowrap;
            }

            input,
            select,
            textarea {
                width: 100%;
            }

            td[data-label="Taken"] div {
                position: relative;
                z-index: 2;
            }
            td[data-label="Notes"] textarea {
                position: relative;
                z-index: 1;
            }
        }
    </style>
</head>
<body>
    <div id="authContainer" style="display:none; max-width:400px; margin:50px auto; padding:30px; background:#f9f9f9; border-radius:10px;">
        <h2>🔒 Login to Medicine Tracker</h2>
        <div style="margin:20px 0;">
            <input type="email" id="email" placeholder="Email" style="width:100%; padding:10px; margin:5px 0; box-sizing:border-box;">
            <input type="password" id="password" placeholder="Password" style="width:100%; padding:10px; margin:5px 0; box-sizing:border-box;">
        </div>
        <button class="add" onclick="login()" style="width:48%; margin:2%;">Login</button>
        <button class="export" onclick="signup()" style="width:48%; margin:2%;">Sign Up</button>
        <div id="authError" style="color:red; margin-top:10px;"></div>
    </div>

    <div id="appContainer" style="display:none;">
        <div style="text-align:right; margin-bottom:10px;">
            <span id="userEmail" style="margin-right:10px; font-weight:bold;"></span>
            <button class="clear" onclick="logout()" style="padding:5px 15px;">Logout</button>
        </div>
        <h1>💊 Medicine Tracker</h1>
        <div class="controls">
            <label>Date: <input type="date" id="date"></label>
            <button class="add" id="addBtn">Add Medicine</button>
            <button class="export" id="exportBtn">Export CSV</button>
            <button class="clear" id="clearBtn">Clear Today</button>
            </div>
    </div>
    <div id="summary" style="background:#f9f9f9; padding:10px; margin:10px 0;"></div>
    <table id="medsTable">
        <thead>
            <tr>
                <th>Medicine</th>
                <th>Usage</th>
                <th>Dosage</th>
                <th>Unit</th>
                <th>Time</th>
                <th>When</th>
                <th>Taken</th>
                <th>Notes</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="list"></tbody>
    </table>
    </div>

    <script type="module">
        // Make functions global for inline onclick handlers
        window.login = login;
        window.signup = signup;
        window.logout = logout;
        
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.21.0/firebase-app.js';
        import { getDatabase, ref, set, onValue, push, update, remove } from 'https://www.gstatic.com/firebasejs/9.21.0/firebase-database.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.21.0/firebase-auth.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDYSBWvsWcfU4gfl2ECCJiKKxUgMjuvmF4",
            authDomain: "medicine-tracker-b90f2.firebaseapp.com",
            databaseURL: "https://medicine-tracker-b90f2-default-rtdb.firebaseio.com",
            projectId: "medicine-tracker-b90f2",
            storageBucket: "medicine-tracker-b90f2.firebasestorage.app",
            messagingSenderId: "230127910329",
            appId: "1:230127910329:web:114eea8f3846c446948a68"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        let currentUser = null;

        // Authentication functions are unchanged from the previous, working version
        function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorEl = document.getElementById('authError');

            if (!email || !password) {
                errorEl.textContent = 'Please enter email and password';
                return;
            }

            signInWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    currentUser = userCredential.user;
                    errorEl.textContent = '';
                    showApp();
                })
                .catch((error) => {
                    errorEl.textContent = 'Login failed: ' + error.message;
                });
        }

        function signup() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorEl = document.getElementById('authError');

            if (!email || !password) {
                errorEl.textContent = 'Please enter email and password';
                return;
            }

            if (password.length < 6) {
                errorEl.textContent = 'Password must be at least 6 characters';
                return;
            }

            createUserWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    currentUser = userCredential.user;
                    errorEl.textContent = '';
                    alert('Account created successfully!');
                    showApp();
                })
                .catch((error) => {
                    errorEl.textContent = 'Signup failed: ' + error.message;
                });
        }

        function logout() {
            if (confirm('Logout?')) {
                signOut(auth).then(() => {
                    currentUser = null;
                    showLogin();
                });
            }
        }

        function showLogin() {
            document.getElementById('authContainer').style.display = 'block';
            document.getElementById('appContainer').style.display = 'none';
        }

        function showApp() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            document.getElementById('userEmail').textContent = currentUser.email;
            load(); 
        }

        // Setup real-time sync listener
        let syncListener = null;

        function setupRealtimeSync() {
            if (!currentUser) return;
            if (syncListener) syncListener(); 

            const medsRef = ref(db, 'users/' + currentUser.uid + '/medicines');
            const statusEl = document.getElementById('status') || createStatusElement();
            statusEl.textContent = '🔄 Syncing with Firebase...';
            statusEl.style.color = 'blue';

            syncListener = onValue(medsRef, (snapshot) => {
                const data = snapshot.val(); 
                const newMedsArray = [];

                if (data) {
                    // Convert the object from Firebase into an array for rendering
                    for (const key in data) {
                        newMedsArray.push({
                            id: key, 
                            ...data[key]
                        });
                    }
                }

                // Only re-render if the data has actually changed
                if (JSON.stringify(newMedsArray) !== JSON.stringify(meds)) {
                    window.meds = newMedsArray;
                    meds = window.meds;
                    render(); 

                    statusEl.textContent = `✅ Synced ${meds.length} medicines`;
                    statusEl.style.color = 'green';
                    setTimeout(() => statusEl.textContent = '', 2000);
                } else {
                     statusEl.textContent = '✅ Synced';
                     statusEl.style.color = 'green';
                     setTimeout(() => statusEl.textContent = '', 2000);
                }
                
                migrateFromLocalStorage(); 

            }, (error) => {
                console.error('Real-time sync error:', error);
                statusEl.textContent = '❌ Sync failed. Check connection.';
                statusEl.style.color = 'red';
            });
        }
        
        function disableRealtimeSync() {
             if (syncListener) syncListener(); 
             syncListener = null;
        }

        // Check authentication state on load
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                showApp();
            } else {
                currentUser = null;
                disableRealtimeSync();
                showLogin();
            }
        });

        if (!window.meds) window.meds = [];
        let meds = window.meds;
        let date = new Date().toISOString().split('T')[0];
        
        document.getElementById('date').value = date;

        function createStatusElement() {
            const statusEl = document.createElement('div');
            statusEl.id = 'status';
            statusEl.style.cssText = 'font-weight:bold; margin:10px 0; padding:5px;';
            document.querySelector('.controls').appendChild(statusEl);
            return statusEl;
        }

        function load() {
            if (!currentUser) {
                return;
            }
            setupRealtimeSync();
        }

        function migrateFromLocalStorage() {
            try {
                const localData = localStorage.getItem('medicines');
                if (localData) {
                    const oldMeds = JSON.parse(localData);
                    if (oldMeds && oldMeds.length > 0 && meds.length === 0) {
                        console.log('Migrating', oldMeds.length, 'medicines from localStorage to Firebase...');
                        const medsRef = ref(db, 'users/' + currentUser.uid + '/medicines');
                        
                        oldMeds.forEach(med => {
                            const newMedRef = push(medsRef);
                            set(newMedRef, med); 
                        });

                        localStorage.removeItem('medicines'); 
                        const statusEl = document.getElementById('status') || createStatusElement();
                        statusEl.textContent = `🔥 Migrated ${oldMeds.length} medicines to Firebase!`;
                        statusEl.style.color = 'green';
                        setTimeout(() => statusEl.textContent = '', 3000);
                    }
                }
            } catch (err) {
                console.error('Migration error:', err);
            }
        }

        function parseTime(timeStr) {
            if (!timeStr) return 0;
            const lower = timeStr.toLowerCase().trim();
            let hours = 0, minutes = 0;
            const match = lower.match(/(\d+):?(\d*)\s*(am|pm)?/);
            if (match) {
                hours = parseInt(match[1]);
                minutes = match[2] ? parseInt(match[2]) : 0;
                const meridiem = match[3];
                if (meridiem === 'pm' && hours !== 12) hours += 12;
                if (meridiem === 'am' && hours === 12) hours = 0;
            }
            return hours * 60 + minutes;
        }

        function getScheduleTime(when) {
            const times = {
                'Before Breakfast': 7 * 60, 
                'After Breakfast': 9 * 60, 
                'Before Lunch': 12 * 60, 
                'After Lunch': 14 * 60, 
                'Before Dinner': 19 * 60, 
                'After Dinner': 21 * 60 
            };
            return times[when] || 0;
        }

        // ** RENDER FUNCTION FIXES **
        function render() {
            const tbody = document.getElementById('list');
            tbody.innerHTML = '';

            const groups = [];

            meds.forEach(m => {
                let groupName, sortTime;

                if (m.when === 'Custom...' && m.customWhen) {
                    groupName = m.customWhen;
                    sortTime = parseTime(m.customWhen);
                } else {
                    groupName = m.when;
                    sortTime = getScheduleTime(m.when);
                }

                let group = groups.find(g => g.name === groupName);
                if (!group) {
                    group = {
                        name: groupName,
                        sortTime: sortTime,
                        meds: []
                    };
                    groups.push(group);
                }
                group.meds.push(m);
            });

            groups.sort((a, b) => a.sortTime - b.sortTime);

            groups.forEach(group => {
                const headerRow = tbody.insertRow();
                headerRow.className = 'schedule-header';
                headerRow.innerHTML = `<td colspan="9">${group.name} (${group.meds.length} ${group.meds.length === 1 ? 'medicine' : 'medicines'})</td>`;

                group.meds.forEach(m => {
                    // This is the Firebase ID, which acts as the row key
                    const i = m.id; 
                    
                    // Added default checks to prevent 'undefined' errors
                    const medicineName = m.name || '';
                    const medicineUsage = m.usage || '';
                    const medicineDosage = m.dosage === undefined ? '' : m.dosage;
                    const medicineTime = m.time || '';
                    const medicineNotes = m.notes || '';

                    const row = tbody.insertRow();
                    if (m.taken && m.taken[date] === true) {
                        row.className = 'taken-row';
                    } else if (m.taken && m.taken[date] === 'missed') {
                        row.className = 'missed-row';
                    }
                    
                    // Ensured all values are correctly bound and used 'i' for data-i
                    row.innerHTML = `
                        <td data-label="Medicine"><input value="${medicineName}" data-i="${i}" data-f="name"></td>
                        <td data-label="Usage"><textarea data-i="${i}" data-f="usage" style="min-height:60px;">${medicineUsage}</textarea></td>
                        <td data-label="Dosage"><input type="number" value="${medicineDosage}" data-i="${i}" data-f="dosage" step="0.5"></td>
                        <td data-label="Unit"><select data-i="${i}" data-f="unit">
                            <option ${m.unit=='tablets'?'selected':''}>tablets</option>
                            <option ${m.unit=='ml'?'selected':''}>ml</option>
                            <option ${m.unit=='mg'?'selected':''}>mg</option>
                            <option ${m.unit=='drops'?'selected':''}>drops</option>
                            <option ${m.unit=='Packet'?'selected':''}>Packet</option>
                            <option ${m.unit=='Capsules'?'selected':''}>Capsules</option>
                            <option ${m.unit=='Teaspoons'?'selected':''}>Teaspoons</option>
                            <option ${m.unit=='Custom'?'selected':''}>Custom...</option>
                        </select></td>
                        <td data-label="Time"><input value="${medicineTime}" data-i="${i}" data-f="time" placeholder="Morning"></td>
                        <td data-label="When"><select data-i="${i}" data-f="when">
                            <option ${m.when=='Before Breakfast'?'selected':''}>Before Breakfast</option>
                            <option ${m.when=='After Breakfast'?'selected':''}>After Breakfast</option>
                            <option ${m.when=='Before Lunch'?'selected':''}>Before Lunch</option>
                            <option ${m.when=='After Lunch'?'selected':''}>After Lunch</option>
                            <option ${m.when=='Before Dinner'?'selected':''}>Before Dinner</option>
                            <option ${m.when=='After Dinner'?'selected':''}>After Dinner</option>
                            <option ${m.when=='Custom...'?'selected':''}>Custom...</option>
                        </select>
                        ${m.when=='Custom...' ? `<input type="text" value="${m.customWhen||''}" data-i="${i}" data-f="customWhen" placeholder="e.g., 4pm, 12:30pm" style="margin-top:5px;">` : ''}</td>
                        <td data-label="Taken">
                            <div style="display:flex; align-items:center; gap:5px; position:relative; z-index: 2;">
                                <input type="checkbox" ${m.taken && m.taken[date] === true ?'checked':''} data-i="${i}" data-f="taken" style="margin:0;">
                                <button class="missed-btn" data-i="${i}" style="background:${m.taken && m.taken[date] === 'missed' ? '#f44336' : '#ff9800'}; color:white; border:none; padding:2px 6px; font-size:10px; cursor:pointer; border-radius:3px;">
                                    ${m.taken && m.taken[date] === 'missed' ? 'MISSED' : 'Miss'}
                                </button>
                            </div>
                        </td>
                        <td data-label="Notes">
                            <textarea data-i="${i}" data-f="notes" style="position:relative; z-index: 1;">${medicineNotes}</textarea>
                        </td>
                        <td data-label="Actions">
                            <button class="duplicate" data-i="${i}">Copy</button>
                            <button class="del" data-i="${i}">X</button>
                        </td>
                    `;
                });
            });
            updateSummary();
        }
        // End of RENDER FUNCTION FIXES

        function updateSummary() {
            // Updated filter logic to safely check for 'taken' object
            const total = meds.length;
            const taken = meds.filter(m => m.taken && m.taken[date] === true).length;
            const missed = meds.filter(m => m.taken && m.taken[date] === 'missed').length;
            const pending = total - taken - missed;
            const pct = total ? Math.round(taken / total * 100) : 0;
            document.getElementById('summary').innerHTML = `
                Total: ${total} | 
                ✅ Taken: ${taken} | 
                ❌ Missed: ${missed} | 
                ⏳ Pending: ${pending} | 
                Completion: ${pct}%
            `;
        }

        // Event listeners are unchanged from the previous, working version
        document.getElementById('list').addEventListener('change', e => {
            const medId = e.target.dataset.i; 
            const field = e.target.dataset.f;

            if (medId && field) {
                const medRef = ref(db, `users/${currentUser.uid}/medicines/${medId}`);

                if (field === 'taken') {
                    const isChecked = e.target.checked;
                    const takenDateRef = ref(db, `users/${currentUser.uid}/medicines/${medId}/taken/${date}`);

                    if (isChecked) {
                        set(takenDateRef, true); 
                    } else {
                        remove(takenDateRef); 
                    }
                } else {
                    update(medRef, {
                        [field]: e.target.value
                    }).catch(err => console.error('Update failed: ', err));
                }
            }
        });

        document.getElementById('list').addEventListener('click', e => {
            const medId = e.target.dataset.i; 

            if (e.target.classList.contains('del')) {
                if (confirm('Delete?')) {
                    const medRef = ref(db, 'users/' + currentUser.uid + '/medicines/' + medId);
                    remove(medRef); 
                }
            } else if (e.target.classList.contains('duplicate')) {
                const originalMed = meds.find(m => m.id === medId);
                if (!originalMed) return;

                const duplicate = JSON.parse(JSON.stringify(originalMed));
                duplicate.name += ' (Copy)';
                delete duplicate.id; 

                const medsRef = ref(db, 'users/' + currentUser.uid + '/medicines');
                push(medsRef, duplicate); 

            } else if (e.target.classList.contains('missed-btn')) {
                const takenDateRef = ref(db, `users/${currentUser.uid}/medicines/${medId}/taken/${date}`);
                const currentMed = meds.find(m => m.id === medId);
                const currentStatus = currentMed?.taken?.[date]; 

                if (currentStatus === 'missed') {
                    remove(takenDateRef); 
                } else {
                    set(takenDateRef, 'missed'); 
                }
            }
        });

        document.getElementById('addBtn').addEventListener('click', () => {
            const newMed = {
                name: '',
                usage: '',
                dosage: '',
                unit: 'tablets',
                time: '',
                when: 'After Breakfast',
                customWhen: '',
                taken: {},
                notes: ''
            };

            const medsRef = ref(db, 'users/' + currentUser.uid + '/medicines');
            push(medsRef, newMed)
                .then(() => {
                    console.log('Added new medicine');
                })
                .catch(err => {
                    console.error('Failed to add medicine: ', err);
                });
        });

        document.getElementById('date').addEventListener('change', e => {
            date = e.target.value;
            render(); 
        });

        document.getElementById('clearBtn').addEventListener('click', () => {
            if (confirm(`Clear all taken/missed status for ${date}?`)) {
                const updates = {};
                
                meds.forEach(m => {
                    if (m.taken && m.taken[date] !== undefined) {
                        updates[`users/${currentUser.uid}/medicines/${m.id}/taken/${date}`] = null;
                    }
                });

                if (Object.keys(updates).length > 0) {
                    update(ref(db), updates)
                        .then(() => {
                            console.log('Cleared all statuses for the day.');
                        })
                        .catch(err => {
                            console.error('Failed to clear statuses: ', err);
                        });
                }
            }
        });

        document.getElementById('exportBtn').addEventListener('click', () => {
            let csv = 'Medicine,Usage,Dosage,Unit,Time,When,Taken,Notes\n';
            meds.forEach(m => {
                // Ensure m.taken exists before checking its properties
                const status = m.taken && m.taken[date] === true ? 'Taken' : m.taken && m.taken[date] === 'missed' ? 'Missed' : 'Pending';
                csv += `"${m.name}","${m.dosage === undefined ? '' : m.dosage}","${m.unit}","${m.time}","${m.when}","${status}","${m.notes||''}"\n`;
            });
            const blob = new Blob([csv], {
                type: 'text/csv'
            });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `meds-${date}.csv`;
            a.click();
        });
    </script>
</body>
</html>
