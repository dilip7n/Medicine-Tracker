<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>Holistic Health Tracker (BP/Glucose)</title>
Â  Â  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>â¤ï¸</text></svg>">
Â  Â  <style>
Â  Â  Â  Â  /* Global & Reset */
Â  Â  Â  Â  * { box-sizing: border-box; }
Â  Â  Â  Â  body { font-family: Arial, sans-serif; padding: 20px; max-width: 1200px; margin: 0 auto; background-color: #f7f9fc; }
Â  Â  Â  Â  h1 { color: #1a4f78; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; }
Â  Â  Â  Â  .controls { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05); margin-bottom: 20px; }
Â  Â  Â  Â  .controls label { font-weight: bold; display: block; margin-top: 5px; color: #555; margin-bottom: 5px; }
Â  Â  Â  Â  .controls input[type="date"], .controls input[type="time"], .controls input[type="number"], .controls input[type="text"], .controls select, #personSelect { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
Â  Â  Â  Â  .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin-bottom: 15px; align-items: start; }
Â  Â  Â  Â  .person-input-group { display: flex; flex-direction: column; gap: 5px; }
Â  Â  Â  Â  #personCustomInput { margin-top: 0; display: none; }
Â  Â  Â  Â  button { padding: 10px 20px; margin-top: 10px; cursor: pointer; font-size: 16px; border: none; border-radius: 4px; }
Â  Â  Â  Â  .add { background: #4CAF50; color: white; }
Â  Â  Â  Â  .update { background: #FF9800; color: white; display: none; }
Â  Â  Â  Â  .table-export-btn { background: #2196F3; color: white; padding: 8px 15px; font-size: 14px; margin-top: 10px; float: right; white-space: nowrap; }
Â  Â  Â  Â  .export-btn { background: #007bff; color: white; margin-top: 15px; }
Â  Â  Â  Â  .logout-btn { background: #f44336; color: white; padding: 5px 15px; font-size: 14px; }
Â  Â  Â  Â  #overallAveragesContainer, #todayAveragesContainer, #detailedHistoryContainer { margin-top: 30px; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05); }
Â  Â  Â  Â  .data-table { width: 100%; min-width: 0; border-collapse: collapse; margin-top: 15px; }
Â  Â  Â  Â  .data-table th, .data-table td { padding: 12px 10px; border: 1px solid #eee; text-align: center; font-size: 0.9em; }
Â  Â  Â  Â  .data-table thead th { background-color: #1a4f78; color: white; font-weight: bold; white-space: nowrap; }
Â  Â  Â  Â  .data-table thead tr:nth-child(2) th { background-color: #007bff; color: white; }
Â  Â  Â  Â  .data-table tbody th { text-align: left; background-color: #f0f8ff; font-weight: bold; }
Â  Â  Â  Â  .data-table tr:nth-child(even) { background-color: #f7f9fc; }
Â  Â  Â  Â  .avg-bp, .avg-reading { white-space: nowrap; font-weight: bold; }
Â  Â  Â  Â  .no-data { color: #999; font-style: italic; }
Â  Â  Â  Â  #authContainer { max-width:400px; margin:50px auto; padding:30px; background:#f9f9f9; border-radius:10px; }
Â  Â  Â  Â  .signup-fields { display: none; }
Â  Â  Â  Â  #authContainer.signup-mode .signup-fields { display: block; }
Â  Â  Â  Â  #mfaContainer { max-width:400px; margin:50px auto; padding:30px; background:#f9f9f9; border-radius:10px; display: none; }
Â  Â  Â  Â  #enrollMfaContainer { max-width:400px; margin:50px auto; padding:30px; background:#fff3e0; border-radius:10px; display: none; }
Â  Â  Â  Â  #recaptcha-container { margin-top: 10px; }
Â  Â  Â  Â  .nav-link { text-decoration: none; color: white; font-weight: bold; margin-left: 15px; padding: 8px 12px; border-radius: 4px; background: #2196F3; transition: background 0.2s; }
Â  Â  Â  Â  .nav-link:hover { background: #0d47a1; }
Â  Â  Â  Â  .action-btn { background-color: #f44336; color: white; border: none; padding: 3px 6px; border-radius: 3px; cursor: pointer; font-size: 0.8em; margin-left: 5px; white-space: nowrap; }
Â  Â  Â  Â  .edit-btn { background-color: #4CAF50; }
Â  Â  Â  Â  .action-btn:hover { opacity: 0.8; }
Â  Â  Â  Â  /* --- MOBILE RESPONSIVENESS: CARD/LIST VIEW --- */
Â  Â  Â  Â  @media screen and (max-width: 768px) {
Â  Â  Â  Â  Â  Â  body { padding: 10px; }
Â  Â  Â  Â  Â  Â  .input-grid { grid-template-columns: 1fr; } 
Â  Â  Â  Â  Â  Â  #overallAveragesContainer, #detailedHistoryContainer { padding: 10px; }
Â  Â  Â  Â  Â  Â  .data-table { border: 0; }
Â  Â  Â  Â  Â  Â  .data-table thead, .data-table thead tr { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); border: 0; }
Â  Â  Â  Â  Â  Â  .data-table tr { display: block; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); background-color: #fff; }
Â  Â  Â  Â  Â  Â  .data-table tbody th { display: block; text-align: center; border: none; border-bottom: 1px solid #ccc; background-color: #1a4f78; color: white; font-size: 1.1em; padding: 10px; border-radius: 8px 8px 0 0; }
Â  Â  Â  Â  Â  Â  .data-table td { display: block; text-align: right; border: none; border-bottom: 1px dotted #ddd; position: relative; padding-left: 50%; }
Â  Â  Â  Â  Â  Â  .data-table td::before { content: attr(data-label) ":"; position: absolute; left: 10px; width: 45%; padding-right: 10px; white-space: nowrap; text-align: left; font-weight: bold; color: #555; }
Â  Â  Â  Â  Â  Â  .data-table tr:nth-child(even) { background-color: #fff; } 
Â  Â  Â  Â  Â  Â  #todayAveragesContainer .data-table thead, #todayAveragesContainer .data-table thead tr { display: none; position: static; }
Â  Â  Â  Â  Â  Â  #todayAveragesContainer .data-table tbody tr { border: none; box-shadow: none; margin-bottom: 0; display: flex; flex-wrap: wrap; border-bottom: 1px solid #e0e0e0; padding: 10px 0; background-color: transparent !important; }
Â  Â  Â  Â  Â  Â  #todayAveragesContainer .data-table tbody th { flex: 0 0 100%; text-align: left; background-color: transparent; color: #1a4f78; border: none; font-size: 1.1em; padding: 5px 10px; border-bottom: 1px solid #ccc; }
Â  Â  Â  Â  Â  Â  #todayAveragesContainer .data-table tbody td { flex: 1 1 50%; text-align: left; padding-left: 0; border: none; border-bottom: none; min-width: 50%; }
Â  Â  Â  Â  Â  Â  #todayAveragesContainer .data-table tbody td:before { content: attr(data-person) ":"; position: static; width: auto; padding-right: 5px; font-weight: normal; color: #1a4f78; }
Â  Â  Â  Â  Â  Â  #todayAveragesContainer .detail-reading { display: block; line-height: 1.4; }
Â  Â  Â  Â  Â  Â  .action-btn { margin-top: 5px; margin-right: 5px; }
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body>
Â  Â  <div id="authContainer" style="display:none;">
Â  Â  Â  Â  <h2>ğŸ”’ Health Tracker Access</h2>
Â  Â  Â  Â  <div style="margin:20px 0;">
Â  Â  Â  Â  Â  Â  <div class="signup-fields">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="name" placeholder="Your Name" style="width:100%; padding:10px; margin:5px 0; box-sizing:border-box;">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <input type="email" id="email" placeholder="Email" style="width:100%; padding:10px; margin:5px 0; box-sizing:border-box;">
Â  Â  Â  Â  Â  Â  <input type="password" id="password" placeholder="Password (min 6 chars)" style="width:100%; padding:10px; margin:5px 0; box-sizing:border-box;">
Â  Â  Â  Â  Â  Â  <div class="signup-fields">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="password" id="confirmPassword" placeholder="Confirm Password" style="width:100%; padding:10px; margin:5px 0; box-sizing:border-box;">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <button class="add" onclick="login()" style="width:48%; margin:2%;" id="loginBtn">Login</button>
Â  Â  Â  Â  <button class="export" onclick="toggleSignupMode()" style="width:48%; margin:2%;" id="signupToggleBtn">Sign Up</button>
Â  Â  Â  Â  <div id="authError" style="color:red; margin-top:10px;"></div>
Â  Â  Â  Â  <div id="recaptcha-container"></div>Â 
Â  Â  </div>
Â  Â Â 
Â  Â  <div id="mfaContainer">
Â  Â  Â  Â  <h2>ğŸ”‘ Two-Factor Verification</h2>
Â  Â  Â  Â  <p id="mfaInstructions" style="color:#555;"></p>
Â  Â  Â  Â  <input type="text" id="mfaSmsCode" placeholder="Enter SMS Code" style="width:100%; padding:10px; margin:10px 0; box-sizing:border-box;">
Â  Â  Â  Â  <button class="add" onclick="resolveMfaLogin(document.getElementById('mfaSmsCode').value)" style="width:100%;">Verify and Login</button>
Â  Â  Â  Â  <div id="mfaError" style="color:red; margin-top:10px;"></div>
Â  Â  </div>

Â  Â  <div id="enrollMfaContainer">
Â  Â  Â  Â  <h2>âš ï¸ Security Setup Required</h2>
Â  Â  Â  Â  <p style="color:#e65100;">For your security, we need to enroll a phone number to enable two-factor verification. This is a one-time setup.</p>
Â  Â  Â  Â  <input type="text" id="enrollPhoneNumber" placeholder="Phone Number (e.g., +15555550100)" style="width:100%; padding:10px; margin:10px 0; box-sizing:border-box;">
Â  Â  Â  Â  <button class="add" onclick="startMfaEnrollment()" style="width:100%; background: #e65100;">Send Verification Code</button>
Â  Â  Â  Â  <div id="enrollError" style="color:red; margin-top:10px;"></div>
Â  Â  </div>
Â  Â  <div id="appContainer" style="display:none;">
Â  Â  Â  Â  <div style="text-align:right; margin-bottom:20px; display:flex; justify-content:flex-end; align-items:center;">
Â  Â  Â  Â  Â  Â  <a href="index.html" class="nav-link">ğŸ’Š Medicine Tracker</a>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <span id="userEmail" style="margin-right:10px; font-weight:bold; margin-left: 15px;"></span>
Â  Â  Â  Â  Â  Â  <button class="logout-btn" onclick="logout()">Logout</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <h1>â¤ï¸ Daily Health Readings</h1>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div class="controls">
Â  Â  Â  Â  Â  Â  <h2>Record a New Reading</h2>
Â  Â  Â  Â  Â  Â  <div class="input-grid">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="hidden" id="readingIdToEdit" value="">
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="recordDate">Date</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="date" id="recordDate">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="recordTime">Time</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="time" id="recordTime">
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="personSelect">Person Name</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="person-input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="personSelect" onchange="handlePersonChange(this.value)">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="" disabled selected>Select a person...</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Custom">Add New Person...</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="personCustomInput" placeholder="Enter new name here" onblur="handleCustomNameBlur(this.value)">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="systole">Systolic (BP)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="systole" placeholder="e.g., 120" step="1">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="diastole">Diastolic (BP)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="diastole" placeholder="e.g., 80" step="1">
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="glucose">Glucose (mg/dL)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="glucose" placeholder="e.g., 100" step="0.1">
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="weight">Weight (kg/lbs)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="weight" placeholder="e.g., 75" step="0.1">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <button class="add" id="addButton" onclick="addReading()">Add Reading</button>
Â  Â  Â  Â  Â  Â  <button class="update" id="updateButton" onclick="updateReading()">Update Reading</button>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <button class="export-btn" onclick="exportFullHistory()">â¬‡ï¸ Download Full History (CSV)</button>

Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div id="todayAveragesContainer">
Â  Â  Â  Â  Â  Â  <h2>â˜€ï¸ Today's Individual Readings</h2>Â 
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="detailedHistoryContainer">
Â  Â  Â  Â  Â  Â  <div style="display:flex; justify-content:space-between; align-items:center;">
Â  Â  Â  Â  Â  Â  Â  Â  <h2>ğŸ“… Detailed 30-Day Reading History (Latest Reading/Day)</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="table-export-btn" onclick="exportDetailedHistory()">â¬‡ï¸ Download Table (CSV)</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <p style="text-align: center; font-style: italic; color: #555;">Showing the **latest recorded reading** for each person on a given day across the last 30 days. For a full export, please use the download button above.</p>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="overallAveragesContainer">
Â  Â  Â  Â  Â  Â  <div style="display:flex; justify-content:space-between; align-items:center;">
Â  Â  Â  Â  Â  Â  Â  Â  <h2>ğŸ“ˆ Overall Averages Summary</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="table-export-btn" onclick="exportOverallAverages()">â¬‡ï¸ Download Table (CSV)</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  </div>

Â  Â  <script type="module">
Â  Â  Â  Â  // Make functions global for inline onclick handlers
Â  Â  Â  Â  window.login = login;
Â  Â  Â  Â  window.signup = signup;
Â  Â  Â  Â  window.logout = logout;
Â  Â  Â  Â  window.toggleSignupMode = toggleSignupMode;Â 
Â  Â  Â  Â  window.handlePersonChange = handlePersonChange;
Â  Â  Â  Â  window.handleCustomNameBlur = handleCustomNameBlur;Â 
Â  Â  Â  Â  window.addReading = addReading;
Â  Â  Â  Â  window.updateReading = updateReading;Â 
Â  Â  Â  Â  window.editReading = editReading;Â  Â 
Â  Â  Â  Â  window.deleteReading = deleteReading;
Â  Â  Â  Â  window.loadReadings = loadReadings;Â 
Â  Â  Â  Â  window.exportFullHistory = exportFullHistory;Â 
Â  Â  Â  Â  window.exportDetailedHistory = exportDetailedHistory;Â 
Â  Â  Â  Â  window.exportOverallAverages = exportOverallAverages;Â 
Â  Â  Â  Â  // --- NEW MFA GLOBAL FUNCTIONS ---
Â  Â  Â  Â  window.resolveMfaLogin = resolveMfaLogin;
Â  Â  Â  Â  window.startMfaEnrollment = startMfaEnrollment;
Â  Â  Â  Â  window.completeMfaEnrollment = completeMfaEnrollment;


Â  Â  Â  Â  // Import Firebase modules (via CDN for standalone HTML)
Â  Â  Â  Â  import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.21.0/firebase-app.js';
Â  Â  Â  Â  import { getDatabase, ref, set, onValue, push, update, remove } from 'https://www.gstatic.com/firebasejs/9.21.0/firebase-database.js';
Â  Â  Â  Â Â 
Â  Â  Â  Â  import {Â 
Â  Â  Â  Â  Â  Â  getAuth,Â 
Â  Â  Â  Â  Â  Â  signInWithEmailAndPassword,Â 
Â  Â  Â  Â  Â  Â  createUserWithEmailAndPassword,Â 
Â  Â  Â  Â  Â  Â  onAuthStateChanged,Â 
Â  Â  Â  Â  Â  Â  signOut,
Â  Â  Â  Â  Â  Â  PhoneAuthProvider,
Â  Â  Â  Â  Â  Â  multiFactor,
            updateProfile
Â  Â  Â  Â  } from 'https://www.gstatic.com/firebasejs/9.21.0/firebase-auth.js';
Â  Â  Â  Â  
        // NOTE: We keep the auth-compat import for RecaptchaVerifier as it's cleaner than v9's standalone implementation
Â  Â  Â  Â  import firebase from 'https://www.gstatic.com/firebasejs/9.21.0/firebase-auth-compat.js';Â 


Â  Â  Â  Â  // =========================================================================
Â  Â  Â  Â  // *** CORRECTED FIREBASE CONFIGURATION ***
Â  Â  Â  Â  // This block uses the configuration you provided.
Â  Â  Â  Â  // =========================================================================
Â  Â  Â  Â  const firebaseConfig = {
Â  Â  Â  Â  Â  Â  apiKey: "AIzaSyAjRB8_dLv8icceOyZNNGO9kIXUFVjWfoY",
Â  Â  Â  Â  Â  Â  authDomain: "medicine-tracker-b90f2.firebaseapp.com",
Â  Â  Â  Â  Â  Â  databaseURL: "https://medicine-tracker-b90f2-default-rtdb.firebaseio.com",
Â  Â  Â  Â  Â  Â  projectId: "medicine-tracker-b90f2",
Â  Â  Â  Â  Â  Â  storageBucket: "medicine-tracker-b90f2.firebasestorage.app",
Â  Â  Â  Â  Â  Â  messagingSenderId: "230127910329",
Â  Â  Â  Â  Â  Â  appId: "1:230127910329:web:756789fcd3a1ac02948a68"
Â  Â  Â  Â  };
Â  Â  Â  Â  // =========================================================================


Â  Â  Â  Â  // Initialize Firebase
Â  Â  Â  Â  let app, db, auth;
        try {
Â  Â  Â  Â  Â  Â  app = initializeApp(firebaseConfig);
Â  Â  Â  Â  Â  Â  db = getDatabase(app);
Â  Â  Â  Â  Â  Â  auth = getAuth(app);
            console.log("Firebase initialized successfully.");
        } catch (e) {
            console.error("FIREBASE INITIALIZATION FAILED:", e);
            document.getElementById('authError').textContent = 'Initialization failed. Check your Firebase config and the browser console for errors.';
            // Hide everything if initialization fails to prevent phantom UI
            document.getElementById('authContainer').style.display = 'none';
            return; 
        }

Â  Â  Â  Â  let currentUser = null;
Â  Â  Â  Â  let allReadings = [];
Â  Â  Â  Â  let allPersonAveragesCache = {}; // Cache for overall averages
Â  Â  Â  Â  let detailedHistoryDataCache = {}; // Cache for detailed history data
Â  Â  Â  Â  let personNames = new Set();
Â  Â  Â  Â  let currentPerson = '';
Â  Â  Â  Â  const today = new Date();
Â  Â  Â  Â  document.getElementById('recordDate').value = today.toISOString().split('T')[0];
Â  Â  Â  Â  document.getElementById('recordTime').value = today.toTimeString().split(' ')[0].substring(0, 5);Â 
Â  Â  Â  Â  const todayDateString = today.toISOString().split('T')[0];

Â  Â  Â  Â  // --- MFA VARIABLES ---
Â  Â  Â  Â  let recaptchaVerifier = null;
Â  Â  Â  Â  let mfaResolver = null; 
Â  Â  Â  Â  let verificationId = null; 
Â  Â  Â  Â  let enrollmentSession = null; 

Â  Â  Â  Â  // --- MFA: Setup Invisible reCAPTCHA ---
Â  Â  Â  Â  function setupRecaptcha() {
Â  Â  Â  Â  Â  Â  if (recaptchaVerifier) {
Â  Â  Â  Â  Â  Â  Â  Â  if (window.grecaptcha && recaptchaVerifier.widgetId !== undefined) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.grecaptcha.reset(recaptchaVerifier.widgetId);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  recaptchaVerifier = null; 
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
Â  Â  Â  Â  Â  Â  Â  Â  'size': 'invisible',Â 
Â  Â  Â  Â  Â  Â  Â  Â  'callback': (response) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // reCAPTCHA solved automatically in invisible mode
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  'expired-callback': () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('authError').textContent = 'reCAPTCHA expired. Please refresh.';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }, auth);

Â  Â  Â  Â  Â  Â  recaptchaVerifier.render();
Â  Â  Â  Â  }


Â  Â  Â  Â  // --- UTILITY: Date Formatting (DD-MMM-YY) ---
Â  Â  Â  Â  function formatDate(dateString) {
Â  Â  Â  Â  Â  Â  if (!dateString) return '';
Â  Â  Â  Â  Â  Â  const date = new Date(dateString + 'T00:00:00');Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const day = date.getDate().toString().padStart(2, '0');
Â  Â  Â  Â  Â  Â  const year = date.getFullYear().toString().slice(-2);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const monthNames = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
Â  Â  Â  Â  Â  Â  const month = monthNames[date.getMonth()];

Â  Â  Â  Â  Â  Â  return `${day}-${month}-${year}`;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  // --- AUTH FUNCTIONS (Modified) ---

Â  Â  Â  Â  function toggleSignupMode() {
Â  Â  Â  Â  Â  Â  const container = document.getElementById('authContainer');
Â  Â  Â  Â  Â  Â  const toggleBtn = document.getElementById('signupToggleBtn');
Â  Â  Â  Â  Â  Â  const loginBtn = document.getElementById('loginBtn');
Â  Â  Â  Â  Â  Â  const isSignupMode = container.classList.contains('signup-mode');

Â  Â  Â  Â  Â  Â  if (isSignupMode) {
Â  Â  Â  Â  Â  Â  Â  Â  container.classList.remove('signup-mode');
Â  Â  Â  Â  Â  Â  Â  Â  toggleBtn.textContent = 'Sign Up';
Â  Â  Â  Â  Â  Â  Â  Â  toggleBtn.onclick = toggleSignupMode;
Â  Â  Â  Â  Â  Â  Â  Â  loginBtn.onclick = login;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  container.classList.add('signup-mode');
Â  Â  Â  Â  Â  Â  Â  Â  toggleBtn.textContent = 'Register';
Â  Â  Â  Â  Â  Â  Â  Â  toggleBtn.onclick = signup;
Â  Â  Â  Â  Â  Â  Â  Â  loginBtn.onclick = () => { container.classList.remove('signup-mode'); login(); };
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  document.getElementById('authError').textContent = '';
            setupRecaptcha();
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  async function signup() {
Â  Â  Â  Â  Â  Â  const name = document.getElementById('name').value;
Â  Â  Â  Â  Â  Â  const email = document.getElementById('email').value;
Â  Â  Â  Â  Â  Â  const password = document.getElementById('password').value;
Â  Â  Â  Â  Â  Â  const confirmPassword = document.getElementById('confirmPassword').value;
Â  Â  Â  Â  Â  Â  const errorEl = document.getElementById('authError');
Â  Â  Â  Â  Â  Â  errorEl.textContent = '';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!name || !email || !password || password !== confirmPassword) {
Â  Â  Â  Â  Â  Â  Â  Â  errorEl.textContent = 'Please fill out all fields and ensure passwords match.';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const userCredential = await createUserWithEmailAndPassword(auth, email, password);
Â  Â  Â  Â  Â  Â  Â  Â  await updateProfile(userCredential.user, { displayName: name });
Â  Â  Â  Â  Â  Â  Â  Â  currentUser = userCredential.user;
Â  Â  Â  Â  Â  Â  Â  Â  // The onAuthStateChanged listener will call showApp()
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  errorEl.textContent = 'Signup failed: ' + error.message;
                setupRecaptcha();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function logout() {
Â  Â  Â  Â  Â  Â  signOut(auth).catch((error) => {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Logout error:", error);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
        
        // --- LOGIN & MFA FUNCTIONS (Corrected) ---

Â  Â  Â  Â  async function login() {
Â  Â  Â  Â  Â  Â  const email = document.getElementById('email').value;
Â  Â  Â  Â  Â  Â  const password = document.getElementById('password').value;
Â  Â  Â  Â  Â  Â  const errorEl = document.getElementById('authError');
Â  Â  Â  Â  Â  Â  errorEl.textContent = '';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!email || !password) { errorEl.textContent = 'Please enter email and password'; return; }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const userCredential = await signInWithEmailAndPassword(auth, email, password);
Â  Â  Â  Â  Â  Â  Â  Â  currentUser = userCredential.user;
Â  Â  Â  Â  Â  Â  Â  Â  showApp(); 

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  if (error.code === 'auth/multi-factor-auth-required') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mfaResolver = error.resolver;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const phoneFactor = mfaResolver.hints[0];Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
                        // Use PhoneAuthProvider to send SMS and resolve reCAPTCHA
                        verificationId = await PhoneAuthProvider.verifyPhoneNumber(
                            phoneFactor.phoneNumber,
                            recaptchaVerifier 
                        );
                        
                        document.getElementById('authContainer').style.display = 'none';
                        document.getElementById('mfaContainer').style.display = 'block';
                        document.getElementById('mfaInstructions').textContent = `Code sent to ${phoneFactor.phoneNumber}. Please enter it below.`;
                        document.getElementById('mfaError').textContent = '';
                        
                    } catch (recaptchaError) {
                        console.error("MFA SMS send failed:", recaptchaError);
                        errorEl.textContent = 'Verification failed. Please retry login.';
                        setupRecaptcha();
                    }
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  errorEl.textContent = 'Login failed: ' + error.message;
                    setupRecaptcha();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  async function resolveMfaLogin(smsCode) {
Â  Â  Â  Â  Â  Â  const errorEl = document.getElementById('mfaError');
Â  Â  Â  Â  Â  Â  errorEl.textContent = '';
Â  Â  Â  Â  Â  Â  const verifyBtn = document.querySelector('#mfaContainer button');
            
Â  Â  Â  Â  Â  Â  if (!mfaResolver || !verificationId || !smsCode) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  errorEl.textContent = 'Verification process interrupted. Please try logging in again.';
Â  Â  Â  Â  Â  Â  Â  Â  return;Â 
Â  Â  Â  Â  Â  Â  }
            
            verifyBtn.textContent = 'Verifying...';
            verifyBtn.disabled = true;

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const phoneAuthCredential = PhoneAuthProvider.credential(
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  verificationId,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  smsCode
Â  Â  Â  Â  Â  Â  Â  Â  );

Â  Â  Â  Â  Â  Â  Â  Â  const userCredential = await mfaResolver.resolveSignIn(phoneAuthCredential);
Â  Â  Â  Â  Â  Â  Â  Â  currentUser = userCredential.user;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('mfaContainer').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  showApp();

Â  Â  Â  Â  Â  Â  Â  Â  mfaResolver = null;
Â  Â  Â  Â  Â  Â  Â  Â  verificationId = null;
                verifyBtn.textContent = 'Verify and Login';
                verifyBtn.disabled = false;

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("MFA Login Resolution Failed:", error);
Â  Â  Â  Â  Â  Â  Â  Â  errorEl.textContent = "2FA code incorrect or expired. Please check the code and try again.";
                verifyBtn.textContent = 'Verify and Login';
                verifyBtn.disabled = false;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  async function startMfaEnrollment() {
Â  Â  Â  Â  Â  Â  const phoneNumber = document.getElementById('enrollPhoneNumber').value;
Â  Â  Â  Â  Â  Â  const errorEl = document.getElementById('enrollError');
            const enrollBtn = document.querySelector('#enrollMfaContainer button');
            
Â  Â  Â  Â  Â  Â  errorEl.textContent = '';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const phoneRegex = /^\+[1-9]\d{1,14}$/;
Â  Â  Â  Â  Â  Â  if (!phoneNumber || !currentUser || !phoneRegex.test(phoneNumber)) {
Â  Â  Â  Â  Â  Â  Â  Â  errorEl.textContent = 'Please enter a valid phone number, including country code (e.g., +15551234567).';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

            enrollBtn.textContent = 'Sending...';
            enrollBtn.disabled = true;

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  enrollmentSession = await multiFactor(currentUser).startEnrollment(
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { phoneNumber: phoneNumber },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  recaptchaVerifier
Â  Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('enrollMfaContainer').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('mfaContainer').style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('mfaInstructions').textContent = `Verification code sent to ${phoneNumber}. Please enter it to complete security setup.`;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  enrollBtn.textContent = 'Send Verification Code';
                enrollBtn.disabled = false;

Â  Â  Â  Â  Â  Â  Â  Â  document.querySelector('#mfaContainer button').onclick = () => completeMfaEnrollment(document.getElementById('mfaSmsCode').value);

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("MFA Enrollment Failed:", error);
Â  Â  Â  Â  Â  Â  Â  Â  errorEl.textContent = "Failed to send code: " + error.message;
                enrollBtn.textContent = 'Send Verification Code';
                enrollBtn.disabled = false;
                setupRecaptcha();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  async function completeMfaEnrollment(smsCode) {
Â  Â  Â  Â  Â  Â  const errorEl = document.getElementById('mfaError');
Â  Â  Â  Â  Â  Â  const verifyBtn = document.querySelector('#mfaContainer button');
Â  Â  Â  Â  Â  Â  errorEl.textContent = '';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!enrollmentSession || !smsCode) {
Â  Â  Â  Â  Â  Â  Â  Â  errorEl.textContent = 'Verification process interrupted. Please try again.';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  verifyBtn.textContent = 'Verifying...';
Â  Â  Â  Â  Â  Â  verifyBtn.disabled = true;

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const phoneAuthCredential = PhoneAuthProvider.credential(
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  enrollmentSession.verificationId, 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  smsCode
Â  Â  Â  Â  Â  Â  Â  Â  );

Â  Â  Â  Â  Â  Â  Â  Â  await multiFactor(currentUser).enroll(phoneAuthCredential);

Â  Â  Â  Â  Â  Â  Â  Â  enrollmentSession = null;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('mfaSmsCode').value = '';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  verifyBtn.onclick = () => resolveMfaLogin(document.getElementById('mfaSmsCode').value);
Â  Â  Â  Â  Â  Â  Â  Â  verifyBtn.textContent = 'Verify and Login';
Â  Â  Â  Â  Â  Â  Â  Â  verifyBtn.disabled = false;

Â  Â  Â  Â  Â  Â  Â  Â  showApp();

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("MFA Enrollment Completion Failed:", error);
Â  Â  Â  Â  Â  Â  Â  Â  errorEl.textContent = "2FA code incorrect or expired. Please check the code and try again.";
Â  Â  Â  Â  Â  Â  Â  Â  verifyBtn.textContent = 'Verify and Login';
Â  Â  Â  Â  Â  Â  Â  Â  verifyBtn.disabled = false;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
        
        // --- CORE UI/AUTH MANAGEMENT ---

        function showApp() {
            if (!currentUser) {
                document.getElementById('authContainer').style.display = 'block';
                document.getElementById('appContainer').style.display = 'none';
                return;
            }
            
            const isMfaEnrolled = currentUser.multiFactor.enrolledFactors.length > 0;

            if (!isMfaEnrolled) {
                document.getElementById('authContainer').style.display = 'none';
                document.getElementById('appContainer').style.display = 'none';
                document.getElementById('mfaContainer').style.display = 'none';
                document.getElementById('enrollMfaContainer').style.display = 'block'; 
                
                setupRecaptcha(); 
                return; 
            }

            document.getElementById('userEmail').textContent = currentUser.email;
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('enrollMfaContainer').style.display = 'none';
            document.getElementById('mfaContainer').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            
            loadReadings(currentUser.uid); 
        }

Â  Â  Â  Â  onAuthStateChanged(auth, (user) => {
Â  Â  Â  Â  Â  Â  currentUser = user;
Â  Â  Â  Â  Â  Â  if (user) {
Â  Â  Â  Â  Â  Â  Â  Â  showApp(); 
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('authContainer').style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('appContainer').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('enrollMfaContainer').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('mfaContainer').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  setupRecaptcha(); 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

        // --- DATA MANAGEMENT FUNCTIONS (Fully Implemented) ---

        function clearForm() {
            document.getElementById('personSelect').value = '';
            document.getElementById('personCustomInput').value = '';
            document.getElementById('personCustomInput').style.display = 'none';
            document.getElementById('systole').value = '';
            document.getElementById('diastole').value = '';
            document.getElementById('glucose').value = '';
            document.getElementById('weight').value = '';
            document.getElementById('readingIdToEdit').value = '';
            
            document.getElementById('addButton').style.display = 'inline-block';
            document.getElementById('updateButton').style.display = 'none';

            const now = new Date();
            document.getElementById('recordDate').value = now.toISOString().split('T')[0];
            document.getElementById('recordTime').value = now.toTimeString().split(' ')[0].substring(0, 5);
        }

        function populatePersonSelect() {
            const selectEl = document.getElementById('personSelect');
            const selectedValue = selectEl.value;
            selectEl.innerHTML = '<option value="" disabled selected>Select a person...</option><option value="Custom">Add New Person...</option>';
            
            personNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                selectEl.appendChild(option);
            });

            // Attempt to restore selection
            if (personNames.has(selectedValue) || selectedValue === 'Custom') {
                selectEl.value = selectedValue;
            } else if (currentPerson && personNames.has(currentPerson)) {
                 selectEl.value = currentPerson;
            } else {
                 selectEl.value = '';
            }
            
            handlePersonChange(selectEl.value);
        }

        function handlePersonChange(value) {
            const customInput = document.getElementById('personCustomInput');
            if (value === 'Custom') {
                customInput.style.display = 'block';
                customInput.focus();
            } else {
                customInput.style.display = 'none';
                currentPerson = value;
            }
        }

        function handleCustomNameBlur(value) {
            const selectEl = document.getElementById('personSelect');
            if (value && value.trim()) {
                const normalizedName = value.trim();
                personNames.add(normalizedName);
                currentPerson = normalizedName;
                populatePersonSelect();
                selectEl.value = normalizedName;
                document.getElementById('personCustomInput').style.display = 'none';
            } else {
                selectEl.value = ''; // Force selection back to default
                document.getElementById('personCustomInput').style.display = 'none';
            }
        }

        function getReadingData() {
            const readingId = document.getElementById('readingIdToEdit').value;
            const date = document.getElementById('recordDate').value;
            const time = document.getElementById('recordTime').value;
            const systolic = document.getElementById('systole').value;
            const diastolic = document.getElementById('diastole').value;
            const glucose = document.getElementById('glucose').value;
            const weight = document.getElementById('weight').value;
            
            let person = document.getElementById('personSelect').value;
            if (person === 'Custom') {
                person = document.getElementById('personCustomInput').value.trim();
            }

            if (!person || !date || !time) {
                alert("Please select a person, date, and time.");
                return null;
            }
            
            const timestamp = new Date(`${date}T${time}`).getTime();

            return {
                id: readingId || null,
                person: person,
                date: date,
                time: time,
                systolic: systolic ? parseFloat(systolic) : null,
                diastolic: diastolic ? parseFloat(diastolic) : null,
                glucose: glucose ? parseFloat(glucose) : null,
                weight: weight ? parseFloat(weight) : null,
                timestamp: timestamp
            };
        }

        async function addReading() {
            const data = getReadingData();
            if (!data) return;

            const newReadingRef = push(ref(db, `readings/${currentUser.uid}`));
            await set(newReadingRef, {
                ...data,
                id: newReadingRef.key // Store the key inside the object
            });

            personNames.add(data.person);
            clearForm();
            alert("Reading added successfully!");
        }

        function editReading(id) {
            const reading = allReadings.find(r => r.id === id);
            if (!reading) return;

            // Populate form
            document.getElementById('readingIdToEdit').value = id;
            document.getElementById('recordDate').value = reading.date;
            document.getElementById('recordTime').value = reading.time;
            document.getElementById('systole').value = reading.systolic || '';
            document.getElementById('diastole').value = reading.diastolic || '';
            document.getElementById('glucose').value = reading.glucose || '';
            document.getElementById('weight').value = reading.weight || '';
            
            // Set person
            if (personNames.has(reading.person)) {
                document.getElementById('personSelect').value = reading.person;
                document.getElementById('personCustomInput').style.display = 'none';
            } else {
                // Should not happen if data is clean, but safe fallback
                document.getElementById('personSelect').value = 'Custom';
                document.getElementById('personCustomInput').value = reading.person;
                document.getElementById('personCustomInput').style.display = 'block';
            }

            // Toggle buttons
            document.getElementById('addButton').style.display = 'none';
            document.getElementById('updateButton').style.display = 'inline-block';
        }

        async function updateReading() {
            const data = getReadingData();
            if (!data || !data.id) return;

            const readingRef = ref(db, `readings/${currentUser.uid}/${data.id}`);
            await update(readingRef, data);

            personNames.add(data.person);
            clearForm();
            alert("Reading updated successfully!");
        }

        async function deleteReading(id) {
            if (confirm("Are you sure you want to delete this reading?")) {
                const readingRef = ref(db, `readings/${currentUser.uid}/${id}`);
                await remove(readingRef);
                // loadReadings will handle UI refresh
            }
        }

        // --- DATA LOADING & RENDERING ---

        function loadReadings(userId) {
            const readingsRef = ref(db, `readings/${userId}`);
            onValue(readingsRef, (snapshot) => {
                allReadings = [];
                personNames.clear();

                snapshot.forEach((childSnapshot) => {
                    const reading = childSnapshot.val();
                    // Ensure the ID is present
                    if (!reading.id) {
                        reading.id = childSnapshot.key;
                        // Optional: Write back the ID to the DB to ensure data integrity
                        // update(childSnapshot.ref, { id: reading.id });
                    }
                    allReadings.push(reading);
                    if (reading.person) {
                        personNames.add(reading.person);
                    }
                });
                
                // Sort readings by timestamp (most recent first)
                allReadings.sort((a, b) => b.timestamp - a.timestamp);

                populatePersonSelect();
                renderTodayReadings();
                renderDetailedHistory();
                renderOverallAverages();
            });
        }

        function renderTodayReadings() {
            const container = document.getElementById('todayAveragesContainer');
            const todayReadings = allReadings.filter(r => r.date === todayDateString);
            
            if (todayReadings.length === 0) {
                container.innerHTML = `<h2>â˜€ï¸ Today's Individual Readings</h2><p class="no-data">No readings recorded today.</p>`;
                return;
            }

            let html = `<h2>â˜€ï¸ Today's Individual Readings</h2>
                        <table class="data-table">
                        <thead>
                            <tr><th rowspan="2">Time</th>`;
            
            // Generate header rows
            const uniqueTodayPeople = Array.from(new Set(todayReadings.map(r => r.person)));
            uniqueTodayPeople.forEach(p => {
                html += `<th colspan="4" class="person-header">${p}</th>`;
            });
            html += `</tr><tr>`;
            uniqueTodayPeople.forEach(() => {
                html += `<th>BP</th><th>Glucose</th><th>Weight</th><th>Action</th>`;
            });
            html += `</tr></thead><tbody>`;

            // Group by time, then map people to that time slot
            const readingsByTime = todayReadings.reduce((acc, r) => {
                acc[r.time] = acc[r.time] || {};
                acc[r.time][r.person] = r;
                return acc;
            }, {});

            // Sort times chronologically
            const sortedTimes = Object.keys(readingsByTime).sort();

            sortedTimes.forEach(time => {
                html += `<tr><th scope="row" data-label="Time">${time}</th>`;
                uniqueTodayPeople.forEach(person => {
                    const reading = readingsByTime[time][person];
                    if (reading) {
                        const bp = reading.systolic && reading.diastolic ? `${reading.systolic}/${reading.diastolic}` : '<span class="no-data">--/--</span>';
                        const glucose = reading.glucose ? `${reading.glucose}` : '<span class="no-data">--</span>';
                        const weight = reading.weight ? `${reading.weight}` : '<span class="no-data">--</span>';
                        html += `
                            <td data-label="BP" data-person="${person}" class="detail-reading avg-bp">${bp}</td>
                            <td data-label="Glucose (mg/dL)" data-person="${person}" class="detail-reading">${glucose}</td>
                            <td data-label="Weight (kg/lbs)" data-person="${person}" class="detail-reading">${weight}</td>
                            <td data-label="Action" data-person="${person}">
                                <button class="action-btn edit-btn" onclick="editReading('${reading.id}')">Edit</button>
                                <button class="action-btn" onclick="deleteReading('${reading.id}')">Del</button>
                            </td>
                        `;
                    } else {
                        html += `<td colspan="4" class="no-data">N/A</td>`;
                    }
                });
                html += `</tr>`;
            });

            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        function renderDetailedHistory() {
            const container = document.getElementById('detailedHistoryContainer');
            const uniquePeople = Array.from(personNames);
            
            // Filter and find the latest reading per person per day (last 30 days)
            const thirtyDaysAgo = today.getTime() - (30 * 24 * 60 * 60 * 1000);
            const filteredReadings = allReadings.filter(r => r.timestamp >= thirtyDaysAgo);

            // Group by Date -> Person -> Latest Reading
            const dailyLatestReadings = filteredReadings.reduce((acc, reading) => {
                const dateKey = reading.date;
                const personKey = reading.person;
                
                if (!acc[dateKey]) acc[dateKey] = {};
                
                // Only keep the latest reading for this person on this day
                if (!acc[dateKey][personKey] || reading.timestamp > acc[dateKey][personKey].timestamp) {
                    acc[dateKey][personKey] = reading;
                }
                return acc;
            }, {});

            if (Object.keys(dailyLatestReadings).length === 0) {
                container.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2>ğŸ“… Detailed 30-Day Reading History (Latest Reading/Day)</h2>
                    <button class="table-export-btn" onclick="exportDetailedHistory()">â¬‡ï¸ Download Table (CSV)</button>
                    </div>
                    <p style="text-align: center; font-style: italic; color: #555;">Showing the **latest recorded reading** for each person on a given day across the last 30 days. For a full export, please use the download button above.</p>
                    <p class="no-data" style="text-align:center;">No recent reading history found.</p>`;
                return;
            }

            // Sort dates descending
            const sortedDates = Object.keys(dailyLatestReadings).sort().reverse();
            
            // Generate Detailed History Table
            let html = `<div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2>ğŸ“… Detailed 30-Day Reading History (Latest Reading/Day)</h2>
                    <button class="table-export-btn" onclick="exportDetailedHistory()">â¬‡ï¸ Download Table (CSV)</button>
                    </div>
                    <p style="text-align: center; font-style: italic; color: #555;">Showing the **latest recorded reading** for each person on a given day across the last 30 days. For a full export, please use the download button above.</p>
                    <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr><th rowspan="2">Date</th>`;
            
            uniquePeople.forEach(p => {
                html += `<th colspan="3">${p}</th>`;
            });
            html += `</tr><tr>`;
            uniquePeople.forEach(() => {
                html += `<th>BP</th><th>Glucose</th><th>Weight</th>`;
            });
            html += `</tr></thead><tbody>`;

            detailedHistoryDataCache = {}; // Reset cache for export

            sortedDates.forEach(date => {
                html += `<tr><th scope="row">${formatDate(date)}</th>`;
                detailedHistoryDataCache[date] = { date: formatDate(date) }; // Store data for export

                uniquePeople.forEach(person => {
                    const reading = dailyLatestReadings[date][person];
                    const bp = reading && reading.systolic && reading.diastolic ? `${reading.systolic}/${reading.diastolic}` : '<span class="no-data">--/--</span>';
                    const glucose = reading && reading.glucose !== null ? `${reading.glucose}` : '<span class="no-data">--</span>';
                    const weight = reading && reading.weight !== null ? `${reading.weight}` : '<span class="no-data">--</span>';
                    
                    html += `<td data-label="${person} BP">${bp}</td>`;
                    html += `<td data-label="${person} Glucose">${glucose}</td>`;
                    html += `<td data-label="${person} Weight">${weight}</td>`;

                    // Store data for export
                    detailedHistoryDataCache[date][`${person} BP`] = reading && reading.systolic && reading.diastolic ? `${reading.systolic}/${reading.diastolic}` : '';
                    detailedHistoryDataCache[date][`${person} Glucose`] = reading && reading.glucose !== null ? reading.glucose : '';
                    detailedHistoryDataCache[date][`${person} Weight`] = reading && reading.weight !== null ? reading.weight : '';
                });
                html += `</tr>`;
            });

            html += `</tbody></table></div>`;
            container.innerHTML = html;
        }


        function renderOverallAverages() {
            const container = document.getElementById('overallAveragesContainer');
            allPersonAveragesCache = {}; // Reset cache

            if (allReadings.length === 0) {
                container.innerHTML = `<h2>ğŸ“ˆ Overall Averages Summary</h2><p class="no-data">No data to calculate averages.</p>`;
                return;
            }

            // Calculate averages grouped by person
            const averages = Array.from(personNames).map(person => {
                const personReadings = allReadings.filter(r => r.person === person);
                
                const bpSum = personReadings.reduce((sum, r) => sum + (r.systolic || 0) + (r.diastolic || 0), 0);
                const bpCount = personReadings.filter(r => r.systolic && r.diastolic).length;
                
                const glucoseSum = personReadings.reduce((sum, r) => sum + (r.glucose || 0), 0);
                const glucoseCount = personReadings.filter(r => r.glucose).length;

                const weightSum = personReadings.reduce((sum, r) => sum + (r.weight || 0), 0);
                const weightCount = personReadings.filter(r => r.weight).length;

                const avgSystolic = bpCount > 0 ? (personReadings.reduce((sum, r) => sum + (r.systolic || 0), 0) / bpCount).toFixed(0) : '--';
                const avgDiastolic = bpCount > 0 ? (personReadings.reduce((sum, r) => sum + (r.diastolic || 0), 0) / bpCount).toFixed(0) : '--';
                const avgGlucose = glucoseCount > 0 ? (glucoseSum / glucoseCount).toFixed(1) : '--';
                const avgWeight = weightCount > 0 ? (weightSum / weightCount).toFixed(1) : '--';

                const totalReadings = personReadings.length;

                allPersonAveragesCache[person] = {
                    Person: person,
                    'BP Readings': bpCount,
                    'Avg Systolic': avgSystolic,
                    'Avg Diastolic': avgDiastolic,
                    'Glucose Readings': glucoseCount,
                    'Avg Glucose (mg/dL)': avgGlucose,
                    'Weight Readings': weightCount,
                    'Avg Weight': avgWeight,
                    'Total Records': totalReadings
                };

                return {
                    person,
                    avgSystolic,
                    avgDiastolic,
                    avgGlucose,
                    avgWeight,
                    totalReadings
                };
            });


            let html = `<div style="display:flex; justify-content:space-between; align-items:center;">
                        <h2>ğŸ“ˆ Overall Averages Summary</h2>
                        <button class="table-export-btn" onclick="exportOverallAverages()">â¬‡ï¸ Download Table (CSV)</button>
                        </div>
                        <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Person</th>
                                    <th>Total Readings</th>
                                    <th>Avg. BP (Sys/Dia)</th>
                                    <th>Avg. Glucose (mg/dL)</th>
                                    <th>Avg. Weight</th>
                                </tr>
                            </thead>
                            <tbody>`;

            averages.forEach(avg => {
                const bpText = avg.avgSystolic !== '--' ? `<span class="avg-bp">${avg.avgSystolic}/${avg.avgDiastolic}</span>` : '<span class="no-data">N/A</span>';
                const glucoseText = avg.avgGlucose !== '--' ? `<span class="avg-reading">${avg.avgGlucose}</span>` : '<span class="no-data">N/A</span>';
                const weightText = avg.avgWeight !== '--' ? `<span class="avg-reading">${avg.avgWeight}</span>` : '<span class="no-data">N/A</span>';

                html += `<tr>
                            <td data-label="Person">${avg.person}</td>
                            <td data-label="Total Readings">${avg.totalReadings}</td>
                            <td data-label="Avg. BP">${bpText}</td>
                            <td data-label="Avg. Glucose">${glucoseText}</td>
                            <td data-label="Avg. Weight">${weightText}</td>
                        </tr>`;
            });

            html += `</tbody></table></div>`;
            container.innerHTML = html;
        }

        // --- EXPORT FUNCTIONS (Fully Implemented) ---

        function downloadCSV(data, filename) {
            const csvData = data.map(row => 
                Object.values(row).map(value => {
                    // Escape double quotes by doubling them, then enclose in double quotes
                    const escapedValue = String(value).replace(/"/g, '""');
                    return `"${escapedValue}"`;
                }).join(',')
            ).join('\n');
            
            const header = Object.keys(data[0]).map(h => `"${h}"`).join(',') + '\n';
            const fullCSV = header + csvData;

            const blob = new Blob([fullCSV], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportFullHistory() {
            if (allReadings.length === 0) {
                alert("No data to export.");
                return;
            }
            
            // Map data to a flat structure suitable for CSV
            const exportData = allReadings.map(r => ({
                Date: formatDate(r.date),
                Time: r.time,
                Person: r.person,
                'Systolic (BP)': r.systolic || '',
                'Diastolic (BP)': r.diastolic || '',
                'Glucose (mg/dL)': r.glucose || '',
                'Weight (kg/lbs)': r.weight || '',
                Timestamp_ms: r.timestamp
            }));

            downloadCSV(exportData, 'health_tracker_full_history.csv');
        }

        function exportDetailedHistory() {
             if (Object.keys(detailedHistoryDataCache).length === 0) {
                alert("No 30-day history data to export. Please add some readings.");
                return;
            }

            const exportArray = Object.values(detailedHistoryDataCache);
            downloadCSV(exportArray, 'health_tracker_30day_summary.csv');
        }

        function exportOverallAverages() {
             if (Object.keys(allPersonAveragesCache).length === 0) {
                alert("No data to calculate averages for export.");
                return;
            }
            
            const exportArray = Object.values(allPersonAveragesCache);
            downloadCSV(exportArray, 'health_tracker_overall_averages.csv');
        }
Â  Â  </script>
</body>
</html>
