<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>Holistic Health Tracker (BP/Glucose)</title>
Â  Â  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>â¤ï¸</text></svg>">
Â  Â  <style>
Â  Â  Â  Â  /* Global & Reset */
Â  Â  Â  Â  * {
Â  Â  Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  }

Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  font-family: Arial, sans-serif;
Â  Â  Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  Â  Â  max-width: 1200px;Â 
Â  Â  Â  Â  Â  Â  margin: 0 auto;
Â  Â  Â  Â  Â  Â  background-color: #f7f9fc;
Â  Â  Â  Â  }

Â  Â  Â  Â  h1 {
Â  Â  Â  Â  Â  Â  color: #1a4f78;
Â  Â  Â  Â  Â  Â  border-bottom: 2px solid #e0e0e0;
Â  Â  Â  Â  Â  Â  padding-bottom: 10px;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Controls and Inputs */
Â  Â  Â  Â  .controls {
Â  Â  Â  Â  Â  Â  background: white;
Â  Â  Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
Â  Â  Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .controls label {
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  display: block;
Â  Â  Â  Â  Â  Â  margin-top: 5px;
Â  Â  Â  Â  Â  Â  color: #555;
Â  Â  Â  Â  Â  Â  margin-bottom: 5px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .controls input[type="date"],
Â  Â  Â  Â  .controls input[type="time"],
Â  Â  Â  Â  .controls input[type="number"],
Â  Â  Â  Â  .controls input[type="text"],
Â  Â  Â  Â  .controls select,
Â  Â  Â  Â  #personSelect {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  Â  Â  Â  border-radius: 4px;
Â  Â  Â  Â  Â  Â  font-size: 16px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .input-group {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* GRID FIXES for Alignment */
Â  Â  Â  Â  .input-grid {
Â  Â  Â  Â  Â  Â  display: grid;
Â  Â  Â  Â  Â  Â  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
Â  Â  Â  Â  Â  Â  gap: 20px;
Â  Â  Â  Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  Â  Â  Â  align-items: start;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Person Input Group Styling */
Â  Â  Â  Â  .person-input-group {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  gap: 5px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  #personCustomInput {
Â  Â  Â  Â  Â  Â  margin-top: 0;
Â  Â  Â  Â  Â  Â  display: none;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Buttons */
Â  Â  Â  Â  button {
Â  Â  Â  Â  Â  Â  padding: 10px 20px;
Â  Â  Â  Â  Â  Â  margin-top: 10px;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  font-size: 16px;
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  border-radius: 4px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .add {
Â  Â  Â  Â  Â  Â  background: #4CAF50;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .update {
Â  Â  Â  Â  Â  Â  background: #FF9800; /* Orange for Update */
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  display: none; /* Hidden by default */
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* New Table Download Button Style */
Â  Â  Â  Â  .table-export-btn {
Â  Â  Â  Â  Â  Â  background: #2196F3; /* Light Blue for table export */
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  padding: 8px 15px;
Â  Â  Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  Â  Â  margin-top: 10px;
Â  Â  Â  Â  Â  Â  float: right;
Â  Â  Â  Â  Â  Â  white-space: nowrap;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .export-btn {
Â  Â  Â  Â  Â  Â  background: #007bff; /* Blue for full export */
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  margin-top: 15px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .logout-btn {
Â  Â  Â  Â  Â  Â  background: #f44336;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  padding: 5px 15px;
Â  Â  Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* --- TABLES STYLES (Applies to all new tables) --- */
Â  Â  Â  Â  #overallAveragesContainer, #todayAveragesContainer, #detailedHistoryContainer {
Â  Â  Â  Â  Â  Â  margin-top: 30px;
Â  Â  Â  Â  Â  Â  padding: 15px;
Â  Â  Â  Â  Â  Â  background: white;
Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
Â  Â  Â  Â  Â  Â  /* Remove overflow-x: auto; here to force responsive behavior */
Â  Â  Â  Â  }

Â  Â  Â  Â  .data-table {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  min-width: 0; /* Important for mobile wrap */
Â  Â  Â  Â  Â  Â  border-collapse: collapse;
Â  Â  Â  Â  Â  Â  margin-top: 15px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .data-table th, .data-table td {
Â  Â  Â  Â  Â  Â  padding: 12px 10px;
Â  Â  Â  Â  Â  Â  border: 1px solid #eee;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  font-size: 0.9em;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .data-table thead th {
Â  Â  Â  Â  Â  Â  background-color: #1a4f78;Â 
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  white-space: nowrap;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .data-table thead tr:nth-child(2) th {
Â  Â  Â  Â  Â  Â  background-color: #007bff; /* Blue secondary header */
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  }

Â  Â  Â  Â  .data-table tbody th {
Â  Â  Â  Â  Â  Â  text-align: left;
Â  Â  Â  Â  Â  Â  background-color: #f0f8ff;Â 
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  }

Â  Â  Â  Â  .data-table tr:nth-child(even) {
Â  Â  Â  Â  Â  Â  background-color: #f7f9fc;
Â  Â  Â  Â  }

Â  Â  Â  Â  .avg-bp, .avg-reading {
Â  Â  Â  Â  Â  Â  white-space: nowrap;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .no-data {
Â  Â  Â  Â  Â  Â  color: #999;
Â  Â  Â  Â  Â  Â  font-style: italic;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Increased font size for Today's individual readings */
Â  Â  Â  Â  #todayAveragesContainer .detail-reading {
Â  Â  Â  Â  Â  Â  font-size: 1.0em;Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Auth Styles */
Â  Â  Â  Â  #authContainer {
Â  Â  Â  Â  Â  Â  max-width:400px; margin:50px auto; padding:30px; background:#f9f9f9; border-radius:10px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .signup-fields { display: none; }
Â  Â  Â  Â  #authContainer.signup-mode .signup-fields { display: block; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* New MFA Styles */
Â  Â  Â  Â  #mfaContainer {
Â  Â  Â  Â  Â  Â  max-width:400px; margin:50px auto; padding:30px; background:#f9f9f9; border-radius:10px;
Â  Â  Â  Â  Â  Â  display: none; /* Hidden by default */
Â  Â  Â  Â  }
Â  Â  Â  Â  /* NEW ENROLLMENT STYLES */
Â  Â  Â  Â  #enrollMfaContainer {
Â  Â  Â  Â  Â  Â  max-width:400px; margin:50px auto; padding:30px; background:#fff3e0; border-radius:10px;
Â  Â  Â  Â  Â  Â  display: none; /* Hidden by default */
Â  Â  Â  Â  }
Â  Â  Â  Â  /* ----------------------- */
Â  Â  Â  Â  #recaptcha-container {
Â  Â  Â  Â  Â  Â  /* Hide the reCAPTCHA box if using 'invisible' size */
Â  Â  Â  Â  Â  Â  margin-top: 10px;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Navigation Link Style */
Â  Â  Â  Â  .nav-link {
Â  Â  Â  Â  Â  Â  text-decoration: none;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  margin-left: 15px;
Â  Â  Â  Â  Â  Â  padding: 8px 12px;
Â  Â  Â  Â  Â  Â  border-radius: 4px;
Â  Â  Â  Â  Â  Â  background: #2196F3;
Â  Â  Â  Â  Â  Â  transition: background 0.2s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .nav-link:hover {
Â  Â  Â  Â  Â  Â  background: #0d47a1;
Â  Â  Â  Â  }
Â  Â  Â  Â  /* Action Buttons within Tables */
Â  Â  Â  Â  .action-btn {
Â  Â  Â  Â  Â  Â  background-color: #f44336;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  padding: 3px 6px;
Â  Â  Â  Â  Â  Â  border-radius: 3px;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  font-size: 0.8em;
Â  Â  Â  Â  Â  Â  margin-left: 5px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .edit-btn {
Â  Â  Â  Â  Â  Â  background-color: #4CAF50; /* Green for Edit */
Â  Â  Â  Â  }
Â  Â  Â  Â  .action-btn:hover {
Â  Â  Â  Â  Â  Â  opacity: 0.8;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* --- MOBILE RESPONSIVENESS: CARD/LIST VIEW --- */
Â  Â  Â  Â  @media screen and (max-width: 768px) {
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  /* General Layout Adjustments */
Â  Â  Â  Â  Â  Â  body { padding: 10px; }
Â  Â  Â  Â  Â  Â  .input-grid { grid-template-columns: 1fr; } /* Stack input fields */

Â  Â  Â  Â  Â  Â  /* Table Wrapper - Ensure tables don't force a scroll */
Â  Â  Â  Â  Â  Â  #overallAveragesContainer, #detailedHistoryContainer {
Â  Â  Â  Â  Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  /* Hiding Headers and Reformatting */
Â  Â  Â  Â  Â  Â  .data-table {
Â  Â  Â  Â  Â  Â  Â  Â  border: 0;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  .data-table thead, .data-table thead tr {
Â  Â  Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  Â  Â  width: 1px;
Â  Â  Â  Â  Â  Â  Â  Â  height: 1px;
Â  Â  Â  Â  Â  Â  Â  Â  padding: 0;
Â  Â  Â  Â  Â  Â  Â  Â  margin: -1px;
Â  Â  Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  Â  Â  Â  Â  clip: rect(0, 0, 0, 0);
Â  Â  Â  Â  Â  Â  Â  Â  border: 0;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  /* Transform rows into cards */
Â  Â  Â  Â  Â  Â  .data-table tr {
Â  Â  Â  Â  Â  Â  Â  Â  display: block;
Â  Â  Â  Â  Â  Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  Â  Â  Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  Â  Â  Â  Â  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
Â  Â  Â  Â  Â  Â  Â  Â  background-color: #fff;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  /* Treat Person/Date header rows specially */
Â  Â  Â  Â  Â  Â  .data-table tbody th {
Â  Â  Â  Â  Â  Â  Â  Â  display: block;
Â  Â  Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  Â  Â  border-bottom: 1px solid #ccc;
Â  Â  Â  Â  Â  Â  Â  Â  background-color: #1a4f78;
Â  Â  Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 1.1em;
Â  Â  Â  Â  Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  Â  Â  Â  Â  border-radius: 8px 8px 0 0;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  /* Transform cells into block-level elements */
Â  Â  Â  Â  Â  Â  .data-table td {
Â  Â  Â  Â  Â  Â  Â  Â  display: block;
Â  Â  Â  Â  Â  Â  Â  Â  text-align: right;
Â  Â  Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  Â  Â  border-bottom: 1px dotted #ddd;
Â  Â  Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  Â  Â  Â  Â  padding-left: 50%; /* Make room for the pseudo-element label */
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  /* Insert the original header content as a label using data-label attribute */
Â  Â  Â  Â  Â  Â  .data-table td::before {
Â  Â  Â  Â  Â  Â  Â  Â  content: attr(data-label) ":";
Â  Â  Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  Â  Â  left: 10px;
Â  Â  Â  Â  Â  Â  Â  Â  width: 45%;
Â  Â  Â  Â  Â  Â  Â  Â  padding-right: 10px;
Â  Â  Â  Â  Â  Â  Â  Â  white-space: nowrap;
Â  Â  Â  Â  Â  Â  Â  Â  text-align: left;
Â  Â  Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  Â  Â  color: #555;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  .data-table tr:nth-child(even) {
Â  Â  Â  Â  Â  Â  Â  Â  background-color: #fff; /* Reset zebra striping for cards */
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  /* Today's Readings Table Specific adjustments (less severe transformation) */
Â  Â  Â  Â  Â  Â  /* Since the first column is TIME, we'll hide the person header row and stack time/reading */
Â  Â  Â  Â  Â  Â  #todayAveragesContainer .data-table {
Â  Â  Â  Â  Â  Â  Â  Â  Â min-width: unset;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  #todayAveragesContainer .data-table thead tr:nth-child(1) th {
Â  Â  Â  Â  Â  Â  Â  Â  display: none; /* Hide the Time header */
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  #todayAveragesContainer .data-table thead tr:nth-child(2) th {
Â  Â  Â  Â  Â  Â  Â  Â  Â display: none; /* Hide the Person Name headers */
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  #todayAveragesContainer .data-table tbody tr {
Â  Â  Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  Â  Â  box-shadow: none;
Â  Â  Â  Â  Â  Â  Â  Â  margin-bottom: 0;
Â  Â  Â  Â  Â  Â  Â  Â  display: flex; /* Make row a flex container */
Â  Â  Â  Â  Â  Â  Â  Â  flex-wrap: wrap;
Â  Â  Â  Â  Â  Â  Â  Â  border-bottom: 1px solid #e0e0e0;
Â  Â  Â  Â  Â  Â  Â  Â  padding: 10px 0;
Â  Â  Â  Â  Â  Â  Â  Â  background-color: transparent !important;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  #todayAveragesContainer .data-table tbody th {
Â  Â  Â  Â  Â  Â  Â  Â  /* Time column */
Â  Â  Â  Â  Â  Â  Â  Â  flex: 0 0 100%;
Â  Â  Â  Â  Â  Â  Â  Â  text-align: left;
Â  Â  Â  Â  Â  Â  Â  Â  background-color: transparent;
Â  Â  Â  Â  Â  Â  Â  Â  color: #1a4f78;
Â  Â  Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 1.1em;
Â  Â  Â  Â  Â  Â  Â  Â  padding: 5px 10px;
Â  Â  Â  Â  Â  Â  Â  Â  border-bottom: 1px solid #ccc;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  #todayAveragesContainer .data-table tbody td {
Â  Â  Â  Â  Â  Â  Â  Â  /* Reading data cells */
Â  Â  Â  Â  Â  Â  Â  Â  flex: 1 1 50%; /* Allow 2 columns of readings per row */
Â  Â  Â  Â  Â  Â  Â  Â  text-align: left;
Â  Â  Â  Â  Â  Â  Â  Â  padding-left: 10px;
Â  Â  Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  Â  Â  border-bottom: none;
Â  Â  Â  Â  Â  Â  Â  Â  min-width: 50%;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  #todayAveragesContainer .data-table tbody td:before {
Â  Â  Â  Â  Â  Â  Â  Â  content: attr(data-person) ":"; /* Use person name as label */
Â  Â  Â  Â  Â  Â  Â  Â  position: static;
Â  Â  Â  Â  Â  Â  Â  Â  width: auto;
Â  Â  Â  Â  Â  Â  Â  Â  padding-right: 5px;
Â  Â  Â  Â  Â  Â  Â  Â  font-weight: normal;
Â  Â  Â  Â  Â  Â  Â  Â  color: #1a4f78;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  #todayAveragesContainer .detail-reading {
Â  Â  Â  Â  Â  Â  Â  Â  display: block;
Â  Â  Â  Â  Â  Â  Â  Â  line-height: 1.4;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  .action-btn {
Â  Â  Â  Â  Â  Â  Â  Â  margin-top: 5px;
Â  Â  Â  Â  Â  Â  Â  Â  margin-right: 5px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body>
Â  Â  <div id="authContainer" style="display:none;">
Â  Â  Â  Â  <h2>ğŸ”’ Health Tracker Access</h2>
Â  Â  Â  Â  <div style="margin:20px 0;">
Â  Â  Â  Â  Â  Â  <div class="signup-fields">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="name" placeholder="Your Name" style="width:100%; padding:10px; margin:5px 0; box-sizing:border-box;">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <input type="email" id="email" placeholder="Email" style="width:100%; padding:10px; margin:5px 0; box-sizing:border-box;">
Â  Â  Â  Â  Â  Â  <input type="password" id="password" placeholder="Password (min 6 chars)" style="width:100%; padding:10px; margin:5px 0; box-sizing:border-box;">
Â  Â  Â  Â  Â  Â  <div class="signup-fields">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="password" id="confirmPassword" placeholder="Confirm Password" style="width:100%; padding:10px; margin:5px 0; box-sizing:border-box;">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <button class="add" onclick="login()" style="width:48%; margin:2%;" id="loginBtn">Login</button>
Â  Â  Â  Â  <button class="export" onclick="toggleSignupMode()" style="width:48%; margin:2%;" id="signupToggleBtn">Sign Up</button>
Â  Â  Â  Â  <div id="authError" style="color:red; margin-top:10px;"></div>
Â  Â  Â  Â  <div id="recaptcha-container"></div>Â 
Â  Â  </div>
Â  Â Â 
Â  Â  <div id="mfaContainer">
Â  Â  Â  Â  <h2>ğŸ”‘ Two-Factor Verification</h2>
Â  Â  Â  Â  <p id="mfaInstructions" style="color:#555;"></p>
Â  Â  Â  Â  <input type="text" id="mfaSmsCode" placeholder="Enter SMS Code" style="width:100%; padding:10px; margin:10px 0; box-sizing:border-box;">
Â  Â  Â  Â  <button class="add" onclick="resolveMfaLogin(document.getElementById('mfaSmsCode').value)" style="width:100%;">Verify and Login</button>
Â  Â  Â  Â  <div id="mfaError" style="color:red; margin-top:10px;"></div>
Â  Â  </div>

Â  Â  <div id="enrollMfaContainer">
Â  Â  Â  Â  <h2>âš ï¸ Security Setup Required</h2>
Â  Â  Â  Â  <p style="color:#e65100;">For your security, we need to enroll a phone number to enable two-factor verification. This is a one-time setup.</p>
Â  Â  Â  Â  <input type="text" id="enrollPhoneNumber" placeholder="Phone Number (e.g., +15555550100)" style="width:100%; padding:10px; margin:10px 0; box-sizing:border-box;">
Â  Â  Â  Â  <button class="add" onclick="startMfaEnrollment()" style="width:100%; background: #e65100;">Send Verification Code</button>
Â  Â  Â  Â  <div id="enrollError" style="color:red; margin-top:10px;"></div>
Â  Â  </div>
Â  Â  <div id="appContainer" style="display:none;">
Â  Â  Â  Â  <div style="text-align:right; margin-bottom:20px; display:flex; justify-content:flex-end; align-items:center;">
Â  Â  Â  Â  Â  Â  <a href="index.html" class="nav-link">ğŸ’Š Medicine Tracker</a>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <span id="userEmail" style="margin-right:10px; font-weight:bold; margin-left: 15px;"></span>
Â  Â  Â  Â  Â  Â  <button class="logout-btn" onclick="logout()">Logout</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <h1>â¤ï¸ Daily Health Readings</h1>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div class="controls">
Â  Â  Â  Â  Â  Â  <h2>Record a New Reading</h2>
Â  Â  Â  Â  Â  Â  <div class="input-grid">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="hidden" id="readingIdToEdit" value="">
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="recordDate">Date</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="date" id="recordDate">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="recordTime">Time</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="time" id="recordTime">
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="personSelect">Person Name</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="person-input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="personSelect" onchange="handlePersonChange(this.value)">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="" disabled selected>Select a person...</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Custom">Add New Person...</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="personCustomInput" placeholder="Enter new name here" onblur="handleCustomNameBlur(this.value)">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="systole">Systolic (BP)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="systole" placeholder="e.g., 120" step="1">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="diastole">Diastolic (BP)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="diastole" placeholder="e.g., 80" step="1">
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="glucose">Glucose (mg/dL)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="glucose" placeholder="e.g., 100" step="0.1">
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="weight">Weight (kg/lbs)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="weight" placeholder="e.g., 75" step="0.1">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <button class="add" id="addButton" onclick="addReading()">Add Reading</button>
Â  Â  Â  Â  Â  Â  <button class="update" id="updateButton" onclick="updateReading()">Update Reading</button>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <button class="export-btn" onclick="exportFullHistory()">â¬‡ï¸ Download Full History (CSV)</button>

Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div id="todayAveragesContainer">
Â  Â  Â  Â  Â  Â  <h2>â˜€ï¸ Today's Individual Readings</h2>Â 
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="detailedHistoryContainer">
Â  Â  Â  Â  Â  Â  <div style="display:flex; justify-content:space-between; align-items:center;">
Â  Â  Â  Â  Â  Â  Â  Â  <h2>ğŸ“… Detailed 30-Day Reading History (Latest Reading/Day)</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="table-export-btn" onclick="exportDetailedHistory()">â¬‡ï¸ Download Table (CSV)</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <p style="text-align: center; font-style: italic; color: #555;">Showing the **latest recorded reading** for each person on a given day across the last 30 days. For a full export, please use the download button above.</p>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="overallAveragesContainer">
Â  Â  Â  Â  Â  Â  <div style="display:flex; justify-content:space-between; align-items:center;">
Â  Â  Â  Â  Â  Â  Â  Â  <h2>ğŸ“ˆ Overall Averages Summary</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="table-export-btn" onclick="exportOverallAverages()">â¬‡ï¸ Download Table (CSV)</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  </div>

Â  Â  <script type="module">
Â  Â  Â  Â  // Make functions global for inline onclick handlers
Â  Â  Â  Â  window.login = login;
Â  Â  Â  Â  window.signup = signup;
Â  Â  Â  Â  window.logout = logout;
Â  Â  Â  Â  window.toggleSignupMode = toggleSignupMode;Â 
Â  Â  Â  Â  window.handlePersonChange = handlePersonChange;
Â  Â  Â  Â  window.handleCustomNameBlur = handleCustomNameBlur;Â 
Â  Â  Â  Â  window.addReading = addReading;
Â  Â  Â  Â  window.updateReading = updateReading;Â 
Â  Â  Â  Â  window.editReading = editReading;Â  Â 
Â  Â  Â  Â  window.deleteReading = deleteReading;
Â  Â  Â  Â  window.loadReadings = loadReadings;Â 
Â  Â  Â  Â  window.exportFullHistory = exportFullHistory;Â 
Â  Â  Â  Â  window.exportDetailedHistory = exportDetailedHistory;Â 
Â  Â  Â  Â  window.exportOverallAverages = exportOverallAverages;Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- NEW MFA GLOBAL FUNCTIONS ---
Â  Â  Â  Â  window.resolveMfaLogin = resolveMfaLogin;
Â  Â  Â  Â  window.startMfaEnrollment = startMfaEnrollment;
Â  Â  Â  Â  window.completeMfaEnrollment = completeMfaEnrollment;


Â  Â  Â  Â  // Import Firebase modules
Â  Â  Â  Â  import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.21.0/firebase-app.js';
Â  Â  Â  Â  import { getDatabase, ref, set, onValue, push, update, remove } from 'https://www.gstatic.com/firebasejs/9.21.0/firebase-database.js';
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- UPDATED AUTH IMPORTS FOR MFA ---
Â  Â  Â  Â  import {Â 
Â  Â  Â  Â  Â  Â  getAuth,Â 
Â  Â  Â  Â  Â  Â  signInWithEmailAndPassword,Â 
Â  Â  Â  Â  Â  Â  createUserWithEmailAndPassword,Â 
Â  Â  Â  Â  Â  Â  onAuthStateChanged,Â 
Â  Â  Â  Â  Â  Â  signOut,
Â  Â  Â  Â  Â  Â  PhoneAuthProvider, // New
Â  Â  Â  Â  Â  Â  multiFactor // New
Â  Â  Â  Â  } from 'https://www.gstatic.com/firebasejs/9.21.0/firebase-auth.js';
Â  Â  Â  Â  // Need to import the standard namespace for RecaptchaVerifier
Â  Â  Â  Â  import firebase from 'https://www.gstatic.com/firebasejs/9.21.0/firebase-auth-compat.js';Â 


Â  Â  Â  Â  // Your web app's Firebase configuration (CONFIRMED)
Â  Â  Â  Â  const firebaseConfig = {
Â  Â  Â  Â  Â  Â  apiKey: "AIzaSyAjRB8_dLv8icceOyZNNGO9kIXUFVjWfoY",
Â  Â  Â  Â  Â  Â  authDomain: "medicine-tracker-b90f2.firebaseapp.com",
Â  Â  Â  Â  Â  Â  databaseURL: "https://medicine-tracker-b90f2-default-rtdb.firebaseio.com",
Â  Â  Â  Â  Â  Â  projectId: "medicine-tracker-b90f2",
Â  Â  Â  Â  Â  Â  storageBucket: "medicine-tracker-b90f2.firebasestorage.app",
Â  Â  Â  Â  Â  Â  messagingSenderId: "230127910329",
Â  Â  Â  Â  Â  Â  appId: "1:230127910329:web:756789fcd3a1ac02948a68"
Â  Â  Â  Â  };

Â  Â  Â  Â  // Initialize Firebase
Â  Â  Â  Â  const app = initializeApp(firebaseConfig);
Â  Â  Â  Â  const db = getDatabase(app);
Â  Â  Â  Â  const auth = getAuth(app);

Â  Â  Â  Â  let currentUser = null;
Â  Â  Â  Â  let allReadings = [];
Â  Â  Â  Â  let allPersonAveragesCache = {}; // Cache for overall averages
Â  Â  Â  Â  let detailedHistoryDataCache = {}; // Cache for detailed history data
Â  Â  Â  Â  let personNames = new Set();
Â  Â  Â  Â  let currentPerson = '';
Â  Â  Â  Â  const today = new Date();
Â  Â  Â  Â  document.getElementById('recordDate').value = today.toISOString().split('T')[0];
Â  Â  Â  Â  document.getElementById('recordTime').value = today.toTimeString().split(' ')[0].substring(0, 5);Â 
Â  Â  Â  Â  const todayDateString = today.toISOString().split('T')[0];

Â  Â  Â  Â  // --- NEW MFA VARIABLES ---
Â  Â  Â  Â  let recaptchaVerifier = null;
Â  Â  Â  Â  let mfaResolver = null; // Stores the object needed to complete the 2FA login
Â  Â  Â  Â  let verificationId = null; // Stores the ID needed to verify the SMS code
Â  Â  Â  Â  let enrollmentSession = null; // NEW: Stores the session for new enrollment

Â  Â  Â  Â  // --- NEW: Setup Invisible reCAPTCHA ---
Â  Â  Â  Â  function setupRecaptcha() {
Â  Â  Â  Â  Â  Â  if (recaptchaVerifier) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // ReCAPTCHA requires the standard Firebase namespace, which we imported as 'firebase'
Â  Â  Â  Â  Â  Â  recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
Â  Â  Â  Â  Â  Â  Â  Â  'size': 'invisible',Â 
Â  Â  Â  Â  Â  Â  Â  Â  'callback': (response) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // reCAPTCHA solved automatically in invisible mode
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  'expired-callback': () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('authError').textContent = 'reCAPTCHA expired. Please refresh.';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }, auth);

Â  Â  Â  Â  Â  Â  // Render the reCAPTCHA widget
Â  Â  Â  Â  Â  Â  recaptchaVerifier.render();
Â  Â  Â  Â  }


Â  Â  Â  Â  // --- UTILITY: Date Formatting (DD-MMM-YY) ---
Â  Â  Â  Â  function formatDate(dateString) {
Â  Â  Â  Â  Â  Â  if (!dateString) return '';
Â  Â  Â  Â  Â  Â  // Use date only part to prevent timezone shift issues on Date object creation
Â  Â  Â  Â  Â  Â  const date = new Date(dateString + 'T00:00:00');Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const day = date.getDate().toString().padStart(2, '0');
Â  Â  Â  Â  Â  Â  const year = date.getFullYear().toString().slice(-2);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const monthNames = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
Â  Â  Â  Â  Â  Â  const month = monthNames[date.getMonth()];

Â  Â  Â  Â  Â  Â  return `${day}-${month}-${year}`;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- AUTH & SYNC ---
Â  Â  Â  Â  function toggleSignupMode() {
Â  Â  Â  Â  Â  Â  const container = document.getElementById('authContainer');
Â  Â  Â  Â  Â  Â  const toggleBtn = document.getElementById('signupToggleBtn');
Â  Â  Â  Â  Â  Â  const loginBtn = document.getElementById('loginBtn');
Â  Â  Â  Â  Â  Â  const isSignupMode = container.classList.contains('signup-mode');

Â  Â  Â  Â  Â  Â  if (isSignupMode) {
Â  Â  Â  Â  Â  Â  Â  Â  container.classList.remove('signup-mode');
Â  Â  Â  Â  Â  Â  Â  Â  toggleBtn.textContent = 'Sign Up';
Â  Â  Â  Â  Â  Â  Â  Â  toggleBtn.onclick = toggleSignupMode;
Â  Â  Â  Â  Â  Â  Â  Â  loginBtn.onclick = login;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  container.classList.add('signup-mode');
Â  Â  Â  Â  Â  Â  Â  Â  toggleBtn.textContent = 'Register';
Â  Â  Â  Â  Â  Â  Â  Â  toggleBtn.onclick = signup;
Â  Â  Â  Â  Â  Â  Â  Â  loginBtn.onclick = () => { container.classList.remove('signup-mode'); login(); };
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  document.getElementById('authError').textContent = '';
Â  Â  Â  Â  }
Â  Â  Â  Â  
        function signup() {
            // Implementation of signup function (omitted for brevity, assume it uses createUserWithEmailAndPassword)
            document.getElementById('authError').textContent = 'Signup function logic needs to be fully implemented.';
        }
        
        function logout() {
            signOut(auth).catch((error) => {
                console.error("Logout error:", error);
            });
        }

Â  Â  Â  Â  // --- MODIFIED LOGIN FUNCTION FOR MFA HANDLING ---
Â  Â  Â  Â  async function login() {
Â  Â  Â  Â  Â  Â  const email = document.getElementById('email').value;
Â  Â  Â  Â  Â  Â  const password = document.getElementById('password').value;
Â  Â  Â  Â  Â  Â  const errorEl = document.getElementById('authError');
Â  Â  Â  Â  Â  Â  errorEl.textContent = '';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!email || !password) { errorEl.textContent = 'Please enter email and password'; return; }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // 1. Initial Sign-in Attempt
Â  Â  Â  Â  Â  Â  Â  Â  const userCredential = await signInWithEmailAndPassword(auth, email, password);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Success: If no MFA required, proceed normally
Â  Â  Â  Â  Â  Â  Â  Â  currentUser = userCredential.user;
Â  Â  Â  Â  Â  Â  Â  Â  showApp(); // <-- Now checks for enrollment

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // 2. Catch the MultiFactor Auth Exception
Â  Â  Â  Â  Â  Â  Â  Â  if (error.code === 'auth/multi-factor-auth-required') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Step A: Store the resolver object (required to finish login)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mfaResolver = error.resolver;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Get the first available factor (the phone number)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const phoneFactor = mfaResolver.hints[0];Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Step B: Start the second factor verification (sends SMS)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // We only need the phone number string, not the whole credentialWithSession
                    // The PhoneAuthProvider.verifyPhoneNumber call implicitly manages the session
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Step C: Verify the phone number (sends SMS and uses reCAPTCHA)
                    // Note: This usage of verifyPhoneNumber is adapted for the MFA flow
                    // by passing the phone number from the factor hint.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  verificationId = await PhoneAuthProvider.verifyPhoneNumber(
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  phoneFactor.phoneNumber,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  recaptchaVerifierÂ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // UI Change: Hide password container, show MFA container
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('authContainer').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('mfaContainer').style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('mfaInstructions').textContent = `Code sent to ${phoneFactor.phoneNumber}. Please enter it below.`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('mfaError').textContent = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Handle standard login errors (wrong password, etc.)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  errorEl.textContent = 'Login failed: ' + error.message;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- Function to Resolve the MFA Login after SMS Code is Entered ---
Â  Â  Â  Â  async function resolveMfaLogin(smsCode) {
Â  Â  Â  Â  Â  Â  const errorEl = document.getElementById('mfaError');
Â  Â  Â  Â  Â  Â  errorEl.textContent = '';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!mfaResolver || !verificationId || !smsCode) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  errorEl.textContent = 'Verification process interrupted. Please try logging in again.';
Â  Â  Â  Â  Â  Â  Â  Â  return;Â 
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // 1. Create the Phone Auth Credential using the received SMS code
Â  Â  Â  Â  Â  Â  Â  Â  const phoneAuthCredential = PhoneAuthProvider.credential(
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  verificationId,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  smsCode
Â  Â  Â  Â  Â  Â  Â  Â  );

Â  Â  Â  Â  Â  Â  Â  Â  // 2. Resolve the multi-factor sign-in
Â  Â  Â  Â  Â  Â  Â  Â  const userCredential = await mfaResolver.resolveSignIn(phoneAuthCredential);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Success: Finish login
Â  Â  Â  Â  Â  Â  Â  Â  currentUser = userCredential.user;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // UI Change: Hide MFA form, show the main app container
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('mfaContainer').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  showApp();

Â  Â  Â  Â  Â  Â  Â  Â  // Clear temporary state
Â  Â  Â  Â  Â  Â  Â  Â  mfaResolver = null;
Â  Â  Â  Â  Â  Â  Â  Â  verificationId = null;
                document.getElementById('mfaSmsCode').value = '';

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("MFA Login Resolution Failed:", error);
Â  Â  Â  Â  Â  Â  Â  Â  errorEl.textContent = "2FA code incorrect or expired. Please check the code and try again.";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- NEW: START MFA ENROLLMENT (Sends SMS to new number) ---
Â  Â  Â  Â  async function startMfaEnrollment() {
Â  Â  Â  Â  Â  Â  const phoneNumber = document.getElementById('enrollPhoneNumber').value;
Â  Â  Â  Â  Â  Â  const errorEl = document.getElementById('enrollError');
Â  Â  Â  Â  Â  Â  errorEl.textContent = '';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Firebase expects phone numbers to be in E.164 format (e.g., +15551234567)
Â  Â  Â  Â  Â  Â  const phoneRegex = /^\+[1-9]\d{1,14}$/;
Â  Â  Â  Â  Â  Â  if (!phoneNumber || !currentUser || !phoneRegex.test(phoneNumber)) {
Â  Â  Â  Â  Â  Â  Â  Â  errorEl.textContent = 'Please enter a valid phone number, including country code (e.g., +15551234567).';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // 1. Start the MFA enrollment process for the current user
Â  Â  Â  Â  Â  Â  Â  Â  enrollmentSession = await multiFactor(currentUser).startEnrollment(
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  phoneNumber: phoneNumber,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  recaptchaVerifier
Â  Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // 2. UI Change: Hide enrollment form, show MFA code form
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('enrollMfaContainer').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('mfaContainer').style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('mfaInstructions').textContent = `Verification code sent to ${phoneNumber}. Please enter it to complete security setup.`;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Change the button action to the final completion step
Â  Â  Â  Â  Â  Â  Â  Â  document.querySelector('#mfaContainer button').onclick = () => completeMfaEnrollment(document.getElementById('mfaSmsCode').value);

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("MFA Enrollment Failed:", error);
Â  Â  Â  Â  Â  Â  Â  Â  errorEl.textContent = "Failed to send code: " + error.message;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- NEW: COMPLETE MFA ENROLLMENT (Verifies SMS code) ---
Â  Â  Â  Â  async function completeMfaEnrollment(smsCode) {
Â  Â  Â  Â  Â  Â  const errorEl = document.getElementById('mfaError');
Â  Â  Â  Â  Â  Â  errorEl.textContent = '';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!enrollmentSession || !smsCode) {
Â  Â  Â  Â  Â  Â  Â  Â  errorEl.textContent = 'Verification process interrupted. Please try again.';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // 1. Build the Phone Auth Credential using the session and SMS code
Â  Â  Â  Â  Â  Â  Â  Â  const phoneAuthCredential = PhoneAuthProvider.credential(
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  enrollmentSession.verificationId, // Use the verificationId from the session
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  smsCode
Â  Â  Â  Â  Â  Â  Â  Â  );

Â  Â  Â  Â  Â  Â  Â  Â  // 2. Enroll the second factor to the user's account
Â  Â  Â  Â  Â  Â  Â  Â  await multiFactor(currentUser).enroll(phoneAuthCredential);

Â  Â  Â  Â  Â  Â  Â  Â  // Success: The user now has a phone number enrolled.
Â  Â  Â  Â  Â  Â  Â  Â  // Reset the state
Â  Â  Â  Â  Â  Â  Â  Â  enrollmentSession = null;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('mfaSmsCode').value = '';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Restore the MFA button's original login function
Â  Â  Â  Â  Â  Â  Â  Â  document.querySelector('#mfaContainer button').onclick = () => resolveMfaLogin(document.getElementById('mfaSmsCode').value);

Â  Â  Â  Â  Â  Â  Â  Â  // Finally, show the main app
Â  Â  Â  Â  Â  Â  Â  Â  showApp();

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("MFA Enrollment Completion Failed:", error);
Â  Â  Â  Â  Â  Â  Â  Â  errorEl.textContent = "2FA code incorrect or expired. Please check the code and try again.";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
        
        // --- CORE LOGIC: SHOW APP (MODIFIED) ---
        function showApp() {
            if (!currentUser) {
                document.getElementById('authContainer').style.display = 'block';
                document.getElementById('appContainer').style.display = 'none';
                return;
            }
            
            // ** CRITICAL CHECK: Check if the user has enrolled at least one MFA factor **
            const isMfaEnrolled = currentUser.multiFactor.enrolledFactors.length > 0;

            if (!isMfaEnrolled) {
                console.log("User logged in but needs MFA enrollment.");
                
                // Show the enrollment screen and hide everything else
                document.getElementById('authContainer').style.display = 'none';
                document.getElementById('appContainer').style.display = 'none';
                document.getElementById('mfaContainer').style.display = 'none';
                document.getElementById('enrollMfaContainer').style.display = 'block'; 
                
                return; // Stop here, user must enroll
            }

            // User is signed in and MFA is enrolled. Show the main application.
            document.getElementById('userEmail').textContent = currentUser.email;
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('enrollMfaContainer').style.display = 'none';
            document.getElementById('mfaContainer').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            
            // Continue with application data loading (requires implementation of loadReadings, etc.)
            loadReadings(currentUser.uid); 
        }

Â  Â  Â  Â  // --- AUTH STATE LISTENER (MODIFIED) ---
Â  Â  Â  Â  onAuthStateChanged(auth, (user) => {
Â  Â  Â  Â  Â  Â  currentUser = user;
Â  Â  Â  Â  Â  Â  if (user) {
Â  Â  Â  Â  Â  Â  Â  Â  // User is signed in. Run showApp, which will check for MFA enrollment.
Â  Â  Â  Â  Â  Â  Â  Â  showApp(); 
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // User is signed out. Show auth screen.
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('authContainer').style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('appContainer').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('enrollMfaContainer').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('mfaContainer').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  setupRecaptcha(); 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
        
        // --- PLACEHOLDER FUNCTIONS (Require full implementation to be fully functional) ---
        function loadReadings(userId) {
            console.log(`Loading readings for user: ${userId} (Placeholder)`);
            // Full implementation would involve:
            // 1. Fetching data from the Realtime Database using userId.
            // 2. Populating personNames set and currentPerson.
            // 3. Rendering all tables (todayAveragesContainer, detailedHistoryContainer, overallAveragesContainer).
            // 4. Initializing event listeners for table actions (edit, delete).
        }
        
        function handlePersonChange(value) { /* Placeholder */ }
        function handleCustomNameBlur(value) { /* Placeholder */ }
        function addReading() { /* Placeholder */ }
        function updateReading() { /* Placeholder */ }
        function editReading(id) { /* Placeholder */ }
        function deleteReading(id) { /* Placeholder */ }
        function exportFullHistory() { /* Placeholder */ }
        function exportDetailedHistory() { /* Placeholder */ }
        function exportOverallAverages() { /* Placeholder */ }

Â  Â  </script>
</body>
</html>
