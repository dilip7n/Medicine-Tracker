<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Holistic Health Tracker (BP/Glucose)</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚ù§Ô∏è</text></svg>">
    <style>
        /* Global & Reset */
        * {
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            background-color: #f7f9fc;
        }

        h1 {
            color: #1a4f78;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }

        /* Controls and Inputs */
        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }
        
        .controls label {
            font-weight: bold;
            display: block;
            margin-top: 5px;
            color: #555;
            margin-bottom: 5px;
        }
        
        .controls input[type="date"],
        .controls input[type="time"],
        .controls input[type="number"],
        .controls input[type="text"],
        .controls select,
        #personSelect {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            width: 100%;
        }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 15px;
            align-items: start;
        }
        
        .person-input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        #personCustomInput {
            margin-top: 0;
            display: none;
        }

        /* Buttons */
        button {
            padding: 10px 20px;
            margin-top: 10px;
            cursor: pointer;
            font-size: 16px;
            border: none;
            border-radius: 4px;
        }

        .add {
            background: #4CAF50;
            color: white;
        }
        
        .export-btn {
            background: #007bff;
            color: white;
            margin-top: 15px;
        }

        .logout-btn {
            background: #f44336;
            color: white;
            padding: 5px 15px;
            font-size: 14px;
        }

        .delete-btn {
            background: #ff4444;
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
        }
        
        #overallAveragesContainer, #todayAveragesContainer, #detailedHistoryContainer {
            margin-top: 30px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            min-width: 900px;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .data-table th, .data-table td {
            padding: 12px 10px;
            border: 1px solid #eee;
            text-align: center;
            font-size: 0.9em;
        }
        
        .data-table thead th {
            background-color: #1a4f78; 
            color: white;
            font-weight: bold;
            white-space: nowrap;
        }
        
        .data-table thead tr:nth-child(2) th {
            background-color: #007bff;
            color: white;
        }

        .data-table tbody th {
            text-align: left;
            background-color: #f0f8ff; 
            font-weight: bold;
        }

        .data-table tr:nth-child(even) {
            background-color: #f7f9fc;
        }

        .avg-bp, .avg-reading {
            white-space: nowrap;
            font-weight: bold;
        }
        
        .no-data {
            color: #999;
            font-style: italic;
        }
        
        .detail-reading {
            font-size: 0.9em;
        }

        /* Auth Styles */
        #authContainer {
            max-width:400px; margin:50px auto; padding:30px; background:#f9f9f9; border-radius:10px;
        }
        .signup-fields { display: none; }
        #authContainer.signup-mode .signup-fields { display: block; }

        /* MFA Enrollment Styles (New & Responsive, from PDF) */
        #mfaEnrollContainer {
            width: 95vw;
            max-width: 400px;
            margin: 12px auto;
            padding: 18px;
            background: #fff;
            border-radius: 9px;
            box-shadow: 0 5px 16px rgba(0,0,0,0.03);
            border: 2px solid #ffc107; /* Keeping a border for visual distinction */
        }

        @media (max-width: 600px) {
            #mfaEnrollContainer {
                width: 99vw;
                padding: 8px 2vw;
            }
            #recaptcha-enroll {
                min-width: 95vw;
                overflow-x: auto;
            }
        }
        
        .nav-link {
            text-decoration: none;
            color: white;
            font-weight: bold;
            margin-left: 15px;
            padding: 8px 12px;
            border-radius: 4px;
            background: #2196F3;
            transition: background 0.2s;
        }
        .nav-link:hover {
            background: #0d47a1;
        }
    </style>
</head>
<body>
    <div id="authContainer" style="display:none;">
        <h2>üîí Health Tracker Access</h2>
        <div style="margin:20px 0;">
            <div class="signup-fields">
                <input type="text" id="name" placeholder="Your Name" style="width:100%; padding:10px; margin:5px 0; box-sizing:border-box;">
            </div>
            <input type="email" id="email" placeholder="Email" style="width:100%; padding:10px; margin:5px 0; box-sizing:border-box;">
            <input type="password" id="password" placeholder="Password (min 6 chars)" style="width:100%; padding:10px; margin:5px 0; box-sizing:border-box;">
            <div class="signup-fields">
                <input type="password" id="confirmPassword" placeholder="Confirm Password" style="width:100%; padding:10px; margin:5px 0; box-sizing:border-box;">
            </div>
            <div class="signup-fields">
                <input type="tel" id="phoneNumber" placeholder="Phone Number (with country code, e.g., +919876543210)" style="width:100%; padding:10px; margin:5px 0; box-sizing:border-box;">
            </div>
        </div>
        <div id="recaptcha-container-auth" style="display:flex; justify-content:center; margin:10px 0;"></div>
        <button class="add" onclick="login()" style="width:48%; margin:2%;" id="loginBtn">Login</button>
        <button class="export-btn" onclick="toggleSignupMode()" style="width:48%; margin:2%;" id="signupToggleBtn">Sign Up</button>
        <div id="authError" style="color:red; margin-top:10px;"></div>
    </div>

    <div id="mfaVerificationContainer" style="display:none; max-width:400px; margin:50px auto; padding:30px; background:#f9f9f9; border-radius:10px;">
        <h2>üîê Two-Factor Authentication</h2>
        <p style="margin:15px 0;">Enter the 6-digit verification code sent to your phone:</p>
        <input type="text" id="mfaVerificationCode" placeholder="6-digit code" maxlength="6" style="width:100%; padding:10px; margin:10px 0; box-sizing:border-box; font-size:18px; text-align:center; letter-spacing:5px;">
        <button class="add" onclick="verifyMfaCode()" style="width:100%; margin:10px 0;">Verify Code</button>
        <button class="export-btn" onclick="cancelMfaVerification()" style="width:100%;">Cancel</button>
        <div id="mfaError" style="color:red; margin-top:10px;"></div>
    </div>

    <div id="mfaEnrollContainer" style="display:none;">
        <h2>üì± Enable Two-Factor Authentication</h2>
        <p style="margin:15px 0; color:#856404;">For enhanced security, please set up two-factor authentication. You'll need to verify your phone number.</p>
        <input type="tel" id="enrollPhoneNumber" placeholder="Phone Number (with country code, e.g., +919876543210)" style="width:100%; padding:10px; margin:10px 0; box-sizing:border-box;">
        
        <div id="recaptcha-enroll" style="display:flex; justify-content:center; margin:15px 0;"></div>
        
        <button class="add" id="mfaSendBtn" onclick="sendEnrollCode()" style="width:100%; margin:10px 0;" disabled>Send Verification Code</button>
        
        <div id="enrollmentVerificationSection" style="display:none; margin-top:20px;">
            <input type="text" id="enrollVerificationCode" placeholder="6-digit code" maxlength="6" style="width:100%; padding:10px; margin:10px 0; box-sizing:border-box; font-size:18px; text-align:center; letter-spacing:5px;">
            <button class="add" onclick="completeEnrollment()" style="width:100%; margin:10px 0;">Complete Setup</button>
        </div>
        
        <button class="export-btn" onclick="skipMfaEnrollment()" style="width:100%; margin:10px 0;">Skip for Now</button>
        <div id="mfaEnrollError" style="color:red; margin-top:10px;"></div>
    </div>

    <div id="appContainer" style="display:none;">
        <div style="text-align:right; margin-bottom:20px; display:flex; justify-content:flex-end; align-items:center;">
            <a href="index.html" class="nav-link">üíä Medicine Tracker</a>
            
            <span id="userEmail" style="margin-right:10px; font-weight:bold; margin-left: 15px;"></span>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
        
        <h1>‚ù§Ô∏è Daily Health Readings</h1>
        
        <div class="controls">
            <h2>Record a New Reading</h2>
            <div class="input-grid">
                <div class="input-group">
                    <label for="recordDate">Date</label>
                    <input type="date" id="recordDate">
                </div>
                
                <div class="input-group">
                    <label for="recordTime">Time</label>
                    <input type="time" id="recordTime">
                </div>

                <div class="input-group">
                    <label for="personSelect">Person Name</label>
                    <div class="person-input-group">
                        <select id="personSelect" onchange="handlePersonChange(this.value)">
                            <option value="" disabled selected>Select a person...</option>
                            <option value="Custom">Add New Person...</option>
                        </select>
                        <input type="text" id="personCustomInput" placeholder="Enter new name here" onblur="handleCustomNameBlur(this.value)">
                    </div>
                </div>
                
                <div class="input-group">
                    <label for="systole">Systolic (BP)</label>
                    <input type="number" id="systole" placeholder="e.g., 120" step="1">
                </div>
                
                <div class="input-group">
                    <label for="diastole">Diastolic (BP)</label>
                    <input type="number" id="diastole" placeholder="e.g., 80" step="1">
                </div>

                <div class="input-group">
                    <label for="glucose">Glucose (mg/dL)</label>
                    <input type="number" id="glucose" placeholder="e.g., 100" step="0.1">
                </div>

                <div class="input-group">
                    <label for="weight">Weight (kg/lbs)</label>
                    <input type="number" id="weight" placeholder="e.g., 75" step="0.1">
                </div>
                
            </div>
            
            <button class="add" onclick="addReading()">Add Reading</button>
            
            <button class="export-btn" onclick="exportFullHistory()">‚¨áÔ∏è Download Full History (CSV)</button>

        </div>
        
        <div id="todayAveragesContainer">
            <h2>‚òÄÔ∏è Today's Individual Readings</h2> 
        </div>

        <div id="detailedHistoryContainer">
            <h2>üìÖ Detailed 30-Day Reading History</h2>
            <p style="text-align: center; font-style: italic; color: #555;">Showing the most recent reading per person for the last 30 days.</p>
        </div>

        <div id="overallAveragesContainer">
            <h2>üìà Overall Averages Summary</h2>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.21.0/firebase-app.js';
        import { getDatabase, ref, set, onValue, push, update, remove } from 'https://www.gstatic.com/firebasejs/9.21.0/firebase-database.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, multiFactor, PhoneAuthProvider, PhoneMultiFactorGenerator, RecaptchaVerifier } from 'https://www.gstatic.com/firebasejs/9.21.0/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAjRB8_dLv8icceOyZNNGO9kIXUFVjWfoY",
            authDomain: "medicine-tracker-b90f2.firebaseapp.com",
            databaseURL: "https://medicine-tracker-b90f2-default-rtdb.firebaseio.com",
            projectId: "medicine-tracker-b90f2",
            storageBucket: "medicine-tracker-b90f2.firebasestorage.app",
            messagingSenderId: "230127910329",
            appId: "1:230127910329:web:756789fcd3a1ac02948a68"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        let currentUser = null;
        let allReadings = [];
        let personNames = new Set();
        let currentPerson = '';
        const today = new Date();
        document.getElementById('recordDate').value = today.toISOString().split('T')[0];
        document.getElementById('recordTime').value = today.toTimeString().split(' ')[0].substring(0, 5); 
        const todayDateString = today.toISOString().split('T')[0];

        let recaptchaVerifierAuth = null;
        let recaptchaVerifierEnroll = null;
        let recaptchaWidgetId = null; // New variable for reCAPTCHA widget ID
        let recaptchaEnrollReady = false; // New flag to track reCAPTCHA status
        let mfaResolver = null;
        let enrollmentVerificationId = null;
        let pendingUserForEnrollment = null;

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString + 'T00:00:00'); 
            
            const day = date.getDate().toString().padStart(2, '0');
            const year = date.getFullYear().toString().slice(-2);
            
            const monthNames = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
            const month = monthNames[date.getMonth()];

            return `${day}-${month}-${year}`;
        }
        
        function toggleSignupMode() {
            const container = document.getElementById('authContainer');
            const toggleBtn = document.getElementById('signupToggleBtn');
            const loginBtn = document.getElementById('loginBtn');
            const isSignupMode = container.classList.contains('signup-mode');

            if (isSignupMode) {
                container.classList.remove('signup-mode');
                toggleBtn.textContent = 'Sign Up';
                toggleBtn.onclick = toggleSignupMode;
                loginBtn.onclick = login;
            } else {
                container.classList.add('signup-mode');
                toggleBtn.textContent = 'Register';
                toggleBtn.onclick = signup;
                loginBtn.onclick = () => { container.classList.remove('signup-mode'); login(); };
            }
            document.getElementById('authError').textContent = '';
        }

        function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorEl = document.getElementById('authError');
            if (!email || !password) { errorEl.textContent = 'Please enter email and password'; return; }

            signInWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    currentUser = userCredential.user;
                    errorEl.textContent = '';
                    
                    checkMfaEnrollmentStatus();
                })
                .catch((error) => {
                    if (error.code === 'auth/multi-factor-auth-required') {
                        handleMfaSignIn(error);
                    } else {
                        errorEl.textContent = 'Login failed: ' + error.message;
                    }
                });
        }

        function handleMfaSignIn(error) {
            mfaResolver = error.resolver;
            
            if (mfaResolver.hints.length === 0) {
                document.getElementById('authError').textContent = 'No MFA method enrolled.';
                return;
            }

            const phoneHint = mfaResolver.hints[0];
            const phoneInfoOptions = {
                multiFactorHint: phoneHint,
                session: mfaResolver.session
            };

            const phoneAuthProvider = new PhoneAuthProvider(auth);

            if (!recaptchaVerifierAuth) {
                recaptchaVerifierAuth = new RecaptchaVerifier(auth, 'recaptcha-container-auth', {
                    size: 'normal',
                    callback: () => {
                        console.log('reCAPTCHA solved for MFA sign-in');
                    }
                });
            }

            phoneAuthProvider.verifyPhoneNumber(phoneInfoOptions, recaptchaVerifierAuth)
                .then((verificationId) => {
                    window.mfaVerificationId = verificationId;
                    
                    document.getElementById('authContainer').style.display = 'none';
                    document.getElementById('mfaVerificationContainer').style.display = 'block';
                    document.getElementById('mfaVerificationCode').value = '';
                    document.getElementById('mfaError').textContent = '';
                })
                .catch((error) => {
                    console.error('Error sending MFA code:', error);
                    document.getElementById('authError').textContent = 'Failed to send verification code: ' + error.message;
                });
        }

        function verifyMfaCode() {
            const verificationCode = document.getElementById('mfaVerificationCode').value;
            const errorEl = document.getElementById('mfaError');

            if (!verificationCode || verificationCode.length !== 6) {
                errorEl.textContent = 'Please enter a valid 6-digit code.';
                return;
            }

            const cred = PhoneAuthProvider.credential(window.mfaVerificationId, verificationCode);
            const multiFactorAssertion = PhoneMultiFactorGenerator.assertion(cred);

            mfaResolver.resolveSignIn(multiFactorAssertion)
                .then((userCredential) => {
                    currentUser = userCredential.user;
                    errorEl.textContent = '';
                    document.getElementById('mfaVerificationContainer').style.display = 'none';
                    showApp();
                })
                .catch((error) => {
                    console.error('MFA verification error:', error);
                    errorEl.textContent = 'Verification failed: ' + error.message;
                });
        }

        function cancelMfaVerification() {
            mfaResolver = null;
            window.mfaVerificationId = null;
            document.getElementById('mfaVerificationContainer').style.display = 'none';
            document.getElementById('authContainer').style.display = 'block';
        }

        function signup() {
            const name = document.getElementById('name').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const phoneNumber = document.getElementById('phoneNumber').value;
            const errorEl = document.getElementById('authError');

            if (!name || !email || !password || !confirmPassword || password !== confirmPassword) {
                errorEl.textContent = 'Please check all fields and ensure passwords match.';
                return;
            }

            if (!phoneNumber || !phoneNumber.startsWith('+')) {
                errorEl.textContent = 'Please enter a valid phone number with country code (e.g., +919876543210).';
                return;
            }

            createUserWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    currentUser = userCredential.user;
                    const userRef = ref(db, 'users/' + currentUser.uid + '/profile');
                    return set(userRef, { name: name, email: email, phoneNumber: phoneNumber });
                })
                .then(() => {
                    pendingUserForEnrollment = currentUser;
                    // UPDATED: Function call name
                    showMfaEnroll(phoneNumber); 
                })
                .catch((error) => {
                    errorEl.textContent = 'Signup failed: ' + error.message;
                });
        }

        function checkMfaEnrollmentStatus() {
            if (!currentUser) return;

            const mfaInfo = multiFactor(currentUser);
            
            if (mfaInfo.enrolledFactors.length === 0) {
                const profileRef = ref(db, 'users/' + currentUser.uid + '/profile');
                onValue(profileRef, (snapshot) => {
                    const profile = snapshot.val();
                    if (profile && profile.phoneNumber) {
                        // UPDATED: Function call name
                        showMfaEnroll(profile.phoneNumber);
                    } else {
                        // UPDATED: Function call name
                        showMfaEnroll('');
                    }
                }, { onlyOnce: true });
            } else {
                showApp();
            }
        }

        // UPDATED: Renamed function from showMfaEnrollment to showMfaEnroll
        function showMfaEnroll(phoneNumber) {
            document.getElementById('authContainer').style.display = 'none';
            // UPDATED: Container ID
            document.getElementById('mfaEnrollContainer').style.display = 'block';
            document.getElementById('enrollPhoneNumber').value = phoneNumber || '';
            document.getElementById('enrollmentVerificationSection').style.display = 'none';
            // UPDATED: Error display ID
            document.getElementById('mfaEnrollError').textContent = '';

            // --- START: NEW reCAPTCHA Logic for stability (from PDF) ---
            document.getElementById('mfaSendBtn').disabled = true;
            recaptchaEnrollReady = false;

            if (recaptchaVerifierEnroll) {
                recaptchaVerifierEnroll.clear();
                recaptchaVerifierEnroll = null;
            }
            // --- END: NEW reCAPTCHA Logic ---

            // Only create verifier once div exists and is shown, using the new recaptcha-enroll ID
            setTimeout(() => {
                try {
                    recaptchaVerifierEnroll = new RecaptchaVerifier(auth, 'recaptcha-enroll', { // UPDATED: Container ID
                        size: 'normal',
                        callback: (response) => {
                            console.log('reCAPTCHA solved for enrollment:', response);
                            document.getElementById('mfaSendBtn').disabled = false; // ENABLE button
                            recaptchaEnrollReady = true;
                        },
                        'expired-callback': () => {
                            console.log('reCAPTCHA expired');
                            document.getElementById('mfaSendBtn').disabled = true; // DISABLE button
                            recaptchaEnrollReady = false;
                        }
                    });
                    recaptchaWidgetId = recaptchaVerifierEnroll.render().then((widgetId) => {
                        console.log('reCAPTCHA rendered successfully with ID:', widgetId);
                        return widgetId;
                    }).catch((error) => {
                        console.error('reCAPTCHA render error:', error);
                        document.getElementById('mfaEnrollError').textContent = 'reCAPTCHA initialization failed. Please refresh the page.'; // UPDATED: Error ID
                    });
                } catch (error) {
                    console.error('Error initializing reCAPTCHA:', error);
                    document.getElementById('mfaEnrollError').textContent = 'reCAPTCHA initialization failed. Please refresh the page.'; // UPDATED: Error ID
                }
            }, 100);
        }

        // UPDATED: Renamed function from sendEnrollmentCode to sendEnrollCode
        function sendEnrollCode() {
            const phoneNumber = document.getElementById('enrollPhoneNumber').value;
            const errorEl = document.getElementById('mfaEnrollError'); // UPDATED: Error ID

            if (!phoneNumber || !phoneNumber.startsWith('+')) {
                errorEl.textContent = 'Please enter a valid phone number with country code (e.g., +919876543210).';
                return;
            }

            if (!currentUser) {
                errorEl.textContent = 'User session expired. Please login again.';
                return;
            }
            
            // UPDATED: Check reCAPTCHA status
            if (!recaptchaEnrollReady || !recaptchaVerifierEnroll) {
                errorEl.textContent = 'reCAPTCHA not ready or verified. Please complete reCAPTCHA and try again.';
                return;
            }

            document.getElementById('mfaSendBtn').disabled = true; // Disable button immediately on send attempt

            multiFactor(currentUser).getSession()
                .then((multiFactorSession) => {
                    const phoneInfoOptions = {
                        phoneNumber: phoneNumber,
                        session: multiFactorSession
                    };

                    const phoneAuthProvider = new PhoneAuthProvider(auth);

                    return phoneAuthProvider.verifyPhoneNumber(phoneInfoOptions, recaptchaVerifierEnroll);
                })
                .then((verificationId) => {
                    enrollmentVerificationId = verificationId;
                    document.getElementById('enrollmentVerificationSection').style.display = 'block';
                    errorEl.textContent = '';
                    
                    const profileRef = ref(db, 'users/' + currentUser.uid + '/profile/phoneNumber');
                    set(profileRef, phoneNumber);
                })
                .catch((error) => {
                    console.error('Error sending enrollment code:', error);
                    errorEl.textContent = 'Failed to send code: ' + error.message;
                    
                    // UPDATED: Clear and re-render reCAPTCHA on error
                    if (recaptchaVerifierEnroll) {
                        recaptchaVerifierEnroll.clear();
                        recaptchaVerifierEnroll = null;
                        recaptchaEnrollReady = false;
                    }
                    document.getElementById('mfaSendBtn').disabled = true; // Keep button disabled
                    // Re-render reCAPTCHA immediately
                    showMfaEnroll(phoneNumber);
                });
        }

        function completeEnrollment() {
            const verificationCode = document.getElementById('enrollVerificationCode').value;
            const errorEl = document.getElementById('mfaEnrollError'); // UPDATED: Error ID

            if (!verificationCode || verificationCode.length !== 6) {
                errorEl.textContent = 'Please enter a valid 6-digit code.';
                return;
            }

            const cred = PhoneAuthProvider.credential(enrollmentVerificationId, verificationCode);
            const multiFactorAssertion = PhoneMultiFactorGenerator.assertion(cred);

            multiFactor(currentUser).enroll(multiFactorAssertion, 'Primary Phone')
                .then(() => {
                    errorEl.textContent = '';
                    document.getElementById('mfaEnrollContainer').style.display = 'none'; // UPDATED: Container ID
                    
                    // UPDATED: Clear reCAPTCHA on successful enrollment
                    if (recaptchaVerifierEnroll) {
                        recaptchaVerifierEnroll.clear();
                        recaptchaVerifierEnroll = null;
                        recaptchaEnrollReady = false;
                    }
                    
                    alert('Two-factor authentication has been successfully enabled!');
                    showApp();
                })
                .catch((error) => {
                    console.error('Enrollment completion error:', error);
                    errorEl.textContent = 'Enrollment failed: ' + error.message;
                });
        }

        function skipMfaEnrollment() {
            if (confirm('Are you sure you want to skip two-factor authentication? This reduces your account security.')) {
                // UPDATED: Clear reCAPTCHA on skip
                if (recaptchaVerifierEnroll) {
                    recaptchaVerifierEnroll.clear();
                    recaptchaVerifierEnroll = null;
                    recaptchaEnrollReady = false;
                }
                document.getElementById('mfaEnrollContainer').style.display = 'none'; // UPDATED: Container ID
                showApp();
            }
        }

        function logout() {
            if (confirm('Logout?')) {
                signOut(auth).then(() => {
                    currentUser = null;
                    showLogin();
                });
            }
        }
// ... (rest of the functions remain the same)
        function showLogin() {
            document.getElementById('authContainer').style.display = 'block';
            document.getElementById('appContainer').style.display = 'none';
        }

        function showApp() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            
            const profileRef = ref(db, 'users/' + currentUser.uid + '/profile/name');
            onValue(profileRef, (snapshot) => {
                const userName = snapshot.val();
                document.getElementById('userEmail').textContent = userName || currentUser.email;
            }, { onlyOnce: true });

            setupRealtimeSync(); 
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                checkMfaEnrollmentStatus();
            } else {
                currentUser = null;
                showLogin();
            }
        });

        let syncListener = null;
        function setupRealtimeSync() {
            if (!currentUser) return;
            if (syncListener) syncListener(); 

            const readingsRef = ref(db, 'users/' + currentUser.uid + '/healthReadings');

            syncListener = onValue(readingsRef, (snapshot) => {
                const data = snapshot.val(); 
                allReadings = [];
                personNames.clear();

                if (data) {
                    for (const key in data) {
                        const reading = { id: key, ...data[key] };
                        allReadings.push(reading);
                        if (reading.person) {
                            personNames.add(reading.person);
                        }
                    }
                }

                allReadings.sort((a, b) => {
                    const dateA = new Date(a.date + ' ' + (a.time || '00:00'));
                    const dateB = new Date(b.date + ' ' + (b.time || '00:00'));
                    return dateB - dateA;
                });
                
                console.log('--- Firebase Sync Result ---');
                console.log('Readings Fetched Count:', allReadings.length);
                if (allReadings.length > 0) {
                     console.log('Sample Reading:', allReadings[0]);
                     console.log('Detected Persons:', Array.from(personNames));
                }
                console.log('--------------------------');

                if (allReadings.length > 0 && !currentPerson) {
                    currentPerson = allReadings[0].person; 
                    updatePersonDropdown(true); 
                } else {
                    updatePersonDropdown();
                }
                
                loadReadings(); 

            }, (error) => {
                console.error('Real-time sync error: Failed to read from database.', error);
            });
        }
        
        function updatePersonDropdown(forceSelect = false) {
            const select = document.getElementById('personSelect');
            const customInput = document.getElementById('personCustomInput');
            
            select.innerHTML = '';
            select.innerHTML += `<option value="" disabled>Select a person...</option>`;
            
            const sortedNames = Array.from(personNames).sort();
            sortedNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                if (forceSelect && name === currentPerson) {
                     option.selected = true;
                }
                select.appendChild(option);
            });
            
            const customOption = document.createElement('option');
            customOption.value = "Custom";
            customOption.textContent = "Add New Person...";
            select.appendChild(customOption);
            
            if (currentPerson && !forceSelect) {
                select.value = currentPerson;
            } else if (!currentPerson) {
                select.value = "";
            }

            if (select.value === 'Custom') {
                customInput.style.display = 'block';
            } else {
                customInput.style.display = 'none';
            }
        }

        function handlePersonChange(value) {
            const customInput = document.getElementById('personCustomInput');
            if (value === 'Custom') {
                customInput.style.display = 'block';
                customInput.focus();
            } else {
                customInput.style.display = 'none';
                currentPerson = value;
            }
        }

        function handleCustomNameBlur(value) {
            const select = document.getElementById('personSelect');
            if (value.trim()) {
                currentPerson = value.trim();
                // Ensure the custom value is selected in the dropdown temporarily
                select.innerHTML = ''; // Clear options
                const newOption = document.createElement('option');
                newOption.value = currentPerson;
                newOption.textContent = currentPerson;
                newOption.selected = true;
                select.appendChild(newOption);
                // Re-populate and select the correct option after sync updates
                updatePersonDropdown(true); 
            } else {
                // If custom input is empty, revert to 'Select a person...'
                select.value = "";
            }
        }

        function addReading() {
            const date = document.getElementById('recordDate').value;
            const time = document.getElementById('recordTime').value;
            const person = currentPerson;
            const systole = document.getElementById('systole').value;
            const diastole = document.getElementById('diastole').value;
            const glucose = document.getElementById('glucose').value;
            const weight = document.getElementById('weight').value;

            if (!date || !time || !person || (!systole && !diastole && !glucose && !weight)) {
                alert('Please enter Date, Time, Person Name, and at least one reading value (BP/Glucose/Weight).');
                return;
            }

            const newReading = {
                date: date,
                time: time,
                person: person,
                systole: systole ? parseInt(systole) : null,
                diastole: diastole ? parseInt(diastole) : null,
                glucose: glucose ? parseFloat(glucose) : null,
                weight: weight ? parseFloat(weight) : null,
                timestamp: Date.now()
            };

            const readingsRef = ref(db, 'users/' + currentUser.uid + '/healthReadings');
            push(readingsRef, newReading)
                .then(() => {
                    alert('Reading added successfully!');
                    document.getElementById('systole').value = '';
                    document.getElementById('diastole').value = '';
                    document.getElementById('glucose').value = '';
                    document.getElementById('weight').value = '';
                })
                .catch((error) => {
                    console.error("Error adding reading: ", error);
                    alert("Failed to add reading: " + error.message);
                });
        }

        function deleteReading(id) {
            if (confirm('Are you sure you want to delete this reading?')) {
                const readingRef = ref(db, 'users/' + currentUser.uid + '/healthReadings/' + id);
                remove(readingRef)
                    .then(() => {
                        console.log('Reading deleted.');
                    })
                    .catch((error) => {
                        console.error('Error deleting reading:', error);
                        alert('Failed to delete reading: ' + error.message);
                    });
            }
        }

        function loadReadings() {
            const todayReadings = allReadings.filter(r => r.date === todayDateString);
            renderTodayReadings(todayReadings);
            renderDetailedHistory(allReadings);
            renderOverallAverages(allReadings);
        }

        function calculateAverages(readings) {
            const totals = { systole: 0, diastole: 0, glucose: 0, weight: 0 };
            const counts = { systole: 0, diastole: 0, glucose: 0, weight: 0 };

            readings.forEach(r => {
                if (r.systole) { totals.systole += r.systole; counts.systole++; }
                if (r.diastole) { totals.diastole += r.diastole; counts.diastole++; }
                if (r.glucose) { totals.glucose += r.glucose; counts.glucose++; }
                if (r.weight) { totals.weight += r.weight; counts.weight++; }
            });

            const formatBP = (sys, dias) => (counts.systole > 0 && counts.diastole > 0) ? `${Math.round(sys / counts.systole)} / ${Math.round(dias / counts.diastole)}` : 'N/A';
            const formatGlucose = (total, count) => count > 0 ? `${(total / count).toFixed(1)}` : 'N/A';
            const formatWeight = (total, count) => count > 0 ? `${(total / count).toFixed(1)}` : 'N/A';

            return {
                bp: formatBP(totals.systole, totals.diastole),
                glucose: formatGlucose(totals.glucose, counts.glucose),
                weight: formatWeight(totals.weight, counts.weight),
                bpCount: counts.systole,
                glucoseCount: counts.glucose,
                weightCount: counts.weight
            };
        }

        function renderTodayReadings(readings) {
            const container = document.getElementById('todayAveragesContainer');
            container.innerHTML = '<h2>‚òÄÔ∏è Today\'s Individual Readings</h2>';

            if (readings.length === 0) {
                container.innerHTML += '<p class="no-data">No readings recorded today.</p>';
                return;
            }

            // Group by person
            const readingsByPerson = readings.reduce((acc, r) => {
                const key = r.person || 'Unknown';
                if (!acc[key]) acc[key] = [];
                acc[key].push(r);
                return acc;
            }, {});

            let tableHTML = `<table class="data-table">
                <thead>
                    <tr>
                        <th rowspan="2">Time</th>
                        <th rowspan="2">Person</th>
                        <th colspan="2">Blood Pressure (mmHg)</th>
                        <th rowspan="2">Glucose (mg/dL)</th>
                        <th rowspan="2">Weight (kg/lbs)</th>
                        <th rowspan="2">Action</th>
                    </tr>
                    <tr>
                        <th>Systolic</th>
                        <th>Diastolic</th>
                    </tr>
                </thead>
                <tbody>`;
            
            let sortedReadings = readings.sort((a, b) => {
                const timeA = a.time || '00:00';
                const timeB = b.time || '00:00';
                if (timeA < timeB) return -1;
                if (timeA > timeB) return 1;
                return 0;
            });


            sortedReadings.forEach(r => {
                tableHTML += `
                    <tr>
                        <td style="font-weight: bold; white-space: nowrap;">${r.time}</td>
                        <td style="text-align: left; font-weight: bold;">${r.person || 'Unknown'}</td>
                        <td>${r.systole || '‚Äî'}</td>
                        <td>${r.diastole || '‚Äî'}</td>
                        <td>${r.glucose ? r.glucose.toFixed(1) : '‚Äî'}</td>
                        <td>${r.weight ? r.weight.toFixed(1) : '‚Äî'}</td>
                        <td><button class="delete-btn" onclick="deleteReading('${r.id}')">Delete</button></td>
                    </tr>`;
            });

            tableHTML += `</tbody></table>`;
            container.innerHTML += tableHTML;
        }

        function renderDetailedHistory(allReadings) {
            const container = document.getElementById('detailedHistoryContainer');
            container.innerHTML = '<h2>üìÖ Detailed 30-Day Reading History</h2><p style="text-align: center; font-style: italic; color: #555;">Showing the most recent reading per person for the last 30 days.</p>';
            
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            const filteredReadings = allReadings.filter(r => new Date(r.date + 'T' + (r.time || '00:00')) >= thirtyDaysAgo);

            if (filteredReadings.length === 0) {
                container.innerHTML += '<p class="no-data">No readings in the last 30 days.</p>';
                return;
            }

            // Find the most recent reading for each person *on each day*
            const dailyReadingsByPerson = new Map(); // Key: 'date|person', Value: most recent reading

            filteredReadings.forEach(r => {
                const key = `${r.date}|${r.person}`;
                const readingDate = new Date(r.date + 'T' + (r.time || '00:00'));
                
                if (!dailyReadingsByPerson.has(key) || readingDate > new Date(dailyReadingsByPerson.get(key).date + 'T' + (dailyReadingsByPerson.get(key).time || '00:00'))) {
                    dailyReadingsByPerson.set(key, r);
                }
            });

            // Group the unique daily readings by person for history display
            const historyByPerson = Array.from(dailyReadingsByPerson.values()).reduce((acc, r) => {
                const key = r.person || 'Unknown';
                if (!acc[key]) acc[key] = [];
                acc[key].push(r);
                return acc;
            }, {});

            let tableHTML = '<table class="data-table">';
            tableHTML += '<thead><tr><th rowspan="2">Date</th>';
            
            const sortedPersonNames = Array.from(personNames).sort();
            
            if (sortedPersonNames.length === 0) {
                 tableHTML += `<th>BP (S/D)</th><th>Glucose</th><th>Weight</th>`;
            } else {
                sortedPersonNames.forEach(name => {
                    tableHTML += `<th colspan="3">${name}</th>`;
                });
            }

            tableHTML += '</tr>';
            
            if (sortedPersonNames.length > 0) {
                 tableHTML += `<tr>`;
                 sortedPersonNames.forEach(() => {
                    tableHTML += `<th>BP (S/D)</th><th>Gluc</th><th>Wt</th>`;
                 });
                 tableHTML += `</tr>`;
            }

            tableHTML += '</thead><tbody>';

            const dateMap = {}; // Map of 'YYYY-MM-DD' -> array of daily readings for that date
            Array.from(dailyReadingsByPerson.values()).forEach(r => {
                if (!dateMap[r.date]) dateMap[r.date] = [];
                dateMap[r.date].push(r);
            });

            const sortedDates = Object.keys(dateMap).sort().reverse();
            
            sortedDates.forEach(date => {
                tableHTML += `<tr><th style="white-space: nowrap;">${formatDate(date)}</th>`;
                
                sortedPersonNames.forEach(personName => {
                    const dailyReadings = dateMap[date].filter(r => r.person === personName);
                    
                    if (dailyReadings.length > 0) {
                        const r = dailyReadings[0];
                        const bp = (r.systole || r.diastole) ? `<span class="avg-bp">${r.systole || '‚Äî'}/${r.diastole || '‚Äî'}</span>` : '‚Äî';
                        const glucose = r.glucose ? r.glucose.toFixed(1) : '‚Äî';
                        const weight = r.weight ? r.weight.toFixed(1) : '‚Äî';
                        
                        tableHTML += `<td>${bp}</td><td>${glucose}</td><td>${weight}</td>`;
                    } else {
                        tableHTML += `<td>‚Äî</td><td>‚Äî</td><td>‚Äî</td>`;
                    }
                });

                tableHTML += `</tr>`;
            });


            tableHTML += '</tbody></table>';
            container.innerHTML += tableHTML;
        }

        function renderOverallAverages(allReadings) {
            const container = document.getElementById('overallAveragesContainer');
            container.innerHTML = '<h2>üìà Overall Averages Summary</h2>';
            
            if (allReadings.length === 0) {
                container.innerHTML += '<p class="no-data">No data to calculate averages.</p>';
                return;
            }

            const averagesByPerson = {};
            Array.from(personNames).forEach(person => {
                const readings = allReadings.filter(r => r.person === person);
                averagesByPerson[person] = calculateAverages(readings);
            });

            let tableHTML = `<table class="data-table">
                <thead>
                    <tr>
                        <th rowspan="2">Person</th>
                        <th colspan="2">Blood Pressure (mmHg)</th>
                        <th rowspan="2">Glucose (mg/dL)</th>
                        <th rowspan="2">Weight (kg/lbs)</th>
                    </tr>
                    <tr>
                        <th>Avg BP (S/D)</th>
                        <th># of BP Readings</th>
                    </tr>
                </thead>
                <tbody>`;

            const sortedPersonNames = Object.keys(averagesByPerson).sort();

            sortedPersonNames.forEach(person => {
                const avg = averagesByPerson[person];
                tableHTML += `
                    <tr>
                        <th style="text-align:left;">${person}</th>
                        <td class="avg-bp">${avg.bp}</td>
                        <td>${avg.bpCount || '‚Äî'}</td>
                        <td class="avg-reading">${avg.glucose}</td>
                        <td class="avg-reading">${avg.weight}</td>
                    </tr>`;
            });

            tableHTML += `</tbody></table>`;
            container.innerHTML += tableHTML;
        }

        function exportFullHistory() {
            if (allReadings.length === 0) {
                alert("No data to export.");
                return;
            }

            const headers = ["ID", "Date", "Time", "Person", "Systolic (mmHg)", "Diastolic (mmHg)", "Glucose (mg/dL)", "Weight (kg/lbs)", "Timestamp (ms)"];
            let csvContent = headers.join(",") + "\n";

            allReadings.forEach(reading => {
                const row = [
                    reading.id,
                    reading.date,
                    reading.time || "",
                    reading.person || "Unknown",
                    reading.systole || "",
                    reading.diastole || "",
                    reading.glucose || "",
                    reading.weight || "",
                    reading.timestamp
                ];
                csvContent += row.map(e => {
                    const value = String(e || "").replace(/"/g, '""');
                    return isNaN(e) ? `"${value}"` : value;
                }).join(",") + "\n";
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `health_tracker_data_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        window.login = login;
        window.toggleSignupMode = toggleSignupMode;
        window.signup = signup;
        window.logout = logout;
        window.addReading = addReading;
        window.deleteReading = deleteReading;
        window.handlePersonChange = handlePersonChange;
        window.handleCustomNameBlur = handleCustomNameBlur;
        window.exportFullHistory = exportFullHistory;
        window.verifyMfaCode = verifyMfaCode;
        window.cancelMfaVerification = cancelMfaVerification;
        window.sendEnrollCode = sendEnrollCode; // Renamed
        window.completeEnrollment = completeEnrollment;
        window.skipMfaEnrollment = skipMfaEnrollment;
        
    </script>
</body>
</html>
