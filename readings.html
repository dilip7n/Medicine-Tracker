<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>Holistic Health Tracker (BP/Glucose)</title>
Â  Â  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>â¤ï¸</text></svg>">
Â  Â  <style>
Â  Â  Â  Â  /* Global & Reset */
Â  Â  Â  Â  * {
Â  Â  Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  }

Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  font-family: Arial, sans-serif;
Â  Â  Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  Â  Â  max-width: 1200px;Â 
Â  Â  Â  Â  Â  Â  margin: 0 auto;
Â  Â  Â  Â  Â  Â  background-color: #f7f9fc;
Â  Â  Â  Â  }

Â  Â  Â  Â  h1 {
Â  Â  Â  Â  Â  Â  color: #1a4f78;
Â  Â  Â  Â  Â  Â  border-bottom: 2px solid #e0e0e0;
Â  Â  Â  Â  Â  Â  padding-bottom: 10px;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Controls and Inputs */
Â  Â  Â  Â  .controls {
Â  Â  Â  Â  Â  Â  background: white;
Â  Â  Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
Â  Â  Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .controls label {
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  display: block;
Â  Â  Â  Â  Â  Â  margin-top: 5px;
Â  Â  Â  Â  Â  Â  color: #555;
Â  Â  Â  Â  Â  Â  margin-bottom: 5px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .controls input[type="date"],
Â  Â  Â  Â  .controls input[type="time"],
Â  Â  Â  Â  .controls input[type="number"],
Â  Â  Â  Â  .controls input[type="text"],
Â  Â  Â  Â  .controls select,
Â  Â  Â  Â  #personSelect {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  Â  Â  Â  border-radius: 4px;
Â  Â  Â  Â  Â  Â  font-size: 16px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .input-group {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* GRID FIXES for Alignment */
Â  Â  Â  Â  .input-grid {
Â  Â  Â  Â  Â  Â  display: grid;
Â  Â  Â  Â  Â  Â  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
Â  Â  Â  Â  Â  Â  gap: 20px;
Â  Â  Â  Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  Â  Â  Â  align-items: start;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Person Input Group Styling */
Â  Â  Â  Â  .person-input-group {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  gap: 5px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  #personCustomInput {
Â  Â  Â  Â  Â  Â  margin-top: 0;
Â  Â  Â  Â  Â  Â  display: none;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Buttons */
Â  Â  Â  Â  button {
Â  Â  Â  Â  Â  Â  padding: 10px 20px;
Â  Â  Â  Â  Â  Â  margin-top: 10px;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  font-size: 16px;
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  border-radius: 4px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .add {
Â  Â  Â  Â  Â  Â  background: #4CAF50;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .update {
Â  Â  Â  Â  Â  Â  background: #FF9800; /* Orange for Update */
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  display: none; /* Hidden by default */
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* New Table Download Button Style */
Â  Â  Â  Â  .table-export-btn {
Â  Â  Â  Â  Â  Â  background: #2196F3; /* Light Blue for table export */
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  padding: 8px 15px;
Â  Â  Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  Â  Â  float: right;
Â  Â  Â  Â  Â  Â  white-space: nowrap;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .export-btn {
Â  Â  Â  Â  Â  Â  background: #007bff; /* Blue for full export */
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  margin-top: 15px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .logout-btn {
Â  Â  Â  Â  Â  Â  background: #f44336;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  padding: 5px 15px;
Â  Â  Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* --- TABLES STYLES (Applies to all new tables) --- */
Â  Â  Â  Â  #overallAveragesContainer, #todayAveragesContainer, #detailedHistoryContainer {
Â  Â  Â  Â  Â  Â  margin-top: 30px;
Â  Â  Â  Â  Â  Â  padding: 15px;
Â  Â  Â  Â  Â  Â  background: white;
Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
Â  Â  Â  Â  Â  Â  /* Remove overflow-x: auto; here to force responsive behavior */
Â  Â  Â  Â  }

Â  Â  Â  Â  .data-table {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  min-width: 0; /* Important for mobile wrap */
Â  Â  Â  Â  Â  Â  border-collapse: collapse;
Â  Â  Â  Â  Â  Â  margin-top: 15px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .data-table th, .data-table td {
Â  Â  Â  Â  Â  Â  padding: 12px 10px;
Â  Â  Â  Â  Â  Â  border: 1px solid #eee;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  font-size: 0.9em;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .data-table thead th {
Â  Â  Â  Â  Â  Â  background-color: #1a4f78;Â 
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  white-space: nowrap;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .data-table thead tr:nth-child(2) th {
Â  Â  Â  Â  Â  Â  background-color: #007bff; /* Blue secondary header */
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  }

Â  Â  Â  Â  .data-table tbody th {
Â  Â  Â  Â  Â  Â  text-align: left;
Â  Â  Â  Â  Â  Â  background-color: #f0f8ff;Â 
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  }

Â  Â  Â  Â  .data-table tr:nth-child(even) {
Â  Â  Â  Â  Â  Â  background-color: #f7f9fc;
Â  Â  Â  Â  }

Â  Â  Â  Â  .avg-bp, .avg-reading {
Â  Â  Â  Â  Â  Â  white-space: nowrap;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .no-data {
Â  Â  Â  Â  Â  Â  color: #999;
Â  Â  Â  Â  Â  Â  font-style: italic;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Increased font size for Today's individual readings */
Â  Â  Â  Â  #todayAveragesContainer .detail-reading {
Â  Â  Â  Â  Â  Â  font-size: 1.0em;Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Auth Styles */
Â  Â  Â  Â  #authContainer {
Â  Â  Â  Â  Â  Â  max-width:400px; margin:50px auto; padding:30px; background:#f9f9f9; border-radius:10px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .signup-fields { display: none; }
Â  Â  Â  Â  #authContainer.signup-mode .signup-fields { display: block; }

Â  Â  Â  Â  /* Navigation Link Style */
Â  Â  Â  Â  .nav-link {
Â  Â  Â  Â  Â  Â  text-decoration: none;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  margin-left: 15px;
Â  Â  Â  Â  Â  Â  padding: 8px 12px;
Â  Â  Â  Â  Â  Â  border-radius: 4px;
Â  Â  Â  Â  Â  Â  background: #2196F3;
Â  Â  Â  Â  Â  Â  transition: background 0.2s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .nav-link:hover {
Â  Â  Â  Â  Â  Â  background: #0d47a1;
Â  Â  Â  Â  }
Â  Â  Â  Â  /* Action Buttons within Tables */
Â  Â  Â  Â  .action-btn {
Â  Â  Â  Â  Â  Â  background-color: #f44336;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  padding: 3px 6px;
Â  Â  Â  Â  Â  Â  border-radius: 3px;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  font-size: 0.8em;
Â  Â  Â  Â  Â  Â  margin-left: 5px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .edit-btn {
Â  Â  Â  Â  Â  Â  background-color: #4CAF50; /* Green for Edit */
Â  Â  Â  Â  }
Â  Â  Â  Â  .action-btn:hover {
Â  Â  Â  Â  Â  Â  opacity: 0.8;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* --- MOBILE RESPONSIVENESS: CARD/LIST VIEW --- */
Â  Â  Â  Â  @media screen and (max-width: 768px) {
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  /* General Layout Adjustments */
Â  Â  Â  Â  Â  Â  body { padding: 10px; }
Â  Â  Â  Â  Â  Â  .input-grid { grid-template-columns: 1fr; } /* Stack input fields */

Â  Â  Â  Â  Â  Â  /* Table Wrapper - Ensure tables don't force a scroll */
Â  Â  Â  Â  Â  Â  #overallAveragesContainer, #detailedHistoryContainer {
Â  Â  Â  Â  Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  /* Hiding Headers and Reformatting (Generic Card Style) */
Â  Â  Â  Â  Â  Â  .data-table {
Â  Â  Â  Â  Â  Â  Â  Â  border: 0;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  .data-table thead, .data-table thead tr {
Â  Â  Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  Â  Â  width: 1px;
Â  Â  Â  Â  Â  Â  Â  Â  height: 1px;
Â  Â  Â  Â  Â  Â  Â  Â  padding: 0;
Â  Â  Â  Â  Â  Â  Â  Â  margin: -1px;
Â  Â  Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  Â  Â  Â  Â  clip: rect(0, 0, 0, 0);
Â  Â  Â  Â  Â  Â  Â  Â  border: 0;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  /* Transform rows into cards */
Â  Â  Â  Â  Â  Â  .data-table tr {
Â  Â  Â  Â  Â  Â  Â  Â  display: block;
Â  Â  Â  Â  Â  Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  Â  Â  Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  Â  Â  Â  Â  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
Â  Â  Â  Â  Â  Â  Â  Â  background-color: #fff;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  /* Treat Person/Date header rows specially */
Â  Â  Â  Â  Â  Â  .data-table tbody th {
Â  Â  Â  Â  Â  Â  Â  Â  display: block;
Â  Â  Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  Â  Â  border-bottom: 1px solid #ccc;
Â  Â  Â  Â  Â  Â  Â  Â  background-color: #1a4f78;
Â  Â  Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 1.1em;
Â  Â  Â  Â  Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  Â  Â  Â  Â  border-radius: 8px 8px 0 0;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  /* Transform cells into block-level elements */
Â  Â  Â  Â  Â  Â  .data-table td {
Â  Â  Â  Â  Â  Â  Â  Â  display: block;
Â  Â  Â  Â  Â  Â  Â  Â  text-align: right;
Â  Â  Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  Â  Â  border-bottom: 1px dotted #ddd;
Â  Â  Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  Â  Â  Â  Â  padding-left: 50%; /* Make room for the pseudo-element label */
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  /* Insert the original header content as a label using data-label attribute */
Â  Â  Â  Â  Â  Â  .data-table td::before {
Â  Â  Â  Â  Â  Â  Â  Â  content: attr(data-label) ":";
Â  Â  Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  Â  Â  left: 10px;
Â  Â  Â  Â  Â  Â  Â  Â  width: 45%;
Â  Â  Â  Â  Â  Â  Â  Â  padding-right: 10px;
Â  Â  Â  Â  Â  Â  Â  Â  white-space: nowrap;
Â  Â  Â  Â  Â  Â  Â  Â  text-align: left;
Â  Â  Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  Â  Â  color: #555;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  .data-table tr:nth-child(even) {
Â  Â  Â  Â  Â  Â  Â  Â  background-color: #fff; /* Reset zebra striping for cards */
Â  Â  Â  Â  Â  Â  }
            
            /* Detailed History Action Column Fixes */
            #detailedHistoryContainer .data-table td:last-child {
                text-align: center; /* Center buttons horizontally in the block */
                padding-left: 10px; /* Remove large padding-left for action row */
            }
            #detailedHistoryContainer .data-table td:last-child::before {
                display: none; /* Hide data label for action row */
            }

            /* Fix: Force Action buttons to full width to stack on very small screens */
            @media screen and (max-width: 400px) {
                #detailedHistoryContainer .action-btn {
                    display: block;
                    width: 90%;
                    margin: 5px auto;
                }
            }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  /* --- FIXED: Today's Readings Table Specific adjustments (Stacking list view) --- */
Â  Â  Â  Â  Â  Â  #todayAveragesContainer .data-table {
Â  Â  Â  Â  Â  Â  Â  Â  Â min-width: unset;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  /* Hide all headers in Today's table */
Â  Â  Â  Â  Â  Â  #todayAveragesContainer .data-table thead, 
Â  Â  Â  Â  Â  Â  #todayAveragesContainer .data-table thead tr,
Â  Â  Â  Â  Â  Â  #todayAveragesContainer .data-table thead th {
Â  Â  Â  Â  Â  Â  Â  Â  Â display: none;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  #todayAveragesContainer .data-table tbody tr {
Â  Â  Â  Â  Â  Â  Â  Â  border: 1px solid #ccc; 
Â  Â  Â  Â  Â  Â  Â  Â  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); 
Â  Â  Â  Â  Â  Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  Â  Â  Â  Â  Â  display: block; /* Important: Change from flex to block for simple stacking */
Â  Â  Â  Â  Â  Â  Â  Â  padding: 0; 
Â  Â  Â  Â  Â  Â  Â  Â  background-color: #fff !important;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  #todayAveragesContainer .data-table tbody th {
Â  Â  Â  Â  Â  Â  Â  Â  /* Time column - acts as the list item header */
Â  Â  Â  Â  Â  Â  Â  Â  display: block;
Â  Â  Â  Â  Â  Â  Â  Â  text-align: left;
Â  Â  Â  Â  Â  Â  Â  Â  background-color: #f0f8ff; 
Â  Â  Â  Â  Â  Â  Â  Â  color: #1a4f78;
Â  Â  Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 1.1em;
Â  Â  Â  Â  Â  Â  Â  Â  padding: 10px; 
Â  Â  Â  Â  Â  Â  Â  Â  border-bottom: 1px solid #ccc;
Â  Â  Â  Â  Â  Â  Â  Â  border-radius: 7px 7px 0 0;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  #todayAveragesContainer .data-table tbody td {
Â  Â  Â  Â  Â  Â  Â  Â  /* Reading data cells - stack vertically */
Â  Â  Â  Â  Â  Â  Â  Â  display: block;
Â  Â  Â  Â  Â  Â  Â  Â  width: 100%; /* Ensure full width */
Â  Â  Â  Â  Â  Â  Â  Â  text-align: right;
Â  Â  Â  Â  Â  Â  Â  Â  padding: 8px 10px; 
Â  Â  Â  Â  Â  Â  Â  Â  padding-left: 50%; /* Room for the label */
Â  Â  Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  Â  Â  border-bottom: 1px dotted #ddd;
Â  Â  Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  #todayAveragesContainer .data-table tbody td:before {
Â  Â  Â  Â  Â  Â  Â  Â  content: attr(data-person) ":"; /* Use person name as label */
Â  Â  Â  Â  Â  Â  Â  Â  position: absolute; /* Position the label correctly */
Â  Â  Â  Â  Â  Â  Â  Â  left: 10px;
Â  Â  Â  Â  Â  Â  Â  Â  width: 45%;
Â  Â  Â  Â  Â  Â  Â  Â  padding-right: 5px;
Â  Â  Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  Â  Â  color: #1a4f78;
Â  Â  Â  Â  Â  Â  Â  Â  text-align: left;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  #todayAveragesContainer .data-table tbody td:last-child {
                border-bottom: none; /* Clean up the last cell's border */
            }
Â  Â  Â  Â  Â  Â  #todayAveragesContainer .detail-reading {
Â  Â  Â  Â  Â  Â  Â  Â  display: block;
Â  Â  Â  Â  Â  Â  Â  Â  line-height: 1.4;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body>
Â  Â  <div id="authContainer" style="display:none;">
Â  Â  Â  Â  <h2>ğŸ”’ Health Tracker Access</h2>
Â  Â  Â  Â  <div style="margin:20px 0;">
Â  Â  Â  Â  Â  Â  <div class="signup-fields">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="name" placeholder="Your Name" style="width:100%; padding:10px; margin:5px 0; box-sizing:border-box;">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <input type="email" id="email" placeholder="Email" style="width:100%; padding:10px; margin:5px 0; box-sizing:border-box;">
Â  Â  Â  Â  Â  Â  <input type="password" id="password" placeholder="Password (min 6 chars)" style="width:100%; padding:10px; margin:5px 0; box-sizing:border-box;">
Â  Â  Â  Â  Â  Â  <div class="signup-fields">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="password" id="confirmPassword" placeholder="Confirm Password" style="width:100%; padding:10px; margin:5px 0; box-sizing:border-box;">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <button class="add" onclick="login()" style="width:48%; margin:2%;" id="loginBtn">Login</button>
Â  Â  Â  Â  <button class="export" onclick="toggleSignupMode()" style="width:48%; margin:2%;" id="signupToggleBtn">Sign Up</button>
Â  Â  Â  Â  <div id="authError" style="color:red; margin-top:10px;"></div>
Â  Â  </div>

Â  Â  <div id="appContainer" style="display:none;">
Â  Â  Â  Â  <div style="text-align:right; margin-bottom:20px; display:flex; justify-content:flex-end; align-items:center;">
Â  Â  Â  Â  Â  Â  <a href="index.html" class="nav-link">ğŸ’Š Medicine Tracker</a>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <span id="userEmail" style="margin-right:10px; font-weight:bold; margin-left: 15px;"></span>
Â  Â  Â  Â  Â  Â  <button class="logout-btn" onclick="logout()">Logout</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <h1>â¤ï¸ Daily Health Readings</h1>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div class="controls">
Â  Â  Â  Â  Â  Â  <h2>Record a New Reading</h2>
Â  Â  Â  Â  Â  Â  <div class="input-grid">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="hidden" id="readingIdToEdit" value="">
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="recordDate">Date</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="date" id="recordDate">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="recordTime">Time</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="time" id="recordTime">
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="personSelect">Person Name</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="person-input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="personSelect" onchange="handlePersonChange(this.value)">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="" disabled selected>Select a person...</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Custom">Add New Person...</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="personCustomInput" placeholder="Enter new name here" onblur="handleCustomNameBlur(this.value)">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="systole">Systolic (BP)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="systole" placeholder="e.g., 120" step="1">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="diastole">Diastolic (BP)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="diastole" placeholder="e.g., 80" step="1">
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="glucose">Glucose (mg/dL)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="glucose" placeholder="e.g., 100" step="0.1">
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="weight">Weight (kg/lbs)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="weight" placeholder="e.g., 75" step="0.1">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <button class="add" id="addButton" onclick="addReading()">Add Reading</button>
Â  Â  Â  Â  Â  Â  <button class="update" id="updateButton" onclick="updateReading()">Update Reading</button>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <button class="export-btn" onclick="exportFullHistory()">â¬‡ï¸ Download Full History (CSV)</button>

Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div id="todayAveragesContainer">
Â  Â  Â  Â  Â  Â  <h2>â˜€ï¸ Today's Individual Readings</h2>Â 
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="detailedHistoryContainer">
Â  Â  Â  Â  Â  Â  <div style="display:flex; justify-content:space-between; align-items:center;">
Â  Â  Â  Â  Â  Â  Â  Â  <h2>ğŸ“… Detailed 30-Day Reading History (Latest Reading/Day)</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="table-export-btn" onclick="exportDetailedHistory()">â¬‡ï¸ Download Table (CSV)</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <p style="text-align: center; font-style: italic; color: #555;">Showing the **latest recorded reading** for each person on a given day across the last 30 days. For a full export, please use the download button above.</p>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="overallAveragesContainer">
Â  Â  Â  Â  Â  Â  <div style="display:flex; justify-content:space-between; align-items:center;">
Â  Â  Â  Â  Â  Â  Â  Â  <h2>ğŸ“ˆ Overall Averages Summary</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="table-export-btn" onclick="exportOverallAverages()">â¬‡ï¸ Download Table (CSV)</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  </div>

Â  Â  <script type="module">
Â  Â  Â  Â  // Make functions global for inline onclick handlers
Â  Â  Â  Â  window.login = login;
Â  Â  Â  Â  window.signup = signup;
Â  Â  Â  Â  window.logout = logout;
Â  Â  Â  Â  window.toggleSignupMode = toggleSignupMode;Â 
Â  Â  Â  Â  window.handlePersonChange = handlePersonChange;
Â  Â  Â  Â  window.handleCustomNameBlur = handleCustomNameBlur;Â 
Â  Â  Â  Â  window.addReading = addReading;
Â  Â  Â  Â  window.updateReading = updateReading; // New global function
Â  Â  Â  Â  window.editReading = editReading;Â  Â  Â // New global function
Â  Â  Â  Â  window.deleteReading = deleteReading;
Â  Â  Â  Â  window.loadReadings = loadReadings;Â 
Â  Â  Â  Â  window.exportFullHistory = exportFullHistory;Â 
Â  Â  Â  Â  window.exportDetailedHistory = exportDetailedHistory;Â 
Â  Â  Â  Â  window.exportOverallAverages = exportOverallAverages;Â 

Â  Â  Â  Â  // Import Firebase modules
Â  Â  Â  Â  import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.21.0/firebase-app.js';
Â  Â  Â  Â  import { getDatabase, ref, set, onValue, push, update, remove } from 'https://www.gstatic.com/firebasejs/9.21.0/firebase-database.js';
Â  Â  Â  Â  import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.21.0/firebase-auth.js';

Â  Â  Â  Â  // Your web app's Firebase configuration (CONFIRMED)
Â  Â  Â  Â  const firebaseConfig = {
Â  Â  Â  Â  Â  Â  apiKey: "AIzaSyAjRB8_dLv8icceOyZNNGO9kIXUFVjWfoY",
Â  Â  Â  Â  Â  Â  authDomain: "medicine-tracker-b90f2.firebaseapp.com",
Â  Â  Â  Â  Â  Â  databaseURL: "https://medicine-tracker-b90f2-default-rtdb.firebaseio.com",
Â  Â  Â  Â  Â  Â  projectId: "medicine-tracker-b90f2",
Â  Â  Â  Â  Â  Â  storageBucket: "medicine-tracker-b90f2.firebasestorage.app",
Â  Â  Â  Â  Â  Â  messagingSenderId: "230127910329",
Â  Â  Â  Â  Â  Â  appId: "1:230127910329:web:756789fcd3a1ac02948a68"
Â  Â  Â  Â  };

Â  Â  Â  Â  // Initialize Firebase
Â  Â  Â  Â  const app = initializeApp(firebaseConfig);
Â  Â  Â  Â  const db = getDatabase(app);
Â  Â  Â  Â  const auth = getAuth(app);

Â  Â  Â  Â  let currentUser = null;
Â  Â  Â  Â  let allReadings = [];
Â  Â  Â  Â  let allPersonAveragesCache = {}; // Cache for overall averages
Â  Â  Â  Â  let detailedHistoryDataCache = {}; // Cache for detailed history data
Â  Â  Â  Â  let personNames = new Set();
Â  Â  Â  Â  let currentPerson = '';
Â  Â  Â  Â  const today = new Date();
Â  Â  Â  Â  document.getElementById('recordDate').value = today.toISOString().split('T')[0];
Â  Â  Â  Â  document.getElementById('recordTime').value = today.toTimeString().split(' ')[0].substring(0, 5);Â 
Â  Â  Â  Â  const todayDateString = today.toISOString().split('T')[0];


Â  Â  Â  Â  // --- UTILITY: Date Formatting (DD-MMM-YY) ---
Â  Â  Â  Â  function formatDate(dateString) {
Â  Â  Â  Â  Â  Â  if (!dateString) return '';
Â  Â  Â  Â  Â  Â  // Use date only part to prevent timezone shift issues on Date object creation
Â  Â  Â  Â  Â  Â  const date = new Date(dateString + 'T00:00:00');Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const day = date.getDate().toString().padStart(2, '0');
Â  Â  Â  Â  Â  Â  const year = date.getFullYear().toString().slice(-2);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const monthNames = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
Â  Â  Â  Â  Â  Â  const month = monthNames[date.getMonth()];

Â  Â  Â  Â  Â  Â  return `${day}-${month}-${year}`;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- AUTH & SYNC ---
Â  Â  Â  Â  function toggleSignupMode() {
Â  Â  Â  Â  Â  Â  const container = document.getElementById('authContainer');
Â  Â  Â  Â  Â  Â  const toggleBtn = document.getElementById('signupToggleBtn');
Â  Â  Â  Â  Â  Â  const loginBtn = document.getElementById('loginBtn');
Â  Â  Â  Â  Â  Â  const isSignupMode = container.classList.contains('signup-mode');

Â  Â  Â  Â  Â  Â  if (isSignupMode) {
Â  Â  Â  Â  Â  Â  Â  Â  container.classList.remove('signup-mode');
Â  Â  Â  Â  Â  Â  Â  Â  toggleBtn.textContent = 'Sign Up';
Â  Â  Â  Â  Â  Â  Â  Â  toggleBtn.onclick = toggleSignupMode;
Â  Â  Â  Â  Â  Â  Â  Â  loginBtn.onclick = login;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  container.classList.add('signup-mode');
Â  Â  Â  Â  Â  Â  Â  Â  toggleBtn.textContent = 'Register';
Â  Â  Â  Â  Â  Â  Â  Â  toggleBtn.onclick = signup;
Â  Â  Â  Â  Â  Â  Â  Â  loginBtn.onclick = () => { container.classList.remove('signup-mode'); login(); };
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  document.getElementById('authError').textContent = '';
Â  Â  Â  Â  }

Â  Â  Â  Â  function login() {
Â  Â  Â  Â  Â  Â  const email = document.getElementById('email').value;
Â  Â  Â  Â  Â  Â  const password = document.getElementById('password').value;
Â  Â  Â  Â  Â  Â  const errorEl = document.getElementById('authError');
Â  Â  Â  Â  Â  Â  if (!email || !password) { errorEl.textContent = 'Please enter email and password'; return; }

Â  Â  Â  Â  Â  Â  signInWithEmailAndPassword(auth, email, password)
Â  Â  Â  Â  Â  Â  Â  Â  .then((userCredential) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentUser = userCredential.user;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  errorEl.textContent = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showApp();
Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  .catch((error) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  errorEl.textContent = 'Login failed: ' + error.message;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  function signup() {
Â  Â  Â  Â  Â  Â  const name = document.getElementById('name').value;
Â  Â  Â  Â  Â  Â  const email = document.getElementById('email').value;
Â  Â  Â  Â  Â  Â  const password = document.getElementById('password').value;
Â  Â  Â  Â  Â  Â  const confirmPassword = document.getElementById('confirmPassword').value;
Â  Â  Â  Â  Â  Â  const errorEl = document.getElementById('authError');

Â  Â  Â  Â  Â  Â  if (!name || !email || !password || !confirmPassword || password !== confirmPassword) {
Â  Â  Â  Â  Â  Â  Â  Â  errorEl.textContent = 'Please check all fields and ensure passwords match.';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  createUserWithEmailAndPassword(auth, email, password)
Â  Â  Â  Â  Â  Â  Â  Â  .then((userCredential) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentUser = userCredential.user;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const userRef = ref(db, 'users/' + currentUser.uid + '/profile');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  set(userRef, { name: name, email: email }).then(() => showApp());
Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  .catch((error) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  errorEl.textContent = 'Signup failed: ' + error.message;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  function logout() {
Â  Â  Â  Â  Â  Â  if (confirm('Logout?')) {
Â  Â  Â  Â  Â  Â  Â  Â  signOut(auth).then(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentUser = null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showLogin();
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function showLogin() {
Â  Â  Â  Â  Â  Â  document.getElementById('authContainer').style.display = 'block';
Â  Â  Â  Â  Â  Â  document.getElementById('appContainer').style.display = 'none';
Â  Â  Â  Â  }

Â  Â  Â  Â  function showApp() {
Â  Â  Â  Â  Â  Â  document.getElementById('authContainer').style.display = 'none';
Â  Â  Â  Â  Â  Â  document.getElementById('appContainer').style.display = 'block';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const profileRef = ref(db, 'users/' + currentUser.uid + '/profile/name');
Â  Â  Â  Â  Â  Â  onValue(profileRef, (snapshot) => {
Â  Â  Â  Â  Â  Â  Â  Â  const userName = snapshot.val();
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('userEmail').textContent = userName || currentUser.email;
Â  Â  Â  Â  Â  Â  }, { onlyOnce: true });

Â  Â  Â  Â  Â  Â  setupRealtimeSync();Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  onAuthStateChanged(auth, (user) => {
Â  Â  Â  Â  Â  Â  if (user) {
Â  Â  Â  Â  Â  Â  Â  Â  currentUser = user;
Â  Â  Â  Â  Â  Â  Â  Â  showApp();
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  currentUser = null;
Â  Â  Â  Â  Â  Â  Â  Â  showLogin();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  let syncListener = null;
Â  Â  Â  Â  function setupRealtimeSync() {
Â  Â  Â  Â  Â  Â  if (!currentUser) return;
Â  Â  Â  Â  Â  Â  if (syncListener) syncListener();Â 

Â  Â  Â  Â  Â  Â  // Path check is critical
Â  Â  Â  Â  Â  Â  const readingsRef = ref(db, 'users/' + currentUser.uid + '/healthReadings');

Â  Â  Â  Â  Â  Â  syncListener = onValue(readingsRef, (snapshot) => {
Â  Â  Â  Â  Â  Â  Â  Â  const data = snapshot.val();Â 
Â  Â  Â  Â  Â  Â  Â  Â  allReadings = [];
Â  Â  Â  Â  Â  Â  Â  Â  personNames.clear();

Â  Â  Â  Â  Â  Â  Â  Â  if (data) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for (const key in data) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const reading = { id: key, ...data[key] };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  allReadings.push(reading);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (reading.person) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  personNames.add(reading.person);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  // Sort by date and then time descending
Â  Â  Â  Â  Â  Â  Â  Â  allReadings.sort((a, b) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Normalize time to handle potential undefined fields
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dateA = new Date(a.date + ' ' + (a.time || '00:00'));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dateB = new Date(b.date + ' ' + (b.time || '00:00'));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return dateB - dateA;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // **CRITICAL FIX:** Ensure currentPerson is set based on first available data person, or the highest sorted name
Â  Â  Â  Â  Â  Â  Â  Â  const sortedNames = Array.from(personNames).sort();
Â  Â  Â  Â  Â  Â  Â  Â  if (sortedNames.length > 0 && (!currentPerson || !personNames.has(currentPerson))) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentPerson = sortedNames[0]; // Set to the first person name available
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updatePersonDropdown(true);Â 
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updatePersonDropdown();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // CRITICAL STEP: Call the main display function after data sync and initialization
Â  Â  Â  Â  Â  Â  Â  Â  loadReadings();Â 
Â  Â  Â  Â  Â  Â  Â  Â  resetForm(); // Reset form state after sync

Â  Â  Â  Â  Â  Â  }, (error) => {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Real-time sync error: Failed to read from database. Check Firebase Security Rules.', error);
Â  Â  Â  Â  Â  Â  Â  Â  // Clear UI on critical failure
Â  Â  Â  Â  Â  Â  Â  Â  loadReadings();Â 
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- PERSON MANAGEMENT ---
Â  Â  Â  Â  function updatePersonDropdown(forceSelect = false) {
Â  Â  Â  Â  Â  Â  const select = document.getElementById('personSelect');
Â  Â  Â  Â  Â  Â  const customInput = document.getElementById('personCustomInput');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  select.innerHTML = '';
Â  Â  Â  Â  Â  Â  select.innerHTML += `<option value="" disabled selected>Select a person...</option>`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const sortedNames = Array.from(personNames).sort();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Re-check currentPerson against the newly synced names
Â  Â  Â  Â  Â  Â  if (!currentPerson || !personNames.has(currentPerson)) {
Â  Â  Â  Â  Â  Â  Â  Â  if (sortedNames.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentPerson = sortedNames[0]; // If the current selection is gone, pick the first one
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  forceSelect = true;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentPerson = '';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  sortedNames.forEach(name => {
Â  Â  Â  Â  Â  Â  Â  Â  const option = document.createElement('option');
Â  Â  Â  Â  Â  Â  Â  Â  option.value = name;
Â  Â  Â  Â  Â  Â  Â  Â  option.textContent = name;
Â  Â  Â  Â  Â  Â  Â  Â  if (forceSelect && name === currentPerson) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â option.selected = true;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  select.appendChild(option);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const customOption = document.createElement('option');
Â  Â  Â  Â  Â  Â  customOption.value = "Custom";
Â  Â  Â  Â  Â  Â  customOption.textContent = "Add New Person...";
Â  Â  Â  Â  Â  Â  select.appendChild(customOption);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (currentPerson && !forceSelect) {
Â  Â  Â  Â  Â  Â  Â  Â  select.value = currentPerson;
Â  Â  Â  Â  Â  Â  } else if (!currentPerson) {
Â  Â  Â  Â  Â  Â  Â  Â  select.value = "";
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (select.value === 'Custom') {
Â  Â  Â  Â  Â  Â  Â  Â  customInput.style.display = 'block';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  customInput.style.display = 'none';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function handlePersonChange(value) {
Â  Â  Â  Â  Â  Â  const customInput = document.getElementById('personCustomInput');
Â  Â  Â  Â  Â  Â  if (value === 'Custom') {
Â  Â  Â  Â  Â  Â  Â  Â  customInput.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  customInput.value = '';
Â  Â  Â  Â  Â  Â  Â  Â  customInput.focus();
Â  Â  Â  Â  Â  Â  } else if (value) {
Â  Â  Â  Â  Â  Â  Â  Â  currentPerson = value;
Â  Â  Â  Â  Â  Â  Â  Â  customInput.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  loadReadings();Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function handleCustomNameBlur(value) {
Â  Â  Â  Â  Â  Â  const newName = value.trim();
Â  Â  Â  Â  Â  Â  const select = document.getElementById('personSelect');
Â  Â  Â  Â  Â  Â  const customInput = document.getElementById('personCustomInput');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (newName) {
Â  Â  Â  Â  Â  Â  Â  Â  currentPerson = newName;
Â  Â  Â  Â  Â  Â  Â  Â  personNames.add(newName);
Â  Â  Â  Â  Â  Â  Â  Â  updatePersonDropdown(true);
Â  Â  Â  Â  Â  Â  Â  Â  customInput.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  loadReadings();
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  if (currentPerson) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  select.value = currentPerson;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  select.value = "";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  customInput.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- FORM STATE MANAGEMENT ---
Â  Â  Â  Â  function resetForm() {
Â  Â  Â  Â  Â  Â  const now = new Date();
Â  Â  Â  Â  Â  Â  document.getElementById('recordDate').value = now.toISOString().split('T')[0];
Â  Â  Â  Â  Â  Â  document.getElementById('recordTime').value = now.toTimeString().split(' ')[0].substring(0, 5);Â 
Â  Â  Â  Â  Â  Â  document.getElementById('systole').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('diastole').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('glucose').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('weight').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('readingIdToEdit').value = '';

Â  Â  Â  Â  Â  Â  document.getElementById('addButton').style.display = 'block';
Â  Â  Â  Â  Â  Â  document.getElementById('updateButton').style.display = 'none';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Re-select the current person if one exists, otherwise keep "Select a person..."
Â  Â  Â  Â  Â  Â  if (currentPerson) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('personSelect').value = currentPerson;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â document.getElementById('personSelect').value = '';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }


Â  Â  Â  Â  // --- CORE CRUD & UI LOGIC ---

Â  Â  Â  Â  function getReadingData(isUpdate = false) {
Â  Â  Â  Â  Â  Â  if (!currentUser || !currentPerson) {
Â  Â  Â  Â  Â  Â  Â  Â  alert("Please select or enter a person's name first.");
Â  Â  Â  Â  Â  Â  Â  Â  return null;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const date = document.getElementById('recordDate').value;
Â  Â  Â  Â  Â  Â  const time = document.getElementById('recordTime').value;
Â  Â  Â  Â  Â  Â  const systoleValue = document.getElementById('systole').value;
Â  Â  Â  Â  Â  Â  const diastoleValue = document.getElementById('diastole').value;
Â  Â  Â  Â  Â  Â  const glucoseValue = document.getElementById('glucose').value;
Â  Â  Â  Â  Â  Â  const weightValue = document.getElementById('weight').value;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const systole = Number(systoleValue) || null;
Â  Â  Â  Â  Â  Â  const diastole = Number(diastoleValue) || null;
Â  Â  Â  Â  Â  Â  const glucose = Number(glucoseValue) || null;
Â  Â  Â  Â  Â  Â  const weight = Number(weightValue) || null;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!date || !time) {
Â  Â  Â  Â  Â  Â  Â  Â  alert("Please enter both date and time.");
Â  Â  Â  Â  Â  Â  Â  Â  return null;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (!systole && !diastole && !glucose && !weight) {
Â  Â  Â  Â  Â  Â  Â  Â  alert("Please enter at least one reading.");
Â  Â  Â  Â  Â  Â  Â  Â  return null;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const readingData = {
Â  Â  Â  Â  Â  Â  Â  Â  date: date,
Â  Â  Â  Â  Â  Â  Â  Â  time: time,
Â  Â  Â  Â  Â  Â  Â  Â  person: currentPerson,
Â  Â  Â  Â  Â  Â  Â  Â  systole: systole,
Â  Â  Â  Â  Â  Â  Â  Â  diastole: diastole,
Â  Â  Â  Â  Â  Â  Â  Â  glucose: glucose,
Â  Â  Â  Â  Â  Â  Â  Â  weight: weight,
Â  Â  Â  Â  Â  Â  Â  Â  timestamp: new Date(date + 'T' + time).getTime() 
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  if (isUpdate) {
Â  Â  Â  Â  Â  Â  Â  Â  const id = document.getElementById('readingIdToEdit').value;
Â  Â  Â  Â  Â  Â  Â  Â  if (!id) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert("Error: Reading ID missing for update.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return null;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  readingData.id = id;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  return readingData;
Â  Â  Â  Â  }

Â  Â  Â  Â  function addReading() {
Â  Â  Â  Â  Â  Â  const data = getReadingData();
Â  Â  Â  Â  Â  Â  if (!data) return;

Â  Â  Â  Â  Â  Â  const readingsListRef = ref(db, 'users/' + currentUser.uid + '/healthReadings');
Â  Â  Â  Â  Â  Â  const newReadingRef = push(readingsListRef);
Â  Â  Â  Â  Â  Â  set(newReadingRef, data)
Â  Â  Â  Â  Â  Â  Â  Â  .then(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log("Reading added successfully");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resetForm();
Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  .catch((error) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert("Error saving reading: " + error.message);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  function editReading(id) {
Â  Â  Â  Â  Â  Â  const reading = allReadings.find(r => r.id === id);
Â  Â  Â  Â  Â  Â  if (!reading) {
Â  Â  Â  Â  Â  Â  Â  Â  alert("Reading not found.");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  document.getElementById('readingIdToEdit').value = reading.id;
Â  Â  Â  Â  Â  Â  document.getElementById('recordDate').value = reading.date;
Â  Â  Â  Â  Â  Â  document.getElementById('recordTime').value = reading.time;
Â  Â  Â  Â  Â  Â  document.getElementById('systole').value = reading.systole || '';
Â  Â  Â  Â  Â  Â  document.getElementById('diastole').value = reading.diastole || '';
Â  Â  Â  Â  Â  Â  document.getElementById('glucose').value = reading.glucose || '';
Â  Â  Â  Â  Â  Â  document.getElementById('weight').value = reading.weight || '';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Select the correct person and disable selection during edit
Â  Â  Â  Â  Â  Â  const personSelect = document.getElementById('personSelect');
Â  Â  Â  Â  Â  Â  personSelect.value = reading.person;
Â  Â  Â  Â  Â  Â  personSelect.disabled = true; 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  document.getElementById('addButton').style.display = 'none';
Â  Â  Â  Â  Â  Â  document.getElementById('updateButton').style.display = 'block';

Â  Â  Â  Â  Â  Â  // Scroll to the top input form
Â  Â  Â  Â  Â  Â  window.scrollTo({ top: 0, behavior: 'smooth' });
Â  Â  Â  Â  }

Â  Â  Â  Â  function updateReading() {
Â  Â  Â  Â  Â  Â  const data = getReadingData(true);
Â  Â  Â  Â  Â  Â  if (!data) return;

Â  Â  Â  Â  Â  Â  // Ensure person select is re-enabled before the update finishes
Â  Â  Â  Â  Â  Â  document.getElementById('personSelect').disabled = false;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const readingRef = ref(db, 'users/' + currentUser.uid + '/healthReadings/' + data.id);
Â  Â  Â  Â  Â  Â  // Remove the 'id' field before updating Firebase
Â  Â  Â  Â  Â  Â  delete data.id; 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  set(readingRef, data) // Use set to overwrite the entire reading
Â  Â  Â  Â  Â  Â  Â  Â  .then(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log("Reading updated successfully");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resetForm();
Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  .catch((error) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert("Error updating reading: " + error.message);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  function deleteReading(id) {
Â  Â  Â  Â  Â  Â  if (!confirm("Are you sure you want to delete this reading?")) return;

Â  Â  Â  Â  Â  Â  const readingRef = ref(db, 'users/' + currentUser.uid + '/healthReadings/' + id);
Â  Â  Â  Â  Â  Â  remove(readingRef)
Â  Â  Â  Â  Â  Â  Â  Â  .then(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log("Reading deleted successfully");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resetForm();
Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  .catch((error) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert("Error deleting reading: " + error.message);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }


Â  Â  Â  Â  // --- UI RENDERING LOGIC ---

Â  Â  Â  Â  function loadReadings() {
Â  Â  Â  Â  Â  Â  // 1. Render Today's Readings
Â  Â  Â  Â  Â  Â  renderTodayReadings(allReadings.filter(r => r.date === todayDateString));

Â  Â  Â  Â  Â  Â  // 2. Calculate and Render Overall Averages
Â  Â  Â  Â  Â  Â  const overallAveragesData = calculateOverallAverages(allReadings);
Â  Â  Â  Â  Â  Â  renderOverallAverages(overallAveragesData);

Â  Â  Â  Â  Â  Â  // 3. Render Detailed 30-Day History
Â  Â  Â  Â  Â  Â  const detailedHistory = calculateDetailedHistory(allReadings, Array.from(personNames));
Â  Â  Â  Â  Â  Â  renderDetailedHistory(detailedHistory, Array.from(personNames));
Â  Â  Â  Â  }

Â  Â  Â  Â  // Helper to calculate averages (Systole/Diastole/Glucose/Weight)
Â  Â  Â  Â  function calculateAverages(readings) {
Â  Â  Â  Â  Â  Â  const sums = { systole: 0, diastole: 0, glucose: 0, weight: 0 };
Â  Â  Â  Â  Â  Â  const counts = { systole: 0, diastole: 0, glucose: 0, weight: 0 };

Â  Â  Â  Â  Â  Â  readings.forEach(r => {
Â  Â  Â  Â  Â  Â  Â  Â  if (r.systole) { sums.systole += r.systole; counts.systole++; }
Â  Â  Â  Â  Â  Â  Â  Â  if (r.diastole) { sums.diastole += r.diastole; counts.diastole++; }
Â  Â  Â  Â  Â  Â  Â  Â  if (r.glucose) { sums.glucose += r.glucose; counts.glucose++; }
Â  Â  Â  Â  Â  Â  Â  Â  if (r.weight) { sums.weight += r.weight; counts.weight++; }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  const averages = {};
Â  Â  Â  Â  Â  Â  averages.systole = counts.systole > 0 ? Math.round(sums.systole / counts.systole) : 'N/A';
Â  Â  Â  Â  Â  Â  averages.diastole = counts.diastole > 0 ? Math.round(sums.diastole / counts.diastole) : 'N/A';
Â  Â  Â  Â  Â  Â  averages.glucose = counts.glucose > 0 ? (sums.glucose / counts.glucose).toFixed(1) : 'N/A';
Â  Â  Â  Â  Â  Â  averages.weight = counts.weight > 0 ? (sums.weight / counts.weight).toFixed(1) : 'N/A';

Â  Â  Â  Â  Â  Â  return averages;
Â  Â  Â  Â  }


Â  Â  Â  Â  function calculateOverallAverages(readings) {
Â  Â  Â  Â  Â  Â  const grouped = {};
Â  Â  Â  Â  Â  Â  personNames.forEach(name => {
Â  Â  Â  Â  Â  Â  Â  Â  grouped[name] = readings.filter(r => r.person === name);
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  const results = {};
Â  Â  Â  Â  Â  Â  for (const person in grouped) {
Â  Â  Â  Â  Â  Â  Â  Â  results[person] = calculateAverages(grouped[person]);
Â  Â  Â  Â  Â  Â  Â  Â  results[person].count = grouped[person].length;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  allPersonAveragesCache = results; // Cache for export
Â  Â  Â  Â  Â  Â  return results;
Â  Â  Â  Â  }


Â  Â  Â  Â  function renderOverallAverages(averages) {
Â  Â  Â  Â  Â  Â  const container = document.getElementById('overallAveragesContainer');
Â  Â  Â  Â  Â  Â  const persons = Object.keys(averages).sort();

Â  Â  Â  Â  Â  Â  if (persons.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  container.innerHTML = '<h2>ğŸ“ˆ Overall Averages Summary</h2><p class="no-data">No data available yet.</p>';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let tableHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <table class="data-table" id="overallAveragesTable">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th rowspan="2">Person</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th colspan="2">Blood Pressure (BP)</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th rowspan="2">Glucose (mg/dL)</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th rowspan="2">Weight (kg/lbs)</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th rowspan="2">Readings Count</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Systolic (Avg)</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Diastolic (Avg)</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody>
Â  Â  Â  Â  Â  Â  `;

Â  Â  Â  Â  Â  Â  persons.forEach(person => {
Â  Â  Â  Â  Â  Â  Â  Â  const avg = averages[person];
Â  Â  Â  Â  Â  Â  Â  Â  tableHTML += `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr data-person="${person}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th data-label="Person">${person}</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td data-label="Systolic (Avg)"><span class="avg-bp">${avg.systole}</span></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td data-label="Diastolic (Avg)"><span class="avg-bp">${avg.diastole}</span></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td data-label="Glucose (Avg)"><span class="avg-reading">${avg.glucose}</span></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td data-label="Weight (Avg)"><span class="avg-reading">${avg.weight}</span></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td data-label="Readings Count">${avg.count}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  tableHTML += `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Preserve the title and button, only replace the table area
Â  Â  Â  Â  Â  Â  container.innerHTML = container.innerHTML.split('</div>')[0] + '</div>' + tableHTML;
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderTodayReadings(readings) {
Â  Â  Â  Â  Â  Â  const container = document.getElementById('todayAveragesContainer');
Â  Â  Â  Â  Â  Â  container.innerHTML = `<h2>â˜€ï¸ Today's Individual Readings (${todayDateString})</h2>`;

Â  Â  Â  Â  Â  Â  if (readings.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  container.innerHTML += '<p class="no-data">No readings recorded today.</p>';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Group by person and then sort by time
Â  Â  Â  Â  Â  Â  const groupedByPerson = {};
Â  Â  Â  Â  Â  Â  readings.forEach(r => {
Â  Â  Â  Â  Â  Â  Â  Â  if (!groupedByPerson[r.time]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  groupedByPerson[r.time] = [];
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  groupedByPerson[r.time].push(r);
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  const sortedTimes = Object.keys(groupedByPerson).sort();
Â  Â  Â  Â  Â  Â  const persons = Array.from(personNames).sort();

Â  Â  Â  Â  Â  Â  let tableHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <table class="data-table" id="todayReadingsTable">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th rowspan="2">Time</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th colspan="${persons.length * 2}" style="white-space:normal;">Readings by Person</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${persons.map(p => `<th colspan="2" data-person-name="${p}">${p}</th>`).join('')}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  sortedTimes.forEach(time => {
Â  Â  Â  Â  Â  Â  Â  Â  tableHTML += '<tr>';
Â  Â  Â  Â  Â  Â  Â  Â  tableHTML += `<th data-label="Time">${time}</th>`;

Â  Â  Â  Â  Â  Â  Â  Â  // Map person data for this time slot
Â  Â  Â  Â  Â  Â  Â  Â  persons.forEach(person => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const reading = groupedByPerson[time].find(r => r.person === person);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (reading) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Systolic / Diastolic
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const bp = reading.systole && reading.diastole ? `${reading.systole}/${reading.diastole}` : 'N/A';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Action buttons (only need one set)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const actions = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="action-btn edit-btn" onclick="editReading('${reading.id}')">Edit</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="action-btn delete-btn" onclick="deleteReading('${reading.id}')">Del</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // BP (Systolic/Diastolic and Pulse/Weight combined for better mobile stacking)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tableHTML += `<td colspan="2" data-person="${person}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-reading"><strong style="color:#1a4f78;">BP:</strong> ${bp}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-reading"><strong style="color:#4CAF50;">Glu:</strong> ${reading.glucose || 'N/A'}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-reading"><strong style="color:#FF9800;">Wt:</strong> ${reading.weight || 'N/A'}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-reading actions-today" style="margin-top: 5px;">${actions}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tableHTML += `<td colspan="2" class="no-data" data-person="${person}">---</td>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  tableHTML += '</tr>';
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  tableHTML += `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  container.innerHTML += tableHTML;
Â  Â  Â  Â  }

Â  Â  Â  Â  function calculateDetailedHistory(readings, persons) {
Â  Â  Â  Â  Â  Â  const today = new Date();
Â  Â  Â  Â  Â  Â  const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
Â  Â  Â  Â  Â  Â  const history = {}; // Key: date (YYYY-MM-DD), Value: { personName: latestReading }

Â  Â  Â  Â  Â  Â  readings.filter(r => new Date(r.date) >= thirtyDaysAgo).forEach(reading => {
Â  Â  Â  Â  Â  Â  Â  Â  const dateKey = reading.date;
Â  Â  Â  Â  Â  Â  Â  Â  const personKey = reading.person;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (!history[dateKey]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  history[dateKey] = {};
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // Keep the reading with the latest timestamp on that day for that person
Â  Â  Â  Â  Â  Â  Â  Â  if (!history[dateKey][personKey] || reading.timestamp > history[dateKey][personKey].timestamp) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  history[dateKey][personKey] = reading;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  detailedHistoryDataCache = history; // Cache for export
Â  Â  Â  Â  Â  Â  return history;
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderDetailedHistory(history, persons) {
Â  Â  Â  Â  Â  Â  const container = document.getElementById('detailedHistoryContainer');
Â  Â  Â  Â  Â  Â  const sortedDates = Object.keys(history).sort().reverse();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (sortedDates.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  container.innerHTML = container.innerHTML.split('</p>')[0] + '</p>' + '<p class="no-data" style="text-align:center;">No history available for the last 30 days.</p>';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Filter persons to only include those with readings in the last 30 days
Â  Â  Â  Â  Â  Â  const activePersons = persons.filter(p => sortedDates.some(date => history[date][p]));

Â  Â  Â  Â  Â  Â  let tableHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <table class="data-table" id="detailedHistoryTable">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th rowspan="2">Date</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${activePersons.map(p => `<th colspan="5">${p}</th>`).join('')}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${activePersons.map(() => `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Time</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>BP</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Glucose</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Weight</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Action</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `).join('')}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody>
Â  Â  Â  Â  Â  Â  `;

Â  Â  Â  Â  Â  Â  sortedDates.forEach(dateKey => {
Â  Â  Â  Â  Â  Â  Â  Â  tableHTML += '<tr>';
Â  Â  Â  Â  Â  Â  Â  Â  tableHTML += `<th data-label="Date">${formatDate(dateKey)}</th>`;

Â  Â  Â  Â  Â  Â  Â  Â  activePersons.forEach(person => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const reading = history[dateKey][person];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (reading) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const bp = reading.systole && reading.diastole ? `${reading.systole}/${reading.diastole}` : 'N/A';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tableHTML += `<td data-label="${person} Time">${reading.time}</td>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tableHTML += `<td data-label="${person} BP">${bp}</td>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tableHTML += `<td data-label="${person} Glucose">${reading.glucose || 'N/A'}</td>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tableHTML += `<td data-label="${person} Weight">${reading.weight || 'N/A'}</td>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tableHTML += `<td data-label="${person} Action">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="action-btn edit-btn" onclick="editReading('${reading.id}')">Edit</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="action-btn delete-btn" onclick="deleteReading('${reading.id}')">Del</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Empty cells for persons with no data on this date
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tableHTML += `<td colspan="5" class="no-data">---</td>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  tableHTML += '</tr>';
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  tableHTML += `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Preserve the title, button, and description, only replace the table area
Â  Â  Â  Â  Â  Â  container.innerHTML = container.innerHTML.split('</p>')[0] + '</p>' + tableHTML;
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- EXPORT/CSV LOGIC ---

Â  Â  Â  Â  function exportToCSV(filename, data, header) {
Â  Â  Â  Â  Â  Â  let csv = header.join(',') + '\n';
Â  Â  Â  Â  Â  Â  data.forEach(row => {
Â  Â  Â  Â  Â  Â  Â  Â  csv += row.map(d => `"${d}"`).join(',') + '\n';
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
Â  Â  Â  Â  Â  Â  const link = document.createElement("a");
Â  Â  Â  Â  Â  Â  if (link.download !== undefined) {
Â  Â  Â  Â  Â  Â  Â  Â  const url = URL.createObjectURL(blob);
Â  Â  Â  Â  Â  Â  Â  Â  link.setAttribute("href", url);
Â  Â  Â  Â  Â  Â  Â  Â  link.setAttribute("download", filename);
Â  Â  Â  Â  Â  Â  Â  Â  link.style.visibility = 'hidden';
Â  Â  Â  Â  Â  Â  Â  Â  document.body.appendChild(link);
Â  Â  Â  Â  Â  Â  Â  Â  link.click();
Â  Â  Â  Â  Â  Â  Â  Â  document.body.removeChild(link);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function exportFullHistory() {
Â  Â  Â  Â  Â  Â  if (allReadings.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  alert("No data to export.");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const header = ['Date', 'Time', 'Person', 'Systolic (BP)', 'Diastolic (BP)', 'Glucose (mg/dL)', 'Weight (kg/lbs)', 'Timestamp'];
Â  Â  Â  Â  Â  Â  const data = allReadings.map(r => [
Â  Â  Â  Â  Â  Â  Â  Â  r.date,
Â  Â  Â  Â  Â  Â  Â  Â  r.time,
Â  Â  Â  Â  Â  Â  Â  Â  r.person,
Â  Â  Â  Â  Â  Â  Â  Â  r.systole || '',
Â  Â  Â  Â  Â  Â  Â  Â  r.diastole || '',
Â  Â  Â  Â  Â  Â  Â  Â  r.glucose || '',
Â  Â  Â  Â  Â  Â  Â  Â  r.weight || '',
Â  Â  Â  Â  Â  Â  Â  Â  r.timestamp
Â  Â  Â  Â  Â  Â  ]);

Â  Â  Â  Â  Â  Â  exportToCSV('Health_Tracker_Full_History.csv', data, header);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function exportDetailedHistory() {
Â  Â  Â  Â  Â  Â  if (Object.keys(detailedHistoryDataCache).length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  alert("No 30-day history data to export.");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const activePersons = Array.from(personNames).filter(p => Object.keys(detailedHistoryDataCache).some(date => detailedHistoryDataCache[date][p]));
Â  Â  Â  Â  Â  Â  const sortedDates = Object.keys(detailedHistoryDataCache).sort().reverse();

Â  Â  Â  Â  Â  Â  const header = ['Date'];
Â  Â  Â  Â  Â  Â  activePersons.forEach(p => {
Â  Â  Â  Â  Â  Â  Â  Â  header.push(`${p} - Time`, `${p} - BP (Systolic/Diastolic)`, `${p} - Glucose (mg/dL)`, `${p} - Weight (kg/lbs)`);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const data = sortedDates.map(dateKey => {
Â  Â  Â  Â  Â  Â  Â  Â  const row = [dateKey];
Â  Â  Â  Â  Â  Â  Â  Â  activePersons.forEach(person => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const reading = detailedHistoryDataCache[dateKey][person];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (reading) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const bp = reading.systole && reading.diastole ? `${reading.systole}/${reading.diastole}` : '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  row.push(reading.time || '', bp, reading.glucose || '', reading.weight || '');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  row.push('', '', '', '');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  return row;
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  exportToCSV('Health_Tracker_30_Day_History.csv', data, header);
Â  Â  Â  Â  }

Â  Â  Â  Â  function exportOverallAverages() {
Â  Â  Â  Â  Â  Â  if (Object.keys(allPersonAveragesCache).length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  alert("No average data to export.");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const header = ['Person', 'Systolic (Avg)', 'Diastolic (Avg)', 'Glucose (Avg)', 'Weight (Avg)', 'Readings Count'];
Â  Â  Â  Â  Â  Â  const data = Object.keys(allPersonAveragesCache).sort().map(person => {
Â  Â  Â  Â  Â  Â  Â  Â  const avg = allPersonAveragesCache[person];
Â  Â  Â  Â  Â  Â  Â  Â  return [
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  person,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  avg.systole,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  avg.diastole,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  avg.glucose,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  avg.weight,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  avg.count
Â  Â  Â  Â  Â  Â  Â  Â  ];
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  exportToCSV('Health_Tracker_Overall_Averages.csv', data, header);
Â  Â  Â  Â  }
Â  Â  </script>
</body>
</html>
