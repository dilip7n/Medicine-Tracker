<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Holistic Health Tracker (BP/Glucose)</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚ù§Ô∏è</text></svg>">
    <style>
        /* Global & Reset */
        * {
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 1000px;
            margin: 0 auto;
            background-color: #f7f9fc;
        }

        h1 {
            color: #1a4f78;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }

        /* Controls and Inputs */
        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }
        
        .controls label {
            font-weight: bold;
            display: block;
            margin-top: 5px;
            color: #555;
            margin-bottom: 5px;
        }
        
        .controls input[type="date"],
        .controls input[type="time"], /* Added time input */
        .controls input[type="number"],
        .controls input[type="text"],
        .controls select,
        #personSelect {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            width: 100%;
        }

        /* GRID FIXES for Alignment */
        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); /* Adjusted minimum width for more columns */
            gap: 20px;
            margin-bottom: 15px;
            align-items: start;
        }
        
        /* Person Input Group Styling */
        .person-input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        #personCustomInput {
            margin-top: 0;
            display: none;
        }

        /* Buttons */
        button {
            padding: 10px 20px;
            margin-top: 10px;
            cursor: pointer;
            font-size: 16px;
            border: none;
            border-radius: 4px;
        }

        .add {
            background: #4CAF50;
            color: white;
        }
        
        .logout-btn {
            background: #f44336;
            color: white;
            padding: 5px 15px;
            font-size: 14px;
        }
        
        /* Summary Section */
        #summaryContainer {
            margin-top: 20px;
            padding: 15px;
            background: #e3f2fd; 
            border-radius: 8px;
            border-left: 5px solid #2196F3;
            color: #1a4f78;
            font-size: 1.1em;
        }

        .summary-metric {
            margin-top: 10px;
            border-top: 1px dashed #bbdefb;
            padding-top: 5px;
        }
        .summary-metric h3 {
            margin-bottom: 5px;
            font-size: 1.2em;
            color: #0d47a1;
        }
        
        .summary-metric p {
            margin: 5px 0;
            padding-left: 10px;
        }

        /* Reading List */
        #readingList {
            margin-top: 30px;
        }
        
        .reading-card {
            background: white;
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #4CAF50;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .reading-card-content {
            flex-grow: 1;
        }

        .reading-card-content strong {
            display: block;
            font-size: 1.1em;
            color: #333;
        }

        .reading-card-content span {
            color: #777;
            font-size: 0.9em;
        }

        .reading-card-actions button {
            background: #f44336;
            color: white;
            padding: 5px 10px;
            margin-left: 10px;
            font-size: 12px;
        }

        /* Auth Styles */
        #authContainer {
            max-width:400px; margin:50px auto; padding:30px; background:#f9f9f9; border-radius:10px;
        }
        .signup-fields { display: none; }
        #authContainer.signup-mode .signup-fields { display: block; }
    </style>
</head>
<body>
    <div id="authContainer" style="display:none;">
        <h2>üîí Health Tracker Access</h2>
        <div style="margin:20px 0;">
            <div class="signup-fields">
                <input type="text" id="name" placeholder="Your Name" style="width:100%; padding:10px; margin:5px 0; box-sizing:border-box;">
            </div>
            <input type="email" id="email" placeholder="Email" style="width:100%; padding:10px; margin:5px 0; box-sizing:border-box;">
            <input type="password" id="password" placeholder="Password (min 6 chars)" style="width:100%; padding:10px; margin:5px 0; box-sizing:border-box;">
            <div class="signup-fields">
                <input type="password" id="confirmPassword" placeholder="Confirm Password" style="width:100%; padding:10px; margin:5px 0; box-sizing:border-box;">
            </div>
        </div>
        <button class="add" onclick="login()" style="width:48%; margin:2%;" id="loginBtn">Login</button>
        <button class="export" onclick="toggleSignupMode()" style="width:48%; margin:2%;" id="signupToggleBtn">Sign Up</button>
        <div id="authError" style="color:red; margin-top:10px;"></div>
    </div>

    <div id="appContainer" style="display:none;">
        <div style="text-align:right; margin-bottom:20px; display:flex; justify-content:flex-end; align-items:center;">
            <span id="userEmail" style="margin-right:10px; font-weight:bold;"></span>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
        
        <h1>‚ù§Ô∏è Daily Health Readings</h1>
        
        <div class="controls">
            <h2>Record a New Reading</h2>
            <div class="input-grid">
                <div class="input-group">
                    <label for="recordDate">Date</label>
                    <input type="date" id="recordDate">
                </div>
                
                <div class="input-group">
                    <label for="recordTime">Time</label>
                    <input type="time" id="recordTime">
                </div>

                <div class="input-group">
                    <label for="personSelect">Person Name</label>
                    <div class="person-input-group">
                        <select id="personSelect" onchange="handlePersonChange(this.value)">
                            <option value="" disabled selected>Select a person...</option>
                            <option value="Custom">Add New Person...</option>
                        </select>
                        <input type="text" id="personCustomInput" placeholder="Enter new name here" onblur="handleCustomNameBlur(this.value)">
                    </div>
                </div>
                
                <div class="input-group">
                    <label for="systole">Systolic (BP)</label>
                    <input type="number" id="systole" placeholder="e.g., 120" step="1">
                </div>
                
                <div class="input-group">
                    <label for="diastole">Diastolic (BP)</label>
                    <input type="number" id="diastole" placeholder="e.g., 80" step="1">
                </div>

                <div class="input-group">
                    <label for="glucose">Glucose (mg/dL)</label>
                    <input type="number" id="glucose" placeholder="e.g., 100" step="0.1">
                </div>

                <div class="input-group">
                    <label for="weight">Weight (kg/lbs)</label>
                    <input type="number" id="weight" placeholder="e.g., 75" step="0.1">
                </div>
                
                </div>
            
            <button class="add" onclick="addReading()">Add Reading</button>
        </div>
        
        <div id="summaryContainer">
            <h2>Health Averages for <span id="currentPersonName">...</span></h2>
            <div class="summary-metric" id="bpSummary">
                <h3>ü©∫ Blood Pressure</h3>
            </div>
            <div class="summary-metric" id="glucoseSummary">
                <h3>ü©∏ Glucose</h3>
            </div>
            <div class="summary-metric" id="weightSummary">
                <h3>‚öñÔ∏è Weight</h3>
            </div>
        </div>

        <div id="readingList">
            <h2>Reading History</h2>
            </div>

    </div>

    <script type="module">
        // Make functions global for inline onclick handlers
        window.login = login;
        window.signup = signup;
        window.logout = logout;
        window.toggleSignupMode = toggleSignupMode; 
        window.handlePersonChange = handlePersonChange;
        window.handleCustomNameBlur = handleCustomNameBlur; 
        window.addReading = addReading;
        window.deleteReading = deleteReading;
        window.loadReadings = loadReadings; 

        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.21.0/firebase-app.js';
        import { getDatabase, ref, set, onValue, push, update, remove } from 'https://www.gstatic.com/firebasejs/9.21.0/firebase-database.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.21.0/firebase-auth.js';

        // Firebase configuration (REPLACE with your actual config)
        const firebaseConfig = {
            apiKey: "AIzaSyDYSBWvsWcfU4gfl2ECCJiKKxUgMjuvmF4", // REPLACE
            authDomain: "medicine-tracker-b90f2.firebaseapp.com", // REPLACE
            databaseURL: "https://medicine-tracker-b90f2-default-rtdb.firebaseio.com", // REPLACE
            projectId: "medicine-tracker-b90f2", // REPLACE
            storageBucket: "medicine-tracker-b90f2.firebasestorage.app", // REPLACE
            messagingSenderId: "230127910329", // REPLACE
            appId: "1:230127910329:web:114eea8f3846c446948a68" // REPLACE
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        let currentUser = null;
        let allReadings = [];
        let personNames = new Set();
        let currentPerson = '';
        const today = new Date();
        document.getElementById('recordDate').value = today.toISOString().split('T')[0];
        document.getElementById('recordTime').value = today.toTimeString().split(' ')[0].substring(0, 5); // Set default time

        // --- UTILITY: Date Formatting (DD-MMM-YY) ---
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString + 'T00:00:00'); // Append T00:00:00 for correct timezone interpretation
            const options = { day: '2-digit', month: 'short', year: '2-digit' };
            // Ensure month is uppercase (MMM)
            const formatted = date.toLocaleDateString('en-US', options);
            const parts = formatted.split('/');
            const day = parts[1];
            const monthYear = parts[0];
            const year = parts[2];
            return `${day}-${monthYear.toUpperCase()}-${year}`;
        }


        // --- AUTHENTICATION & SYNC (Unchanged) ---
        function toggleSignupMode() {
            const container = document.getElementById('authContainer');
            const toggleBtn = document.getElementById('signupToggleBtn');
            const loginBtn = document.getElementById('loginBtn');
            const isSignupMode = container.classList.contains('signup-mode');

            if (isSignupMode) {
                container.classList.remove('signup-mode');
                toggleBtn.textContent = 'Sign Up';
                toggleBtn.onclick = toggleSignupMode;
                loginBtn.onclick = login;
            } else {
                container.classList.add('signup-mode');
                toggleBtn.textContent = 'Register';
                toggleBtn.onclick = signup;
                loginBtn.onclick = () => { container.classList.remove('signup-mode'); login(); };
            }
            document.getElementById('authError').textContent = '';
        }

        function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorEl = document.getElementById('authError');
            if (!email || !password) { errorEl.textContent = 'Please enter email and password'; return; }

            signInWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    currentUser = userCredential.user;
                    errorEl.textContent = '';
                    showApp();
                })
                .catch((error) => {
                    errorEl.textContent = 'Login failed: ' + error.message;
                });
        }

        function signup() {
            const name = document.getElementById('name').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const errorEl = document.getElementById('authError');

            if (!name || !email || !password || !confirmPassword || password !== confirmPassword) {
                errorEl.textContent = 'Please check all fields and ensure passwords match.';
                return;
            }

            createUserWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    currentUser = userCredential.user;
                    const userRef = ref(db, 'users/' + currentUser.uid + '/profile');
                    set(userRef, { name: name, email: email }).then(() => showApp());
                })
                .catch((error) => {
                    errorEl.textContent = 'Signup failed: ' + error.message;
                });
        }

        function logout() {
            if (confirm('Logout?')) {
                signOut(auth).then(() => {
                    currentUser = null;
                    showLogin();
                });
            }
        }

        function showLogin() {
            document.getElementById('authContainer').style.display = 'block';
            document.getElementById('appContainer').style.display = 'none';
        }

        function showApp() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            
            const profileRef = ref(db, 'users/' + currentUser.uid + '/profile/name');
            onValue(profileRef, (snapshot) => {
                const userName = snapshot.val();
                document.getElementById('userEmail').textContent = userName || currentUser.email;
            }, { onlyOnce: true });

            setupRealtimeSync(); 
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                showApp();
            } else {
                currentUser = null;
                showLogin();
            }
        });

        let syncListener = null;
        function setupRealtimeSync() {
            if (!currentUser) return;
            if (syncListener) syncListener(); 

            const readingsRef = ref(db, 'users/' + currentUser.uid + '/healthReadings');

            syncListener = onValue(readingsRef, (snapshot) => {
                const data = snapshot.val(); 
                allReadings = [];
                personNames.clear();

                if (data) {
                    for (const key in data) {
                        const reading = { id: key, ...data[key] };
                        allReadings.push(reading);
                        if (reading.person) {
                            personNames.add(reading.person);
                        }
                    }
                }
                // Sort by date and then time (if time is available) descending
                allReadings.sort((a, b) => {
                    const dateA = new Date(a.date + ' ' + (a.time || '00:00'));
                    const dateB = new Date(b.date + ' ' + (b.time || '00:00'));
                    return dateB - dateA;
                });

                updatePersonDropdown();
                if (!currentPerson && allReadings.length > 0) {
                    currentPerson = allReadings[0].person;
                    updatePersonDropdown(true);
                }
                
                loadReadings(); 

            }, (error) => {
                console.error('Real-time sync error:', error);
            });
        }
        
        // --- PERSON MANAGEMENT (Unchanged) ---
        function updatePersonDropdown(forceSelect = false) {
            const select = document.getElementById('personSelect');
            const customInput = document.getElementById('personCustomInput');
            
            select.innerHTML = '';
            select.innerHTML += `<option value="" disabled>Select a person...</option>`;
            
            const sortedNames = Array.from(personNames).sort();
            sortedNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                if (forceSelect && name === currentPerson) {
                     option.selected = true;
                }
                select.appendChild(option);
            });
            
            const customOption = document.createElement('option');
            customOption.value = "Custom";
            customOption.textContent = "Add New Person...";
            select.appendChild(customOption);
            
            if (currentPerson && !forceSelect) {
                select.value = currentPerson;
            } else if (!currentPerson) {
                select.value = "";
            }

            if (select.value === 'Custom') {
                customInput.style.display = 'block';
            } else {
                customInput.style.display = 'none';
            }
            
            document.getElementById('currentPersonName').textContent = currentPerson || '...';
        }
        
        function handlePersonChange(value) {
            const customInput = document.getElementById('personCustomInput');
            if (value === 'Custom') {
                customInput.style.display = 'block';
                customInput.value = '';
                customInput.focus();
            } else if (value) {
                currentPerson = value;
                customInput.style.display = 'none';
                loadReadings();
            }
        }
        
        function handleCustomNameBlur(value) {
            const newName = value.trim();
            const select = document.getElementById('personSelect');
            const customInput = document.getElementById('personCustomInput');
            
            if (newName) {
                currentPerson = newName;
                personNames.add(newName);
                updatePersonDropdown(true);
                customInput.style.display = 'none';
                loadReadings();
            } else {
                if (currentPerson) {
                    select.value = currentPerson;
                } else {
                    select.value = "";
                    customInput.style.display = 'none';
                }
            }
        }
        

        // --- CORE CRUD & UI LOGIC (Updated to include Time) ---

        function addReading() {
            if (!currentUser || !currentPerson) {
                alert("Please select or enter a person's name first.");
                return;
            }
            
            const date = document.getElementById('recordDate').value;
            const time = document.getElementById('recordTime').value; // Get time value
            const systole = parseFloat(document.getElementById('systole').value);
            const diastole = parseFloat(document.getElementById('diastole').value);
            const glucose = parseFloat(document.getElementById('glucose').value);
            const weight = parseFloat(document.getElementById('weight').value);
            
            if (!date || !time) { // Check for time as well
                alert("Please enter both date and time.");
                return;
            }
            if (isNaN(systole) && isNaN(diastole) && isNaN(glucose) && isNaN(weight)) {
                alert("Please enter at least one reading.");
                return;
            }

            const newReading = {
                date: date, // YYYY-MM-DD format for storage/sorting
                time: time, // HH:MM format for storage/sorting
                person: currentPerson,
                systole: isNaN(systole) ? null : systole,
                diastole: isNaN(diastole) ? null : diastole,
                glucose: isNaN(glucose) ? null : glucose,
                weight: isNaN(weight) ? null : weight,
                timestamp: Date.now()
            };

            const readingsRef = ref(db, 'users/' + currentUser.uid + '/healthReadings');
            push(readingsRef, newReading)
                .then(() => {
                    // Clear inputs after successful save
                    document.getElementById('systole').value = '';
                    document.getElementById('diastole').value = '';
                    document.getElementById('glucose').value = '';
                    document.getElementById('weight').value = '';
                    // Keep date/time as current date/time after save for quick entry
                    const now = new Date();
                    document.getElementById('recordDate').value = now.toISOString().split('T')[0];
                    document.getElementById('recordTime').value = now.toTimeString().split(' ')[0].substring(0, 5); 
                })
                .catch(err => alert('Failed to save reading: ' + err.message));
        }
        
        function deleteReading(id) {
            if (!currentUser || !id) return;
            if (confirm('Are you sure you want to delete this reading?')) {
                const readingRef = ref(db, `users/${currentUser.uid}/healthReadings/${id}`);
                remove(readingRef).catch(err => console.error('Delete failed:', err));
            }
        }

        function loadReadings() {
            const listEl = document.getElementById('readingList');
            const personNameEl = document.getElementById('currentPersonName');
            listEl.innerHTML = '';
            
            // 1. AVERAGE BIFURCATION IS ALREADY HANDLED HERE: 
            // The personReadings array only contains data for the currently selected person.
            if (!currentPerson) {
                personNameEl.textContent = '...';
                listEl.innerHTML = '<p style="text-align:center; color:#777;">Please select or add a person to view readings and averages.</p>';
                // Clear summaries if no person selected
                document.getElementById('bpSummary').innerHTML = '<h3>ü©∫ Blood Pressure</h3>';
                document.getElementById('glucoseSummary').innerHTML = '<h3>ü©∏ Glucose</h3>';
                document.getElementById('weightSummary').innerHTML = '<h3>‚öñÔ∏è Weight</h3>';
                return;
            }

            personNameEl.textContent = currentPerson;

            const personReadings = allReadings.filter(r => r.person === currentPerson);
            
            if (personReadings.length === 0) {
                 listEl.innerHTML = `<p style="text-align:center; color:#777;">No readings found for ${currentPerson}. Add one above!</p>`;
                 // Clear summary if no data
                 document.getElementById('bpSummary').innerHTML = '<h3>ü©∫ Blood Pressure</h3>';
                 document.getElementById('glucoseSummary').innerHTML = '<h3>ü©∏ Glucose</h3>';
                 document.getElementById('weightSummary').innerHTML = '<h3>‚öñÔ∏è Weight</h3>';
                 return;
            }

            personReadings.forEach(r => {
                const bp = r.systole && r.diastole ? `${r.systole}/${r.diastole} mmHg` : '';
                const glucose = r.glucose ? `Glucose: ${r.glucose} mg/dL` : '';
                const weight = r.weight ? `Weight: ${r.weight} kg/lbs` : '';

                const formattedDate = formatDate(r.date); // Use new format function
                const timeInfo = r.time ? ` @ ${r.time}` : ''; // Include time

                const card = document.createElement('div');
                card.className = 'reading-card';
                card.innerHTML = `
                    <div class="reading-card-content">
                        <strong>${formattedDate}${timeInfo}</strong>
                        <span>${[bp, glucose, weight].filter(Boolean).join(' | ')}</span>
                    </div>
                    <div class="reading-card-actions">
                        <button class="del" onclick="deleteReading('${r.id}')">Delete</button>
                    </div>
                `;
                listEl.appendChild(card);
            });
            
            calculateAverages(personReadings);
        }
        
        // --- CALCULATION LOGIC (Unchanged, operates on filtered data) ---
        function calculateAverages(readings) {
            const metrics = ['systole', 'diastole', 'glucose', 'weight'];
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const oneWeekAgo = new Date(today); 
            oneWeekAgo.setDate(today.getDate() - 7);
            
            const oneMonthAgo = new Date(today); 
            oneMonthAgo.setMonth(today.getMonth() - 1);
            
            const todayDateString = new Date().toISOString().split('T')[0];

            const filtered = {
                day: readings.filter(r => r.date === todayDateString),
                week: readings.filter(r => new Date(r.date) >= oneWeekAgo),
                month: readings.filter(r => new Date(r.date) >= oneMonthAgo),
                all: readings
            };
            
            const results = {};

            metrics.forEach(metric => {
                results[metric] = {
                    day: calculate(filtered.day, metric),
                    week: calculate(filtered.week, metric),
                    month: calculate(filtered.month, metric),
                    all: calculate(filtered.all, metric)
                };
            });
            
            displayAverages(results);
        }

        function calculate(data, metric) {
            const validData = data.filter(r => r[metric] !== null && r[metric] !== undefined);
            if (validData.length === 0) return { avg: null, count: 0 };
            
            const sum = validData.reduce((acc, r) => acc + r[metric], 0);
            return { avg: sum / validData.length, count: validData.length };
        }
        
        // --- DISPLAY LOGIC (Unchanged) ---
        function displayAverages(results) {
            
            const formatBP = (sys, dia) => {
                if (sys.avg === null || dia.avg === null) return 'No Data';
                return `${sys.avg.toFixed(0)} / ${dia.avg.toFixed(0)} mmHg <span style="font-size:0.9em; color:#555;">(${sys.count} readings)</span>`;
            };
            
            document.getElementById('bpSummary').innerHTML = `
                <h3>ü©∫ Blood Pressure</h3>
                <p><strong>Today's Average:</strong> ${formatBP(results.systole.day, results.diastole.day)}</p>
                <p><strong>Last 7 Days Average:</strong> ${formatBP(results.systole.week, results.diastole.week)}</p>
                <p><strong>Last 30 Days Average:</strong> ${formatBP(results.systole.month, results.diastole.month)}</p>
                <p><strong>All Time Average:</strong> ${formatBP(results.systole.all, results.diastole.all)}</p>
            `;
            
            const formatMetric = (data, unit) => {
                if (data.avg === null) return 'No Data';
                return `${data.avg.toFixed(1)} ${unit} <span style="font-size:0.9em; color:#555;">(${data.count} readings)</span>`;
            };

            document.getElementById('glucoseSummary').innerHTML = `
                <h3>ü©∏ Glucose</h3>
                <p><strong>Today's Average:</strong> ${formatMetric(results.glucose.day, 'mg/dL')}</p>
                <p><strong>Last 7 Days Average:</strong> ${formatMetric(results.glucose.week, 'mg/dL')}</p>
                <p><strong>Last 30 Days Average:</strong> ${formatMetric(results.glucose.month, 'mg/dL')}</p>
                <p><strong>All Time Average:</strong> ${formatMetric(results.glucose.all, 'mg/dL')}</p>
            `;
            
            document.getElementById('weightSummary').innerHTML = `
                <h3>‚öñÔ∏è Weight</h3>
                <p><strong>Today's Average:</strong> ${formatMetric(results.weight.day, 'kg/lbs')}</p>
                <p><strong>Last 7 Days Average:</strong> ${formatMetric(results.weight.week, 'kg/lbs')}</p>
                <p><strong>Last 30 Days Average:</strong> ${formatMetric(results.weight.month, 'kg/lbs')}</p>
                <p><strong>All Time Average:</strong> ${formatMetric(results.weight.all, 'kg/lbs')}</p>
            `;
        }

    </script>
</body>
</html>
