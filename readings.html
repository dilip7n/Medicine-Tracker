// Function to show the main app, checking for MFA enrollment first
function showApp() {
    if (!currentUser) {
        // Should not happen if called correctly, but good for safety
        document.getElementById('authContainer').style.display = 'block';
        document.getElementById('appContainer').style.display = 'none';
        return;
    }
    
    const isMfaEnrolled = currentUser.multiFactor.enrolledFactors.length > 0;

    // Assuming your Firebase project has 'Multi-Factor enforcement' enabled
    // and you want *all* users to enroll in phone number MFA.
    if (!isMfaEnrolled) {
        // User is logged in but has not enrolled a factor. Force enrollment screen.
        document.getElementById('authContainer').style.display = 'none';
        document.getElementById('appContainer').style.display = 'none';
        document.getElementById('mfaContainer').style.display = 'none';
        document.getElementById('enrollMfaContainer').style.display = 'block'; // SHOW ENROLLMENT
        
        // Reset the MFA code input field
        document.getElementById('mfaSmsCode').value = ''; 

        // Reset the button back to its default login function for safety
        document.querySelector('#mfaContainer button').onclick = () => resolveMfaLogin(document.getElementById('mfaSmsCode').value);

        console.log("User logged in but needs MFA enrollment.");
        return;
    }

    // All checks passed: user is logged in and is MFA enrolled. Show the main application.
    console.log('User logged in, MFA enrolled. Showing app.');
    document.getElementById('userEmail').textContent = currentUser.email;
    document.getElementById('authContainer').style.display = 'none';
    document.getElementById('enrollMfaContainer').style.display = 'none';
    document.getElementById('mfaContainer').style.display = 'none';
    document.getElementById('appContainer').style.display = 'block';
    
    // Continue with loading app data
    loadReadings(currentUser.uid); 
}
